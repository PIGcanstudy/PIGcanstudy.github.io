<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>ç½‘ç»œç¼–ç¨‹æ•™ç¨‹ | PigCanStudy</title><meta name="keywords" content="Linux,ç½‘ç»œç¼–ç¨‹"><meta name="author" content="PigCanStudy"><meta name="copyright" content="PigCanStudy"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="ğŸ¥§æœ¬æ–‡ä»‹ç»äº†linuxåŸºç¡€çš„ç³»ç»Ÿç¼–ç¨‹å’ŒåŸºç¡€çš„Linuxç½‘ç»œç¼–ç¨‹">
<meta property="og:type" content="article">
<meta property="og:title" content="ç½‘ç»œç¼–ç¨‹æ•™ç¨‹">
<meta property="og:url" content="https://pigcanstudy.github.io/posts/95787e92.html">
<meta property="og:site_name" content="PigCanStudy">
<meta property="og:description" content="ğŸ¥§æœ¬æ–‡ä»‹ç»äº†linuxåŸºç¡€çš„ç³»ç»Ÿç¼–ç¨‹å’ŒåŸºç¡€çš„Linuxç½‘ç»œç¼–ç¨‹">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://source.fomal.cc/img/default_cover_14.webp">
<meta property="article:published_time" content="2024-07-16T15:48:00.000Z">
<meta property="article:modified_time" content="2024-07-16T15:49:00.000Z">
<meta property="article:author" content="PigCanStudy">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="ç½‘ç»œç¼–ç¨‹">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://source.fomal.cc/img/default_cover_14.webp"><link rel="shortcut icon" href="/"><link rel="canonical" href="https://pigcanstudy.github.io/posts/95787e92"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ç½‘ç»œç¼–ç¨‹æ•™ç¨‹',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-16 23:49:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><span id="fps"></span><style id="defineBg"></style><style id="menu_shadow"></style><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="PigCanStudy" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://tuchuang.voooe.cn/images/2023/01/02/avatar.webp" onerror="onerror=null;src='/assets/r1.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">6</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">2</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> å…«å®ç®±</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> ç”»å»Š</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> åŠ¨ç”»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘å€å¯¼èˆª</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æ—§æ—¶å…‰</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-maoliang"></use></svg><span class="menu_word" style="font-size:17px"> ä¸ªäºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/bb/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-qunliaotian">                   </use></svg><span class="menu_word" style="font-size:17px"> å” å¨</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/love/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-love-sign">                   </use></svg><span class="menu_word" style="font-size:17px"> æ‹çˆ±å°å±‹</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane">                   </use></svg><span class="menu_word" style="font-size:17px"> å…³äº</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">PigCanStudy</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> å…«å®ç®±</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> ç”»å»Š</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> åŠ¨ç”»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘å€å¯¼èˆª</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æ—§æ—¶å…‰</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-maoliang"></use></svg><span class="menu_word" style="font-size:17px"> ä¸ªäºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/bb/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-qunliaotian">                   </use></svg><span class="menu_word" style="font-size:17px"> å” å¨</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/love/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-love-sign">                   </use></svg><span class="menu_word" style="font-size:17px"> æ‹çˆ±å°å±‹</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane">                   </use></svg><span class="menu_word" style="font-size:17px"> å…³äº</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="æ£€ç´¢ç«™å†…ä»»ä½•ä½ æƒ³è¦çš„ä¿¡æ¯"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-valentine_-search-love-find-heart"></use></svg><span> æœç´¢</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="ç¾åŒ–è®¾ç½®-è‡ªå®šä¹‰ä½ çš„é£æ ¼" id="meihua-button"><svg class="faa-tada icon" style="height:26px;width:26px;fill:currentColor;position:relative;top:8px" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon">       </use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">ç½‘ç»œç¼–ç¨‹æ•™ç¨‹</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-meta-icon" style="width:30px;height:30px;position:relative;top:10px"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">å‘è¡¨äº </span><time class="post-meta-date-created" datetime="2024-07-16T15:48:00.000Z" title="å‘è¡¨äº 2024-07-16 23:48:00">2024-07-16</time><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-gengxin1"></use></svg><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2024-07-16T15:49:00.000Z" title="æ›´æ–°äº 2024-07-16 23:49:00">2024-07-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-biaoqian"></use></svg><a class="post-meta-categories" href="/categories/C/">C++</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:8px"><use xlink:href="#icon-charuword"></use></svg><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">2.2w</span><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:20px;height:20px;position:relative;top:5px"><use xlink:href="#icon-shizhong"></use></svg><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>90åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ç½‘ç»œç¼–ç¨‹æ•™ç¨‹"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:5px"><use xlink:href="#icon-eye"></use></svg><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>ç›®å½•</h1>
<ul>
<li><a href="#%E7%9B%AE%E5%BD%95">ç›®å½•</a>
<ul>
<li><a href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86">ç¬¬ä¸€éƒ¨åˆ†</a>
<ul>
<li><a href="#%E9%9D%99%E6%80%81%E5%BA%93%E4%B8%8E%E5%8A%A8%E6%80%81%E5%BA%93%E7%9A%84%E5%BB%BA%E7%AB%8B">é™æ€åº“ä¸åŠ¨æ€åº“çš„å»ºç«‹</a>
<ul>
<li><a href="#%E9%9D%99%E6%80%81%E5%BA%93%E7%9A%84%E5%BB%BA%E7%AB%8B%E5%92%8C%E4%BD%BF%E7%94%A8">é™æ€åº“çš„å»ºç«‹å’Œä½¿ç”¨</a></li>
<li><a href="#%E5%8A%A8%E6%80%81%E5%BA%93%E7%9A%84%E5%BB%BA%E7%AB%8B%E5%92%8C%E4%BD%BF%E7%94%A8">åŠ¨æ€åº“çš„å»ºç«‹å’Œä½¿ç”¨</a></li>
</ul>
</li>
<li><a href="#makefile">makefile</a>
<ul>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%BC%95%E5%85%A5make%E8%BF%99%E4%B8%AA%E5%B7%A5%E5%85%B7">ä¸ºä»€ä¹ˆè¦å¼•å…¥makeè¿™ä¸ªå·¥å…·</a></li>
<li><a href="#makefile%E7%9A%84%E4%BD%BF%E7%94%A8%E4%B8%8E%E7%BB%86%E8%8A%82">makefileçš„ä½¿ç”¨ä¸ç»†èŠ‚</a></li>
</ul>
</li>
<li><a href="#main%E5%87%BD%E6%95%B0%E7%9A%84%E5%8F%82%E6%95%B0">mainå‡½æ•°çš„å‚æ•°</a>
<ul>
<li><a href="#argc">argc</a></li>
<li><a href="#argv">argv</a></li>
<li><a href="#envp">envp</a></li>
</ul>
</li>
<li><a href="#gdb%E8%B0%83%E8%AF%95%E7%A8%8B%E5%BA%8F">gdbè°ƒè¯•ç¨‹åº</a>
<ul>
<li><a href="#gdb%E7%9A%84%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4">gdbçš„å¸¸ç”¨å‘½ä»¤</a></li>
<li><a href="#%E7%94%A8gdb%E8%B0%83%E8%AF%95core%E6%96%87%E4%BB%B6">ç”¨gdbè°ƒè¯•coreæ–‡ä»¶</a></li>
<li><a href="#%E7%94%A8gdb%E8%B0%83%E8%AF%95%E4%B8%80%E4%B8%AA%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E7%A8%8B%E5%BA%8F">ç”¨gdbè°ƒè¯•ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ç¨‹åº</a></li>
</ul>
</li>
<li><a href="#linux%E7%9A%84%E6%97%B6%E9%97%B4%E6%93%8D%E4%BD%9C">linuxçš„æ—¶é—´æ“ä½œ</a>
<ul>
<li><a href="#time_t-%E5%88%AB%E5%90%8D">time_t åˆ«å</a></li>
<li><a href="#time%E5%BA%93%E5%87%BD%E6%95%B0">time()åº“å‡½æ•°</a></li>
<li><a href="#tm%E7%BB%93%E6%9E%84%E4%BD%93timeval">tmç»“æ„ä½“(timeval)</a></li>
<li><a href="#localtime%E5%BA%93%E5%87%BD%E6%95%B0">localtime()åº“å‡½æ•°</a></li>
<li><a href="#mktime%E5%87%BD%E6%95%B0">mktime()å‡½æ•°</a></li>
<li><a href="#gettimeofday%E5%87%BD%E6%95%B0">gettimeofday()å‡½æ•°</a></li>
<li><a href="#%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%9D%A1%E7%9C%A0">ç¨‹åºçš„ç¡çœ </a></li>
</ul>
</li>
<li><a href="#linux-%E8%8E%B7%E5%8F%96%E7%9B%AE%E5%BD%95%E6%93%8D%E4%BD%9C">linux è·å–ç›®å½•æ“ä½œ</a>
<ul>
<li><a href="#%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E7%9B%AE%E5%BD%95%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0">å‡ ä¸ªç®€å•çš„ç›®å½•æ“ä½œå‡½æ•°</a>
<ul>
<li><a href="#%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95">è·å–å½“å‰å·¥ä½œç›®å½•</a></li>
<li><a href="#%E5%88%87%E6%8D%A2%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95">åˆ‡æ¢å·¥ä½œç›®å½•</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95">åˆ›å»ºç›®å½•</a></li>
<li><a href="#%E5%88%A0%E9%99%A4%E7%9B%AE%E5%BD%95">åˆ é™¤ç›®å½•</a></li>
</ul>
</li>
<li><a href="#%E8%8E%B7%E5%8F%96%E7%9B%AE%E5%BD%95%E4%B8%AD%E6%96%87%E4%BB%B6%E7%9A%84%E5%88%97%E8%A1%A8">è·å–ç›®å½•ä¸­æ–‡ä»¶çš„åˆ—è¡¨</a>
<ul>
<li><a href="#%E5%8C%85%E5%90%AB%E5%A4%B4%E6%96%87%E4%BB%B6">åŒ…å«å¤´æ–‡ä»¶</a></li>
<li><a href="#%E7%9B%B8%E5%85%B3%E7%9A%84%E5%BA%93%E5%87%BD%E6%95%B0">ç›¸å…³çš„åº“å‡½æ•°</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#linux-%E7%9A%84%E7%B3%BB%E7%BB%9F%E9%94%99%E8%AF%AF">linux çš„ç³»ç»Ÿé”™è¯¯</a>
<ul>
<li><a href="#sterror%E5%BA%93%E5%87%BD%E6%95%B0">sterror()åº“å‡½æ•°</a></li>
<li><a href="#perror%E5%BA%93%E5%87%BD%E6%95%B0">perror()åº“å‡½æ•°</a></li>
<li><a href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">æ³¨æ„äº‹é¡¹</a></li>
</ul>
</li>
<li><a href="#%E7%9B%AE%E5%BD%95%E5%92%8C%E6%96%87%E4%BB%B6%E7%9A%84%E6%9B%B4%E5%A4%9A%E6%93%8D%E4%BD%9C">ç›®å½•å’Œæ–‡ä»¶çš„æ›´å¤šæ“ä½œ</a>
<ul>
<li><a href="#access%E5%BA%93%E5%87%BD%E6%95%B0">access()åº“å‡½æ•°</a></li>
<li><a href="#stat%E7%BB%93%E6%9E%84%E4%BD%93">statç»“æ„ä½“</a></li>
<li><a href="#stat%E5%BA%93%E5%87%BD%E6%95%B0">stat()åº“å‡½æ•°</a></li>
<li><a href="#utime%E5%BA%93%E5%87%BD%E6%95%B0">utime()åº“å‡½æ•°</a></li>
<li><a href="#rename%E5%BA%93%E5%87%BD%E6%95%B0">rename()åº“å‡½æ•°</a></li>
<li><a href="#remove%E5%BA%93%E5%87%BD%E6%95%B0">remove()åº“å‡½æ•°</a></li>
</ul>
</li>
<li><a href="#linux%E7%9A%84%E4%BF%A1%E5%8F%B7">Linuxçš„ä¿¡å·</a>
<ul>
<li><a href="#%E4%BF%A1%E5%8F%B7%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5">ä¿¡å·çš„åŸºæœ¬æ¦‚å¿µ</a>
<ul>
<li><a href="#kill-%E4%B8%8E-killall-%E7%9A%84%E5%8C%BA%E5%88%AB">kill ä¸ killall çš„åŒºåˆ«</a></li>
</ul>
</li>
<li><a href="#%E4%BF%A1%E5%8F%B7%E7%9A%84%E7%B1%BB%E5%9E%8B">ä¿¡å·çš„ç±»å‹</a></li>
<li><a href="#%E4%BF%A1%E5%8F%B7%E7%9A%84%E5%A4%84%E7%90%86">ä¿¡å·çš„å¤„ç†</a></li>
<li><a href="#%E4%BF%A1%E5%8F%B7%E6%9C%89%E4%BB%80%E4%B9%88%E7%94%A8">ä¿¡å·æœ‰ä»€ä¹ˆç”¨</a></li>
<li><a href="#%E5%8F%91%E9%80%81%E4%BF%A1%E5%8F%B7">å‘é€ä¿¡å·</a></li>
</ul>
</li>
<li><a href="#%E8%BF%9B%E7%A8%8B%E7%BB%88%E6%AD%A2">è¿›ç¨‹ç»ˆæ­¢</a>
<ul>
<li><a href="#%E8%BF%9B%E7%A8%8B%E7%BB%88%E6%AD%A2%E6%96%B9%E5%BC%8F">è¿›ç¨‹ç»ˆæ­¢æ–¹å¼</a></li>
<li><a href="#%E8%BF%9B%E7%A8%8B%E7%BB%88%E6%AD%A2%E7%8A%B6%E6%80%81">è¿›ç¨‹ç»ˆæ­¢çŠ¶æ€</a></li>
<li><a href="#%E8%B5%84%E6%BA%90%E9%87%8A%E6%94%BE%E7%9A%84%E9%97%AE%E9%A2%98">èµ„æºé‡Šæ”¾çš„é—®é¢˜</a></li>
<li><a href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E7%BB%88%E6%AD%A2%E5%87%BD%E6%95%B0">è¿›ç¨‹çš„ç»ˆæ­¢å‡½æ•°</a></li>
</ul>
</li>
<li><a href="#%E8%B0%83%E7%94%A8%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F">è°ƒç”¨å¯æ‰§è¡Œç¨‹åº</a>
<ul>
<li><a href="#system%E5%BA%93%E5%87%BD%E6%95%B0">system()åº“å‡½æ•°</a>
<ul>
<li><a href="#%E5%8A%9F%E8%83%BD">åŠŸèƒ½</a></li>
<li><a href="#%E8%BF%94%E5%9B%9E%E5%80%BC">è¿”å›å€¼</a></li>
</ul>
</li>
<li><a href="#exec%E5%87%BD%E6%95%B0%E6%97%8F">execå‡½æ•°æ—</a>
<ul>
<li><a href="#execl%E5%87%BD%E6%95%B0">execl()å‡½æ•°</a></li>
<li><a href="#execv%E5%87%BD%E6%95%B0">execv()å‡½æ•°</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%88%9B%E5%BB%BA%E8%BF%9B%E7%A8%8B">åˆ›å»ºè¿›ç¨‹</a>
<ul>
<li><a href="#linux%E7%9A%84012%E5%8F%B7%E8%BF%9B%E7%A8%8B">Linuxçš„0ï¼Œ1ï¼Œ2å·è¿›ç¨‹</a></li>
<li><a href="#%E8%BF%9B%E7%A8%8B%E6%A0%87%E8%AF%86">è¿›ç¨‹æ ‡è¯†</a></li>
<li><a href="#fork%E5%87%BD%E6%95%B0">fork()å‡½æ•°</a></li>
<li><a href="#fork%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%94%A8%E6%B3%95">fork()çš„ä¸¤ç§ç”¨æ³•</a></li>
<li><a href="#%E5%85%B1%E4%BA%AB%E6%96%87%E4%BB%B6">å…±äº«æ–‡ä»¶</a></li>
<li><a href="#vfork">vfork()</a></li>
</ul>
</li>
<li><a href="#%E5%83%B5%E5%B0%B8%E8%BF%9B%E7%A8%8B">åƒµå°¸è¿›ç¨‹</a>
<ul>
<li><a href="#%E5%83%B5%E5%B0%B8%E8%BF%9B%E7%A8%8B%E7%9A%84%E4%BA%A7%E7%94%9F">åƒµå°¸è¿›ç¨‹çš„äº§ç”Ÿ</a></li>
<li><a href="#%E5%83%B5%E5%B0%B8%E8%BF%9B%E7%A8%8B%E5%9C%B0%E9%81%BF%E5%85%8D">åƒµå°¸è¿›ç¨‹åœ°é¿å…</a></li>
</ul>
</li>
<li><a href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E4%B8%8E%E4%BF%A1%E5%8F%B7">å¤šè¿›ç¨‹ä¸ä¿¡å·</a></li>
<li><a href="#%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98">å…±äº«å†…å­˜</a>
<ul>
<li><a href="#shmget%E5%87%BD%E6%95%B0">shmget()å‡½æ•°</a></li>
<li><a href="#shmat%E5%87%BD%E6%95%B0">shmat()å‡½æ•°</a></li>
<li><a href="#shmdt%E5%87%BD%E6%95%B0">shmdt()å‡½æ•°</a></li>
<li><a href="#shmctl%E5%87%BD%E6%95%B0">shmctl()å‡½æ•°</a></li>
</ul>
</li>
<li><a href="#%E5%BE%AA%E7%8E%AF%E9%98%9F%E5%88%97">å¾ªç¯é˜Ÿåˆ—</a>
<ul>
<li><a href="#%E5%8E%9F%E7%90%86">åŸç†</a></li>
</ul>
</li>
<li><a href="#%E4%BF%A1%E5%8F%B7%E9%87%8F">ä¿¡å·é‡</a></li>
<li><a href="#pthread-%E7%BA%BF%E7%A8%8B%E5%BA%93">pthread çº¿ç¨‹åº“</a></li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86">ç¬¬äºŒéƒ¨åˆ†</a>
<ul>
<li><a href="#%E7%AC%AC%E4%B8%80%E4%B8%AA%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E7%A8%8B%E5%BA%8F%E6%88%B7%E7%AB%AF">ç¬¬ä¸€ä¸ªç½‘ç»œé€šä¿¡ç¨‹åºæˆ·ç«¯</a></li>
<li><a href="#%E5%9F%BA%E4%BA%8Elinux%E7%9A%84%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C">åŸºäºlinuxçš„æ–‡ä»¶æ“ä½œ</a>
<ul>
<li><a href="#%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E7%9A%84%E5%88%86%E9%85%8D%E8%A7%84%E5%88%99">æ–‡ä»¶æè¿°ç¬¦çš„åˆ†é…è§„åˆ™</a></li>
</ul>
</li>
<li><a href="#socket%E5%87%BD%E6%95%B0%E8%AF%A6%E8%A7%A3">socketå‡½æ•°è¯¦è§£</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BAsocket">åˆ›å»ºsocket</a>
<ul>
<li><a href="#%E5%87%BD%E6%95%B0%E7%9A%84%E5%A3%B0%E6%98%8E">å‡½æ•°çš„å£°æ˜</a></li>
<li><a href="#type-%E8%A1%A8%E7%A4%BA%E6%95%B0%E6%8D%AE%E7%9A%84%E4%BC%A0%E8%BE%93%E7%B1%BB%E5%9E%8B">type è¡¨ç¤ºæ•°æ®çš„ä¼ è¾“ç±»å‹</a></li>
<li><a href="#protocol%E5%8D%8F%E8%AE%AE">protocolåè®®</a></li>
<li><a href="#%E4%B8%A4%E7%A7%8D%E5%88%9B%E5%BB%BA%E6%96%B9%E5%BC%8F">ä¸¤ç§åˆ›å»ºæ–¹å¼</a></li>
</ul>
</li>
<li><a href="#%E4%B8%BB%E6%9C%BA%E5%AD%97%E8%8A%82%E5%BA%8F%E5%92%8C%E7%BD%91%E7%BB%9C%E5%AD%97%E8%8A%82%E5%BA%8F">ä¸»æœºå­—èŠ‚åºå’Œç½‘ç»œå­—èŠ‚åº</a>
<ul>
<li><a href="#%E5%A4%A7%E7%AB%AF%E5%BA%8F%E5%92%8C%E5%B0%8F%E7%AB%AF%E5%BA%8F">å¤§ç«¯åºå’Œå°ç«¯åº</a></li>
<li><a href="#%E7%BD%91%E7%BB%9C%E5%AD%97%E8%8A%82%E5%BA%8F">ç½‘ç»œå­—èŠ‚åº</a></li>
<li><a href="#ip%E5%9C%B0%E5%9D%80%E5%92%8C%E9%80%9A%E8%AE%AF%E7%AB%AF%E5%8F%A3">IPåœ°å€å’Œé€šè®¯ç«¯å£</a></li>
<li><a href="#%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E5%A4%A7%E5%B0%8F%E7%AB%AF%E5%BA%8F">å¦‚ä½•å¤„ç†å¤§å°ç«¯åº</a></li>
</ul>
</li>
<li><a href="#%E4%B8%87%E6%81%B6%E7%9A%84%E7%BB%93%E6%9E%84%E4%BD%93">ä¸‡æ¶çš„ç»“æ„ä½“</a>
<ul>
<li><a href="#sockaddr%E7%BB%93%E6%9E%84%E4%BD%93">sockaddrç»“æ„ä½“</a></li>
<li><a href="#sockaddr_in%E7%BB%93%E6%9E%84%E4%BD%93">sockaddr_inç»“æ„ä½“</a>
<ul>
<li><a href="#%E7%BB%86%E8%AF%B4%E6%AD%A4%E7%BB%93%E6%9E%84%E4%BD%93%E5%86%85%E9%83%A8%E7%9A%84%E7%BB%86%E8%8A%82">ç»†è¯´æ­¤ç»“æ„ä½“å†…éƒ¨çš„ç»†èŠ‚</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8gethostbyname%E5%87%BD%E6%95%B0">ä½¿ç”¨gethostbyname()å‡½æ•°</a></li>
<li><a href="#%E5%AD%97%E7%AC%A6%E4%B8%B2ip%E4%B8%8E%E5%A4%A7%E7%AB%AF%E5%BA%8Fip%E7%9A%84%E8%BD%AC%E6%8D%A2">å­—ç¬¦ä¸²IPä¸å¤§ç«¯åºIPçš„è½¬æ¢</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E6%9C%AA%E5%B0%81%E8%A3%85%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%A3%E7%A0%81">æœªå°è£…çš„å®¢æˆ·ç«¯ä»£ç </a></li>
<li><a href="#%E6%9C%AA%E5%B0%81%E8%A3%85%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BB%A3%E7%A0%81">æœªå°è£…çš„æœåŠ¡ç«¯ä»£ç </a></li>
<li><a href="#%E5%B0%81%E8%A3%85%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%A3%E7%A0%81">å°è£…çš„å®¢æˆ·ç«¯ä»£ç </a></li>
<li><a href="#%E5%B0%81%E8%A3%85socket%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF">å°è£…socketçš„æœåŠ¡ç«¯</a></li>
<li><a href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BB%A3%E7%A0%81">å¤šè¿›ç¨‹çš„æœåŠ¡ç«¯ä»£ç </a>
<ul>
<li><a href="#void--%E6%98%AF%E4%BB%80%E4%B9%88">void * æ˜¯ä»€ä¹ˆï¼Ÿ</a></li>
</ul>
</li>
<li><a href="#%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93">æ–‡ä»¶ä¼ è¾“</a>
<ul>
<li><a href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BB%A3%E7%A0%81">æœåŠ¡ç«¯ä»£ç </a></li>
<li><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%A3%E7%A0%81">å®¢æˆ·ç«¯ä»£ç </a></li>
</ul>
</li>
<li><a href="#%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B">ä¸‰æ¬¡æ¡æ‰‹ï¼Œå››æ¬¡æŒ¥æ‰‹</a>
<ul>
<li><a href="#%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B">ä¸‰æ¬¡æ¡æ‰‹</a>
<ul>
<li><a href="#%E7%BB%86%E8%8A%82">ç»†èŠ‚</a></li>
</ul>
</li>
<li><a href="#%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B">å››æ¬¡æŒ¥æ‰‹</a>
<ul>
<li><a href="#%E7%BB%86%E8%8A%82-1">ç»†èŠ‚</a></li>
<li><a href="#%E8%A7%A3%E5%86%B3%E4%B8%8A%E8%BF%B0%E9%97%AE%E9%A2%98%E5%8A%9E%E6%B3%95">è§£å†³ä¸Šè¿°é—®é¢˜åŠæ³•</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#tcp%E7%BC%93%E5%AD%98">TCPç¼“å­˜</a>
<ul>
<li><a href="#%E6%9F%A5%E7%9C%8B%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E5%A4%A7%E5%B0%8F">æŸ¥çœ‹ç¼“å†²åŒºçš„å¤§å°</a></li>
<li><a href="#nagle-%E7%AE%97%E6%B3%95">Nagle ç®—æ³•</a></li>
</ul>
</li>
<li><a href="#io%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8--select%E6%A8%A1%E5%9E%8B">IOå¤šè·¯å¤ç”¨ -selectæ¨¡å‹</a>
<ul>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AFio%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8">ä»€ä¹ˆæ˜¯IOå¤šè·¯å¤ç”¨</a></li>
<li><a href="#%E7%BD%91%E7%BB%9C%E9%80%9A%E8%AE%AF-%E8%AF%BB%E4%BA%8B%E4%BB%B6">ç½‘ç»œé€šè®¯-è¯»äº‹ä»¶</a></li>
<li><a href="#%E7%BD%91%E7%BB%9C%E9%80%9A%E8%AE%AF-%E5%86%99%E4%BA%8B%E4%BB%B6">ç½‘ç»œé€šè®¯-å†™äº‹ä»¶</a></li>
<li><a href="#select-%E7%9A%84%E5%8E%9F%E7%90%86">select çš„åŸç†</a></li>
<li><a href="#select-%E5%87%BD%E6%95%B0%E7%9A%84%E4%BD%BF%E7%94%A8">select å‡½æ•°çš„ä½¿ç”¨</a>
<ul>
<li><a href="#select%E5%87%BD%E6%95%B0%E7%9A%84%E5%A3%B0%E6%98%8E">selectå‡½æ•°çš„å£°æ˜</a>
<ul>
<li><a href="#fd_set%E7%9A%84%E6%9C%AC%E8%B4%A8%E5%A6%82%E5%9B%BE%E6%89%80%E7%A4%BA">fd_setçš„æœ¬è´¨å¦‚å›¾æ‰€ç¤º</a></li>
<li><a href="#selec%E6%9C%8D%E5%8A%A1%E5%90%A8%E7%AB%AF%E4%BB%A3%E7%A0%81">selecæœåŠ¡å¨ç«¯ä»£ç </a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#select%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%BB%86%E8%8A%82">selectæ¨¡å‹çš„ç»†èŠ‚</a>
<ul>
<li><a href="#select%E6%A8%A1%E5%9E%8B-%E5%86%99%E4%BA%8B%E4%BB%B6">selectæ¨¡å‹-å†™äº‹ä»¶</a></li>
<li><a href="#select-%E6%A8%A1%E5%9E%8B-%E6%B0%B4%E5%B9%B3%E8%A7%A6%E5%8F%91">select æ¨¡å‹ æ°´å¹³è§¦å‘</a></li>
<li><a href="#select-%E6%A8%A1%E5%9E%8B%E6%80%A7%E8%83%BD">select æ¨¡å‹æ€§èƒ½</a></li>
<li><a href="#%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98">å­˜åœ¨çš„é—®é¢˜</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#poll%E6%A8%A1%E5%9E%8B">POLLæ¨¡å‹</a>
<ul>
<li><a href="#pollfd-%E7%BB%93%E6%9E%84%E4%BD%93">pollfd ç»“æ„ä½“</a></li>
<li><a href="#poll%E5%8F%AF%E8%A6%81%E6%B1%82socket%E6%95%B0">pollå¯è¦æ±‚socketæ•°</a></li>
<li><a href="#pollfd%E7%BB%93%E6%9E%84%E4%BD%93%E6%95%B0%E7%BB%84%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E7%BB%86%E8%8A%82">pollfdç»“æ„ä½“æ•°ç»„åˆå§‹åŒ–çš„ç»†èŠ‚</a></li>
<li><a href="#poll%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%B8%B8%E7%94%A8">pollçš„äº‹ä»¶å¸¸ç”¨</a>
<ul>
<li><a href="#%E8%AF%BB%E4%BA%8B%E4%BB%B6pollin-%E5%86%99%E4%BA%8B%E4%BB%B6pollout">è¯»äº‹ä»¶ï¼šPOLLINï¼Œ å†™äº‹ä»¶ï¼šPOLLOUT</a></li>
</ul>
</li>
<li><a href="#pollfd%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95%E6%9C%89%E4%B8%A4%E7%A7%8D">pollfdç»“æ„ä½“çš„ä½¿ç”¨æ–¹æ³•æœ‰ä¸¤ç§</a>
<ul>
<li><a href="#%E5%A1%AB%E5%9C%A8%E4%B8%8E%E8%AF%B7%E6%B1%82%E7%9A%84socket%E7%AC%A6%E5%8F%B7%E7%BC%96%E7%A0%81%E4%B8%80%E6%A0%B7%E7%9A%84%E4%BD%8D%E7%BD%AE">å¡«åœ¨ä¸è¯·æ±‚çš„socketç¬¦å·ç¼–ç ä¸€æ ·çš„ä½ç½®</a></li>
<li><a href="#%E5%A1%AB%E5%9C%A8%E7%BB%93%E6%9E%84%E4%BD%93%E6%95%B0%E7%BB%84%E6%9C%80%E5%89%8D%E9%9D%A2">å¡«åœ¨ç»“æ„ä½“æ•°ç»„æœ€å‰é¢</a></li>
<li><a href="#%E4%B8%A4%E8%80%85%E7%9A%84%E5%8C%BA%E5%88%AB">ä¸¤è€…çš„åŒºåˆ«</a></li>
</ul>
</li>
<li><a href="#poll%E6%A8%A1%E5%9E%8B%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98">pollæ¨¡å‹å­˜åœ¨çš„é—®é¢˜</a></li>
<li><a href="#poll%E7%9B%B8%E5%AF%B9%E4%BA%8Eselect%E7%9A%84%E5%8C%BA%E5%88%AB">pollç›¸å¯¹äºselectçš„åŒºåˆ«</a></li>
</ul>
</li>
<li><a href="#epoll%E6%A8%A1%E5%9E%8B">epollæ¨¡å‹</a>
<ul>
<li><a href="#epoll_create%E5%87%BD%E6%95%B0">epoll_create()å‡½æ•°</a></li>
<li><a href="#epoll_ctl%E5%87%BD%E6%95%B0">epoll_ctl()å‡½æ•°</a></li>
<li><a href="#epoll_wait%E5%87%BD%E6%95%B0">epoll_waitå‡½æ•°</a></li>
<li><a href="#epoll%E7%9A%84%E7%9B%B8%E5%85%B3%E7%BB%93%E6%9E%84%E4%BD%93">epollçš„ç›¸å…³ç»“æ„ä½“</a>
<ul>
<li><a href="#epoll_event">epoll_event</a></li>
<li><a href="#epoll%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BB%A3%E7%A0%81">epollæœåŠ¡ç«¯ä»£ç </a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E9%98%BB%E5%A1%9Eio-%E4%B8%8E-%E9%9D%9E%E9%98%BB%E5%A1%9Eio">é˜»å¡I/O ä¸ éé˜»å¡I/O</a>
<ul>
<li><a href="#%E9%98%BB%E5%A1%9E%E4%B8%8E%E9%9D%9E%E9%98%BB%E5%A1%9Eio%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">é˜»å¡ä¸éé˜»å¡IOçš„åº”ç”¨åœºæ™¯</a></li>
<li><a href="#%E9%9D%9E%E9%98%BB%E5%A1%9Eio-connect%E5%87%BD%E6%95%B0">éé˜»å¡IO-connect()å‡½æ•°</a></li>
<li><a href="#%E9%9D%9E%E9%98%BB%E5%A1%9Eio-accept%E5%87%BD%E6%95%B0">éé˜»å¡IO accept()å‡½æ•°</a></li>
<li><a href="#%E9%9D%9E%E9%98%BB%E5%A1%9Eio-recv">éé˜»å¡IO recv</a></li>
<li><a href="#%E9%9D%9E%E9%98%BB%E5%A1%9Eio-send">éé˜»å¡IO send()</a></li>
</ul>
</li>
<li><a href="#%E6%B0%B4%E5%B9%B3%E8%A7%A6%E5%8F%91%E4%B8%8E%E8%BE%B9%E7%BC%98%E8%A7%A6%E5%8F%91">æ°´å¹³è§¦å‘ä¸è¾¹ç¼˜è§¦å‘</a>
<ul>
<li><a href="#%E6%B0%B4%E5%B9%B3%E8%A7%A6%E5%8F%91%E5%90%AB%E4%B9%89">æ°´å¹³è§¦å‘å«ä¹‰</a></li>
<li><a href="#%E8%BE%B9%E7%BC%98%E8%A7%A6%E5%8F%91%E7%9A%84%E5%90%AB%E4%B9%89">è¾¹ç¼˜è§¦å‘çš„å«ä¹‰</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ç¬¬ä¸€éƒ¨åˆ†">ç¬¬ä¸€éƒ¨åˆ†</h2>
<h3 id="é™æ€åº“ä¸åŠ¨æ€åº“çš„å»ºç«‹">é™æ€åº“ä¸åŠ¨æ€åº“çš„å»ºç«‹</h3>
<h4 id="é™æ€åº“çš„å»ºç«‹å’Œä½¿ç”¨">é™æ€åº“çš„å»ºç«‹å’Œä½¿ç”¨</h4>
<ul>
<li>
<p><strong>å»ºç«‹</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -c -o libpublic.a <span class="keyword">public</span>.cpp</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å…¶ä¸­libpublic.aè¡¨ç¤ºé™æ€åº“ï¼Œpublic.cppè¡¨ç¤ºéœ€è¦å»ºç«‹é™æ€åº“çš„ä»£ç </p>
<ul>
<li>
<p><strong>ä½¿ç”¨</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -o demo01 demo<span class="number">01.</span>cpp -L/home/pigcanstudy/tools -lpublic</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å…¶ä¸­-Lè¡¨ç¤ºé™æ€åº“æ‰€åœ¨ç›®å½•ï¼Œ-lè¡¨ç¤ºé™æ€åº“çš„åº“å<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:100%;" /></p>
<h4 id="åŠ¨æ€åº“çš„å»ºç«‹å’Œä½¿ç”¨">åŠ¨æ€åº“çš„å»ºç«‹å’Œä½¿ç”¨</h4>
<ul>
<li>
<p><strong>å»ºç«‹</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">g++ -fPIC -shared -o libåº“å.so æºä»£ç æ–‡ä»¶</span><br><span class="line">g++ -fPIC -shared -o libpublic.so <span class="keyword">public</span>.cpp</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>ä½¿ç”¨</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">g++ é€‰é¡¹ æºä»£ç æ–‡ä»¶ -låº“å -Låº“æ–‡ä»¶æ‰€åœ¨ç›®å½•å</span><br><span class="line">g++ -o demo01 demo<span class="number">01.</span>cpp -L/home/pigcanstudy/tools -lpublic</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœä½¿ç”¨äº†åŠ¨æ€åº“éœ€è¦æå‰è®¾ç½®LD_LIBRARY_PATH</strong><br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-1.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /> ç”¨æ¥æŸ¥çœ‹è·¯çº¿æœ‰å•¥<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-2.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /> ç”¨æ¥è®¾ç½®è·¯å¾„ï¼Œåé¢åŠ çš„æ˜¯åŠ¨æ€åº“çš„åœ°å€</p>
<h3 id="makefile">makefile</h3>
<h4 id="ä¸ºä»€ä¹ˆè¦å¼•å…¥makeè¿™ä¸ªå·¥å…·">ä¸ºä»€ä¹ˆè¦å¼•å…¥makeè¿™ä¸ªå·¥å…·</h4>
<ul>
<li>é™æ€åº“ä¸åŠ¨æ€åº“åœ¨å»ºç«‹çš„æ—¶å€™å¾ˆéº»çƒ¦ï¼Œå¦‚æœæœ‰å¾ˆå¤šé¡¹ç›®æ–‡ä»¶é€‰å“Ÿå»ºç«‹åº“ï¼Œå°±å¯ä»¥ä½¿ç”¨makeå·¥å…·ï¼Œä½¿ç”¨.shè„šæœ¬å·¥å…·ä¹Ÿèƒ½å®ç°ï¼Œå³å»ºç«‹ä¸€ä¸ª.shçš„è„šæœ¬ï¼Œé‡Œé¢åŠ å…¥ä½ è¦å»ºç«‹åº“çš„è¯­å¥ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-3.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /><br>
å¯ä»¥ç”¨ shå‘½ä»¤æ¥æ‰§è¡Œ</li>
</ul>
<h4 id="makefileçš„ä½¿ç”¨ä¸ç»†èŠ‚">makefileçš„ä½¿ç”¨ä¸ç»†èŠ‚</h4>
<ul>
<li>
<p>ä½¿ç”¨makefileçš„æ—¶å€™éœ€è¦æ³¨æ„çš„äº‹é¡¹<br>
æ³¨æ„åœ¨æ‰€æœ‰g++ rm cp å‰é¢å¾—éœ€è¦TABé”®åˆ†å‰²ï¼Œç„¶åå†æ¢è¡Œä½¿ç”¨\çš„æ—¶å€™\åé¢ä¸è¦ä¹±åŠ ç©ºæ ¼<br>
å¦åˆ™ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-4.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /><br>
<em><strong>makefileçš„åŸºæœ¬è¯­æ³• å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</strong></em><br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-5.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /></p>
<ol>
<li>
<p>æ‰§è¡Œmake ä¼šç”Ÿæˆä¸¤ä¸ªåº“æ–‡ä»¶</p>
</li>
<li>
<p>æ‰§è¡Œmake clean ä¼šæ‰§è¡Œåˆ é™¤ä¸¤ä¸ªåº“æ–‡ä»¶<br>
æ‰§è¡Œmake æ—¶å‡ºç°å¦‚ä¸‹æ‰€ç¤ºï¼š<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-6.png" alt="è¡¨ç¤º"><br>
è¡¨ç¤ºä¸éœ€è¦é‡æ–°ç¼–è¯‘allä¸­çš„åº“æ–‡ä»¶</p>
</li>
<li>
<p>makeé‡‡ç”¨çš„æ˜¯<strong>å¢é‡ç¼–è¯‘</strong>ï¼ˆä¹Ÿå°±æ˜¯åªéœ€è¦é‡æ–°ç¼–è¯‘éœ€è¦é‡æ–°ç¼–è¯‘çš„æ–‡ä»¶ï¼ŒåŸæœ¬ç¼–è¯‘å¥½çš„æ–‡ä»¶æ— éœ€ç»§ç»­ç¼–è¯‘ï¼Œè¿™å°±æ˜¯å…¶ä¸è„šæœ¬æ¯”è¾ƒæ›´å¥½çš„åŸå› ï¼‰</p>
</li>
<li>
<p><em><strong>æ³¨æ„</strong></em> å½“ä½ æ”¹å˜äº†hppæˆ–è€…cppçš„æ—¶å€™ï¼Œä¸€å®šè¦é‡æ–°makeä»¥ä¸‹åº“æ–‡ä»¶ï¼Œå¦åˆ™ä¼šå¾ˆç—›è‹¦ï¼Œä¼šæŠ¥é”™ å› ä¸ºç”¨äº†ä¹‹å‰çš„ä¸ºæ”¹å˜çš„hppä¸cpp</p>
</li>
<li>
<p>ä»¥ä¸Šmakefileçš„åŸºæœ¬è¯­æ³•è¿™ä¹ˆå†™å»ºç«‹åœ¨mainæ–‡ä»¶é•¿æˆè¿™æ ·çš„æ—¶å€™ï¼š<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-7.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /><br>
è¿™ç§å¤´æ–‡ä»¶å®šä¹‰æ–¹å¼æ˜¯ä¸ç¬¦åˆè§„èŒƒçš„ï¼Œä¸€æ—¦å¤´æ–‡ä»¶çš„è·¯å¾„å‘ç”Ÿæ”¹å˜ï¼Œæ‰€æœ‰æºä»£ç éƒ½å¾—ä¿®æ”¹ï¼Œæ‰€ä»¥å¾—æ¢ä¸€ç§å®ç°æ–¹å¼ï¼š</p>
<ol>
<li>é¦–å…ˆæ”¹æˆå¦‚ä¸‹æ‰€ç¤ºï¼š<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-8.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /></li>
<li>ç„¶åéœ€è¦æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼š</li>
</ol>
   <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -o demo01 demo<span class="number">01.</span>cpp -L/home/pigcanstudy/test1/tools -lpublic -L/home/pigcanstudy/test1/api -lmyapi -I/home/pigcanstudy/test1/tools -I/home/pigcanstudy/test1/api/test1/api -lmyapi -I/home/pigcanstudy/test1/tools -I/home/pigcanstudy/test1/api</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>æ‰§è¡Œæ–‡ä»¶<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-9.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /></li>
<li><em><strong>ä¸ºäº†ä¸è®©æ¯æ¬¡æ‰§è¡Œéƒ½éœ€è¦æ‰“é‚£ä¹ˆçš„ç¼–è¯‘æŒ‡ä»¤ã€‚å¯ä»¥ä½¿ç”¨makefileæ¥ä»£æ›¿ä¹‹ï¼šå¦‚å›¾æ‰€ç¤ºï¼š</strong></em><br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-10.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /></li>
<li>ä¹‹åæ‰§è¡Œmakeå°±è¡Œäº†åŠ ./demoå°±èƒ½æ‰§è¡Œäº†</li>
<li><em><strong>é¡¹ç›®å¾ˆå¤§ï¼Œæœ‰å¾ˆå¤šéœ€è¦ç¼–è¯‘çš„ä¸œè¥¿æ€ä¹ˆåŠï¼Ÿ</strong></em><br>
<strong>ç­”æ¡ˆæ˜¯</strong>ä½¿ç”¨å˜é‡æ¥è¡¨ç¤º å¦‚å›¾<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-11.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /></li>
</ol>
</li>
</ol>
</li>
</ul>
<h3 id="mainå‡½æ•°çš„å‚æ•°">mainå‡½æ•°çš„å‚æ•°</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[], <span class="type">char</span> *envp[])</span></span></span><br></pre></td></tr></table></figure>
<h4 id="argc">argc</h4>
<p>å­˜æ”¾äº†ç¨‹åºå‚æ•°çš„ä¸ªæ•°ï¼ŒåŒ…æ‹¬ç¨‹åºæœ¬èº«</p>
<h4 id="argv">argv</h4>
<p>å­—ç¬¦ä¸²æ•°ç»„,å­˜æ”¾äº†æ¯ä¸ªå‚æ•°çš„å€¼ï¼ŒåŒ…æ‹¬ç¨‹åºæœ¬èº«</p>
<h4 id="envp">envp</h4>
<p>å­—ç¬¦ä¸²æ•°ç»„ï¼Œå­˜æ”¾äº†ç¯å¢ƒå˜é‡ï¼Œæ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ ä¸ºç©º<br>
è¿™å‚æ•°å¸¸ç”¨äºåˆ¤æ–­ä¸€ä¸ªäººæ˜¯å¦èƒ½è¿›å…¥ç¨‹åºï¼ˆå¦‚è¡¨ç™½ç¨‹åºï¼‰</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">//int setenv(const char* name, const char* value, int overwrite)&#123;</span></span><br><span class="line">        <span class="comment">// name ç¯å¢ƒå˜é‡å</span></span><br><span class="line">        <span class="comment">// value ç¯å¢ƒå˜é‡å€¼</span></span><br><span class="line">        <span class="comment">//overwrite 0 å¦‚æœç¯å¢ƒä¸å­˜åœ¨å¢åŠ æ–°çš„ç¯å¢ƒå˜é‡ï¼Œå­˜åœ¨ä¸æ›¿æ¢å…¶å€¼</span></span><br><span class="line">        <span class="comment">//overwrite é0 å­˜åœ¨å°±æ›¿æ¢å…¶å€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åªå¯¹æœ¬è¿›ç¨‹æœ‰æ•ˆ</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[],<span class="type">char</span>* envp[])</span></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;ä¸€å…±æœ‰&quot;</span> &lt;&lt; argc &lt;&lt; <span class="string">&quot;ä¸ªå‚æ•°\n&quot;</span>;</span><br><span class="line">    <span class="comment">// æ˜¾ç¤ºå…¨éƒ¨çš„å‚æ•°</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; argc; i ++)&#123;</span><br><span class="line">        std:: cout &lt;&lt; <span class="string">&quot;ç¬¬&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;ä¸ªå‚æ•°: &quot;</span> &lt;&lt; argv[i] &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">setenv</span>(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;HELLO&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">getenv</span>(<span class="string">&quot;hello&quot;</span>) &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">/*for(int i = 0; envp[i]!=0; i ++)&#123;</span></span><br><span class="line"><span class="comment">        std::cout &lt;&lt; envp[i] &lt;&lt; std::endl;</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="gdbè°ƒè¯•ç¨‹åº">gdbè°ƒè¯•ç¨‹åº</h3>
<p>å¦‚æœéœ€è¦ç¨‹åºå¯è°ƒè¯•ï¼Œç¼–è¯‘æ—¶éœ€è¦åŠ -gé€‰é¡¹ï¼Œå¹¶ä¸”ï¼Œä¸èƒ½ä½¿ç”¨-Oçš„ä¼˜åŒ–é€‰é¡¹</p>
<h4 id="gdbçš„å¸¸ç”¨å‘½ä»¤">gdbçš„å¸¸ç”¨å‘½ä»¤</h4>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-12.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" />
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-13.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" />
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-14.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" />
<h4 id="ç”¨gdbè°ƒè¯•coreæ–‡ä»¶">ç”¨gdbè°ƒè¯•coreæ–‡ä»¶</h4>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-15.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" />
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-16.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" />
<p>ulimit çš„å‚æ•° ï¼š<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-17.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /><br>
è¦ä¿®æ”¹å“ªä¸ªå‚æ•° å°± - å•¥</p>
<ul>
<li>
<p><strong>gdbæ’æŸ¥æ­»é”çš„æ–¹æ³•</strong></p>
<p>1 . å…ˆä½¿ç”¨</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ --std=c+<span class="number">+11</span> -g -O0 dead_lock.cpp -o dead_lock</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>å‘ç”Ÿæ­»é”å ç¨‹åºä¼šå¡ä½ï¼Œä¸€èˆ¬ä¼šæœ‰ä¸€ä¸ªçœ‹é—¨ç‹—ç¨‹åºï¼Œå¯¹å¡ä½çš„ç¨‹åºå‘é€killä¿¡å·ï¼Œè¿™æ—¶å€™è¢«æ€æ­»çš„ä¿¡å·ä¼šäº§ç”Ÿcoreæ–‡ä»¶</li>
<li><strong>ç„¶åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥åˆ†æcoreæ–‡ä»¶</strong></li>
</ol>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb -c ./core<span class="number">-49237</span> ./dead_lock</span><br></pre></td></tr></table></figure>
<p>å¹¶ç”¨btå‘½ä»¤æŸ¥çœ‹è°ƒç”¨æ ˆ<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-120.png" alt="alt text"><br>
4. åœ¨gdbè°ƒè¯•ä¸‹ä½¿ç”¨ <strong>info threads</strong>ï¼ŒæŸ¥çœ‹å½“å‰æœ‰å¤šå°‘çº¿ç¨‹<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-121.png" alt="alt text"><br>
5. ä½¿ç”¨<strong>thread åŠ å¯¹åº”ç¼–å·</strong>ä»¥åŠ <strong>bt</strong> æŸ¥çœ‹çº¿ç¨‹åœ¨å¹²å•¥<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-122.png" alt="alt text"><br>
6. ä½¿ç”¨<strong>f åŠ å¯¹åº”ç¼–å·</strong> æ¥æŸ¥çœ‹å¯¹åº”è°ƒç”¨æ ˆå¹²äº†ä»€ä¹ˆ<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-123.png" alt="alt text"><br>
7. ä½¿ç”¨ <strong>p åŠ ä½ è¦æŸ¥çœ‹çš„å˜é‡</strong>æŸ¥çœ‹å…¶å‚æ•°<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-124.png" alt="alt text"><br>
owner ä¸ä¸º0å°±è¡¨ç¤ºä»–è¢«è°å æœ‰ç€ï¼Œä½¿ç”¨ <strong>info threads</strong> èƒ½çœ‹çº¿ç¨‹çš„å¯¹åº”çº¿ç¨‹å·</p>
</li>
</ul>
<h4 id="ç”¨gdbè°ƒè¯•ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ç¨‹åº">ç”¨gdbè°ƒè¯•ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ç¨‹åº</h4>
<ul>
<li>é¦–å…ˆéœ€è¦çŸ¥é“è¿è¡Œç¨‹åºçš„è¿›ç¨‹ç¼–å·æ˜¯ä»€ä¹ˆï¼Ÿ<br>
ä½¿ç”¨ ps -ef |grep demo</li>
<li>ç„¶åä½¿ç”¨ gdb demo -p è¿›ç¨‹ç¼–å·</li>
<li>æ­£åœ¨è¿è¡Œçš„ç¨‹åºè¢«è°ƒè¯•äº†ä¼šè‡ªåŠ¨åœä¸‹æ¥</li>
</ul>
<h3 id="linuxçš„æ—¶é—´æ“ä½œ">linuxçš„æ—¶é—´æ“ä½œ</h3>
<ul>
<li>C++11æä¾›äº†æ“ä½œæ—¶é—´çš„chronoåº“</li>
<li>ä½†è¿™ä¸ªåº“å±è”½äº†å¾ˆå¤šç»†èŠ‚ æ‰€ä»¥æˆ‘ä»¬ä¸ºäº†æ›´å¥½ä½¿ç”¨å®ƒï¼Œå¾—äº†è§£ä»–çš„åº•å±‚</li>
</ul>
<h4 id="time-t-åˆ«å">time_t åˆ«å</h4>
<ul>
<li>è¿™æ˜¯ä¸€ä¸ªæ—¶é—´ç±»å‹ï¼Œä»–æ˜¯ä¸€ä¸ªlongç±»å‹çš„åˆ«åï¼Œåœ¨&lt;time.h&gt;æ–‡ä»¶ä¸­å®šä¹‰ï¼Œè¡¨ç¤ºä»1970.1.1åˆ°ç°åœ¨çš„ç§’æ•°</li>
<li>æ¨èä½¿ç”¨ time_tå®šä¹‰å®ƒ<br>
å¯ç”¨è¿™ä¸ª ç®€åŒ–ä¹¦å†™ typedef long time_tã€‚</li>
</ul>
<h4 id="time-åº“å‡½æ•°">time()åº“å‡½æ•°</h4>
<ul>
<li>
<p>è·å–æ“ä½œç³»ç»Ÿçš„å½“å‰æ—¶é—´<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-18.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /><br>
ä¸Šè¿°ä¸¤ç§ç”¨æ³•æ˜¯ä¸€æ ·çš„ï¼Œéƒ½å¯ä»¥ç”¨</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  include &lt;iostream&gt;</span><br><span class="line">  <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line">  <span class="keyword">typedef</span> <span class="type">long</span> <span class="type">time_t</span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="type">long</span> t = <span class="built_in">time</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="type">long</span> tt;</span><br><span class="line">  <span class="built_in">time</span>(&amp;tt);</span><br><span class="line">  std::cout &lt;&lt; t &lt;&lt; std::endl;</span><br><span class="line">  std::cout &lt;&lt; tt &lt;&lt; std::endl;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="tmç»“æ„ä½“-timeval">tmç»“æ„ä½“(timeval)</h4>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-19.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" />
<h4 id="localtime-åº“å‡½æ•°">localtime()åº“å‡½æ•°</h4>
<ul>
<li>è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯æŠŠtime_tè¡¨ç¤ºçš„æ—¶é—´è½¬å˜ä¸ºtmç»“æ„ä½“è¡¨ç¤ºçš„æ—¶é—´</li>
<li>localtime()å‡½æ•°ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„,localtime_r()æ˜¯çº¿ç¨‹å®‰å…¨çš„</li>
<li>å‡½æ•°å£°æ˜ <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-20.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /></li>
</ul>
<h4 id="mktime-å‡½æ•°">mktime()å‡½æ•°</h4>
<p>ä¸localtime()åŠŸèƒ½ç›¸å<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-21.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /></p>
<ul>
<li>è¿™ä¸ªå‡½æ•°ä¸»è¦ç”¨äºæ—¶é—´çš„è¿ç®—ï¼Œè¿™æ ·æ›´æ–¹ä¾¿è¿ç®—</li>
</ul>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-22.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" />
<h4 id="gettimeofday-å‡½æ•°">gettimeofday()å‡½æ•°</h4>
<ul>
<li>ç”¨äºè·å–ä»1970.1.1åˆ°ç°åœ¨çš„ç§’å’Œå½“å‰ç§’ä¸­å·²é€å»çš„å¾®ç§’æ•°ï¼Œå¯ä»¥ç”¨äºç¨‹åºçš„è®¡æ—¶</li>
<li>å‡½æ•°å£°æ˜ï¼š<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-23.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /></li>
</ul>
<h4 id="ç¨‹åºçš„ç¡çœ ">ç¨‹åºçš„ç¡çœ </h4>
<ul>
<li>æŠŠç¨‹åºæŒ‚èµ·ä¸€æ®µæ—¶é—´ sleep()å‡½æ•°<br>
ä¸usleep()å‡½æ•°</li>
<li>å‰è€…å•ä½æ˜¯ç§’ åè€…æ˜¯å¾®ç§’</li>
<li>åŒ…å«åœ¨å¤´æ–‡ä»¶&lt;unistd.h&gt;ä¸­<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-24.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /></li>
</ul>
<h3 id="linux-è·å–ç›®å½•æ“ä½œ">linux è·å–ç›®å½•æ“ä½œ</h3>
<h4 id="å‡ ä¸ªç®€å•çš„ç›®å½•æ“ä½œå‡½æ•°">å‡ ä¸ªç®€å•çš„ç›®å½•æ“ä½œå‡½æ•°</h4>
<h5 id="è·å–å½“å‰å·¥ä½œç›®å½•">è·å–å½“å‰å·¥ä½œç›®å½•</h5>
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-25.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" />
<ul>
<li>
<p>å³ getcwd()å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯è·å–å½“å‰çš„å·¥ä½œç›®å½•ï¼Œéœ€è¦æå‰æŒ‡å®šå¥½å®¹é‡</p>
</li>
<li>
<p>get_current_dir_name(void) è¿™ä¸ªå‡½æ•° åŠŸèƒ½ä¹Ÿæ˜¯è·å–å½“å‰çš„å·¥ä½œç›®å½•,ä½†æ˜¯å®ƒæ˜¯ åŠ¨æ€åˆ†é…å†…å­˜ï¼Œå…¶å†…éƒ¨æ˜¯ä½¿ç”¨malloc()å‡½æ•° æ‰€ä»¥éœ€è¦æ‰‹åŠ¨free()å®ƒ</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">char</span> path1[<span class="number">256</span>];</span><br><span class="line">    <span class="built_in">getcwd</span>(path1, <span class="number">256</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;path1 = &quot;</span> &lt;&lt; path1 &lt;&lt; std::endl;</span><br><span class="line">    <span class="type">char</span>* path2 = <span class="built_in">get_current_dir_name</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;path2= &quot;</span> &lt;&lt; path2 &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">free</span>(path2);<span class="comment">//æ³¨æ„é‡Šæ”¾å†…å­˜</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="åˆ‡æ¢å·¥ä½œç›®å½•">åˆ‡æ¢å·¥ä½œç›®å½•</h5>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-26.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" />
<h5 id="åˆ›å»ºç›®å½•">åˆ›å»ºç›®å½•</h5>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-27.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" />
å…¶ä¸­æœ‰ä¸¤ä¸ªå‚æ•° ä¸€ä¸ªæ˜¯ç›®å½•å ä¸€ä¸ªæ˜¯è®¿é—®æƒé™ ***æ³¨æ„ï¼šæƒé™æ˜¯å…«è¿›åˆ¶æ•°ä¸è¦çœç•¥å‰ç½®çš„0 ä¹Ÿå°±æ˜¯è¯´ 0755***
<ul>
<li><strong>å¦‚æœä¸Šçº§ç›®å½•ä¸å­˜åœ¨ä¼šå¤±è´¥</strong></li>
</ul>
<h5 id="åˆ é™¤ç›®å½•">åˆ é™¤ç›®å½•</h5>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-28.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" />
<h4 id="è·å–ç›®å½•ä¸­æ–‡ä»¶çš„åˆ—è¡¨">è·å–ç›®å½•ä¸­æ–‡ä»¶çš„åˆ—è¡¨</h4>
<ul>
<li>åœ¨å¤„ç†æ–‡ä»¶ä¹‹å‰å¿…é¡»å…ˆçŸ¥é“ç›®å½•åˆ—è¡¨</li>
</ul>
<h5 id="åŒ…å«å¤´æ–‡ä»¶">åŒ…å«å¤´æ–‡ä»¶</h5>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br></pre></td></tr></table></figure>
<h5 id="ç›¸å…³çš„åº“å‡½æ•°">ç›¸å…³çš„åº“å‡½æ•°</h5>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-29.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" />
<ul>
<li>
<p>ç›®å½•æŒ‡é’ˆ DIR ï¼Œå£°æ˜æ–¹å¼DIR* æŒ‡é’ˆåå­—</p>
</li>
<li>
<p>readdir()ï¼Œè¿”å›ç»“æ„ä½“ direntçš„åœ°å€ï¼Œå­˜æ”¾äº†æœ¬æ¬¡è¯»å–åˆ°çš„å†…å®¹</p>
</li>
<li>
<p>ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-30.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /></p>
</li>
<li>
<p>é‡ç‚¹å…³æ³¨d_typeå’Œd_nameæˆå‘˜ï¼Œå…¶ä¸­æ–‡ä»¶ç±»å‹æœ‰å¤šç§å–å€¼ï¼Œæœ€é‡è¦çš„æ˜¯8å’Œ4ï¼Œ8è¡¨ç¤ºå¸¸è§„æ–‡ä»¶ï¼Œ4è¡¨ç¤ºç›®å½•</p>
</li>
<li>
<p>ç¤ºä¾‹ä»£ç :</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line">  <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span> <span class="comment">// ç›®å½•æ“ä½œçš„å¤´æ–‡ä»¶</span></span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(argc != <span class="number">2</span>)&#123;</span><br><span class="line">      std::cout &lt;&lt; <span class="string">&quot;Using ./mulu1 ç›®å½•å\n&quot;</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  DIR* dir;</span><br><span class="line">  <span class="keyword">if</span>((dir = <span class="built_in">opendir</span>(argv[<span class="number">1</span>])) == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">// æ‰“å¼€å¤±è´¥</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">dirent</span> *stdinfo = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span>((stdinfo = <span class="built_in">readdir</span>(dir)) == <span class="literal">nullptr</span>) <span class="keyword">break</span>;</span><br><span class="line">      std::cout &lt;&lt; <span class="string">&quot;æ–‡ä»¶å: &quot;</span> &lt;&lt; stdinfo-&gt;d_name &lt;&lt; <span class="string">&quot;, æ–‡ä»¶ç±»å‹= &quot;</span> &lt;&lt; (<span class="type">int</span>)stdinfo-&gt;d_type &lt;&lt; std::endl;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="linux-çš„ç³»ç»Ÿé”™è¯¯">linux çš„ç³»ç»Ÿé”™è¯¯</h3>
<ul>
<li>åœ¨C++ç¨‹åºä¸­ï¼Œå¦‚æœè°ƒç”¨äº†åº“å‡½æ•°ï¼Œå¦‚æœå¤±è´¥äº†ä¼šåœ¨å…¨å±€å˜é‡<strong>errno</strong>ä¸­å­˜æ”¾è°ƒç”¨è¿‡ç¨‹äº§ç”Ÿé”™è¯¯ä»£ç çš„åŸå› ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨<strong>errno</strong>å˜é‡æ¥æŸ¥æ‰¾åŸå› </li>
<li>å¤´æ–‡ä»¶ï¼š&lt;error.h&gt;</li>
<li>éœ€è¦é…åˆsterror()å’Œperror()ä¸¤ä¸ªå‡½æ•°åº“ï¼Œæ¥è·å–è¯¦ç»†ä¿¡æ¯</li>
</ul>
<h4 id="sterror-åº“å‡½æ•°">sterror()åº“å‡½æ•°</h4>
<ul>
<li>å…¶æ˜¯å£°æ˜åœ¨&lt;string.h&gt;ä¸­</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">char</span>* <span class="title">strerror</span><span class="params">(<span class="type">int</span> errnum)</span></span>; <span class="comment">//éçº¿ç¨‹å®‰å…¨</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">strerror_r</span><span class="params">(<span class="type">int</span> errnum, <span class="type">char</span>*buf, <span class="type">size_t</span> buflen)</span></span>; <span class="comment">//çº¿ç¨‹å®‰å…¨</span></span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ä»£ç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cerrno&gt;</span> <span class="comment">//errnoå…¨å±€å˜é‡çš„å¤´æ–‡ä»¶</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span> <span class="comment">// mkdirå‡½æ•°æ‰€åœ¨å¤´æ–‡ä»¶</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> ir = <span class="built_in">mkdir</span>(<span class="string">&quot;/home/pigcanstudy/test1/123&quot;</span>, <span class="number">0755</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;ir= &quot;</span> &lt;&lt; ir &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; errno &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; <span class="built_in">strerror</span>(errno) &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="perror-åº“å‡½æ•°">perror()åº“å‡½æ•°</h4>
<ul>
<li>åœ¨&lt;stdio.h&gt; ä¸­ï¼Œç”¨äºåœ¨æ§åˆ¶å°æ˜¾ç¤ºæœ€è¿‘ä¸€æ¬¡ç³»ç»Ÿé”™è¯¯çš„è¯¦ç»†ä¿¡æ¯</li>
</ul>
<h4 id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</h4>
<ol>
<li><em><strong>å¹¶ä¸æ˜¯æ‰€æœ‰åº“å‡½æ•°è°ƒç”¨å¤±è´¥éƒ½ä¼šåœ¨errnoä¸­å­˜å‚¨ï¼Œä»¥man æ‰‹å†Œä¸ºä¸»(ä¸å±äºç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°ä¸ä¼šè®¾ç½®errno)</strong></em></li>
<li><em><strong>errnoä¸èƒ½ä½œä¸ºè°ƒç”¨åº“å‡½æ•°çš„å¤±è´¥æ ‡å¿— å› ä¸ºerrno åœ¨è°ƒç”¨æˆåŠŸå ä¸ä¼šæ”¹å˜å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ä¼šä¸»åŠ¨ç½®ä¸º0ï¼ˆ0è¡¨ç¤ºæˆåŠŸï¼‰</strong></em></li>
</ol>
<h3 id="ç›®å½•å’Œæ–‡ä»¶çš„æ›´å¤šæ“ä½œ">ç›®å½•å’Œæ–‡ä»¶çš„æ›´å¤šæ“ä½œ</h3>
<h4 id="access-åº“å‡½æ•°">access()åº“å‡½æ•°</h4>
<ul>
<li>æ­¤å‡½æ•°ç”¨äºåˆ¤æ–­å½“å‰ç”¨æˆ·å¯¹ç›®å½•æˆ–æ–‡ä»¶çš„å­˜å‚¨æƒé™æ˜¯å¦æ»¡è¶³</li>
<li>åŒ…å«åœ¨å¤´æ–‡ä»¶&lt;unistd.h&gt;ä¸­<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-31.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /><br>
å››ç§æƒé™<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-32.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /></li>
<li>è¿”å›å€¼ å½“pathnameæ»¡è¶³modeæƒé™è¿”å›0ï¼Œä¸æ»¡è¶³è¿”å›-1ï¼Œerrno è¢«è®¾ç½®</li>
<li>åœ¨å®é™…å¼€å‘ä¸­ access()å‡½æ•°ä¸»è¦ç”¨äºåˆ¤æ–­ç›®å½•æˆ–æ–‡ä»¶æ˜¯å¦å­˜åœ¨<br>
ç¤ºä¾‹ä»£ç ï¼š</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(argc != <span class="number">2</span>)&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Using ./access æ–‡ä»¶æˆ–ç›®å½•å\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">access</span>(argv[<span class="number">1</span>],F_OK) != <span class="number">0</span>)&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;æ–‡ä»¶æˆ–ç›®å½•&quot;</span> &lt;&lt; argv[<span class="number">1</span>] &lt;&lt; <span class="string">&quot;ä¸å­˜åœ¨\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;æ–‡ä»¶æˆ–ç›®å½•&quot;</span> &lt;&lt; argv[<span class="number">1</span>] &lt;&lt; <span class="string">&quot;å­˜åœ¨\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="statç»“æ„ä½“">statç»“æ„ä½“</h4>
<ul>
<li>stat ç»“æ„ä½“ç”¨äºå­˜æ”¾ç›®å½•æˆ–æ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-33.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /></li>
<li><em><strong>é‡ç‚¹å…³æ³¨st_mode,st_sizeå’Œst_mtimeæˆå‘˜</strong></em>, st_mtimeæ˜¯ä¸€ä¸ªæ•´æ•°è¡¨ç¤ºçš„æ—¶é—´ï¼Œéœ€è¦ç¨‹åºå‘˜è‡ªå·±å†™ä»£ç è½¬æ¢æ ¼å¼<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-34.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /></li>
</ul>
<h4 id="stat-åº“å‡½æ•°">stat()åº“å‡½æ•°</h4>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-35.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" />
<h4 id="utime-åº“å‡½æ•°">utime()åº“å‡½æ•°</h4>
<ul>
<li>
<p>ç”¨äºä¿®æ”¹ç›®å½•æˆ–æ–‡ä»¶çš„æ—¶é—´<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-36.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /></p>
</li>
<li>
<p>ç»“æ„ä½“ utimbuf<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-37.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" /></p>
</li>
</ul>
<h4 id="rename-åº“å‡½æ•°">rename()åº“å‡½æ•°</h4>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-38.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" />
<h4 id="remove-åº“å‡½æ•°">remove()åº“å‡½æ•°</h4>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-39.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" />
<h3 id="Linuxçš„ä¿¡å·">Linuxçš„ä¿¡å·</h3>
<h4 id="ä¿¡å·çš„åŸºæœ¬æ¦‚å¿µ">ä¿¡å·çš„åŸºæœ¬æ¦‚å¿µ</h4>
<ul>
<li>ä¿¡å·æ˜¯è½¯ä»¶ä¸­æ–­ï¼Œæ˜¯è¿›ç¨‹ä¹‹é—´ç›¸äº’ä¼ é€’æ¶ˆæ¯çš„ä¸€ç§æ–¹æ³•ï¼Œç”¨äºé€šçŸ¥è¿›ç¨‹å‘ç”Ÿäº†äº‹ä»¶ï¼Œä½†æ˜¯ï¼Œä¸èƒ½ç»™è¿›ç¨‹ä¼ é€’ä»»ä½•æ•°æ®</li>
<li>åœ¨shellä¸­ä½¿ç”¨kill å’Œ killall å‘½ä»¤å‘é€ä¿¡å·</li>
</ul>
<h5 id="kill-ä¸-killall-çš„åŒºåˆ«">kill ä¸ killall çš„åŒºåˆ«</h5>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/assets/ç½‘ç»œç¼–ç¨‹/image-40.png" alt="ç¤ºä¾‹å›¾ç‰‡" style="zoom:50%;" />
<h4 id="ä¿¡å·çš„ç±»å‹">ä¿¡å·çš„ç±»å‹</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-44.png" alt="Alt text"></p>
<ul>
<li><em><strong>é‡è¦çš„ç±»å‹</strong></em>
<ol>
<li>
<p>SIGINT 2 A é”®ç›˜ä¸­æ–­</p>
</li>
<li>
<p>SIGKILL 9 AEF é‡‡ç”¨kill -9 è¿›ç¨‹ç¼–å·å¼ºåˆ¶æ€æ­»ç¨‹åº</p>
</li>
<li>
<p>SIGALRM 14 A ç”±é—¹é’Ÿalarm()å‡½æ•°å‘å‡ºçš„ä¿¡å·</p>
</li>
<li>
<p>SIGTERM 15 A é‡‡ç”¨ kill è¿›ç¨‹ç¼–å· æˆ– killall ç¨‹åºåæ¥é€šçŸ¥ç¨‹åº</p>
</li>
<li>
<p>SIGCHLD 17 B å­è¿›ç¨‹ç»“æŸä¿¡å·</p>
</li>
<li>
<p>SIGSEGV 11 CEF æ— æ•ˆçš„å†…å­˜å¼•ç”¨ï¼ˆæ•°ç»„è¶Šç•Œï¼Œæ“ä½œç©ºæŒ‡é’ˆå’Œé‡æŒ‡é’ˆï¼‰</p>
</li>
</ol>
</li>
</ul>
<p><em><strong>å…¶ä¸­å­—æ¯è¡¨ç¤ºé»˜è®¤ç¼ºçœçš„ç±»å‹</strong></em><br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-41.png" alt="Alt text"></p>
<h4 id="ä¿¡å·çš„å¤„ç†">ä¿¡å·çš„å¤„ç†</h4>
<ol>
<li>å¤§éƒ¨åˆ†é»˜è®¤æ“ä½œæ˜¯ç»ˆæ­¢è¿›ç¨‹</li>
<li>è®¾ç½®ä¿¡å·å¤„ç†å‡½æ•°ï¼ˆsignal() å‡½æ•°ï¼‰</li>
<li>å¿½ç•¥æŸä¸ªä¿¡å·<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-43.png" alt="Alt text"></li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">(<span class="type">int</span> signum)</span></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;æ”¶åˆ°äº†ä¿¡å·: &quot;</span> &lt;&lt; signum &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func1</span><span class="params">(<span class="type">int</span> sig)</span></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;æ”¶åˆ°äº†é—¹é’Ÿä¿¡å·,å®Œæˆäº†å®šæ—¶ä»»åŠ¡\n&quot;</span>;</span><br><span class="line">    <span class="built_in">alarm</span>(<span class="number">5</span>); <span class="comment">//æ­¤å‡½æ•°ä¸èƒ½å°‘å¦åˆ™åªä¼šå“åº”ä¸€æ¬¡</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">signal</span>(<span class="number">1</span>,func);</span><br><span class="line">    <span class="built_in">signal</span>(<span class="number">15</span>,func);</span><br><span class="line">    <span class="built_in">signal</span>(SIGINT, SIG_IGN); <span class="comment">// å¿½ç•¥2çš„ä¿¡å·</span></span><br><span class="line">    <span class="built_in">signal</span>(<span class="number">9</span>, func);<span class="comment">//æ­¤ä»£ç æ— æ•ˆï¼Œå› ä¸º9ä¸å¯è¢«æ•è·</span></span><br><span class="line">    <span class="built_in">signal</span>(<span class="number">9</span>, SIG_IGN);<span class="comment">//æ­¤ä»£ç æ— æ•ˆï¼Œå› ä¸º9ä¸å¯è¢«å¿½ç•¥</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">alarm</span>(<span class="number">5</span>);<span class="comment">//é—¹é’Ÿï¼ˆå®šæ—¶å™¨ï¼‰ï¼Œ5ç§’åå‘è¿›ç¨‹å‘é€14çš„ä¿¡å·</span></span><br><span class="line">    <span class="built_in">signal</span>(<span class="number">14</span>, func1);<span class="comment">//è®¾ç½®å®šæ—¶ä»»åŠ¡å‡½æ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;æ‰§è¡Œäº†ä¸€æ¬¡ä»»åŠ¡ã€‚\n&quot;</span>;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>SIG_DEF: æ¢å¤å‚æ•°signum æ‰€æŒ‡ä¿¡å·çš„å¤„ç†æ–¹æ³•ä¸ºé»˜è®¤å€¼</li>
<li>è‡ªå®šä¹‰çš„ä¿¡å·æ¯”å¦‚func</li>
<li>SIG_IGN: å¿½ç•¥å‚æ•°signumæ‰€æŒ‡çš„ä¿¡å·</li>
</ul>
<h4 id="ä¿¡å·æœ‰ä»€ä¹ˆç”¨">ä¿¡å·æœ‰ä»€ä¹ˆç”¨</h4>
<ol>
<li>å¯ä»¥åœ¨æ€æ­»è¿›ç¨‹çš„æ—¶å€™è¿›è¡Œå–„åå·¥ä½œï¼Œæ¯”å¦‚é‡Šæ”¾å†…å­˜å•¥çš„</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EXIT</span><span class="params">(<span class="type">int</span> sig)</span></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;æ”¶åˆ°äº†ä¿¡å·ï¼š&quot;</span> &lt;&lt; sig &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;æ­£åœ¨é‡Šæ”¾èµ„æºï¼Œç¨‹åºå°†é€€å‡º....&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">//ä»¥ä¸‹æ˜¯é‡Šæ”¾èµ„æº</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;ç¨‹åºé€€å‡º&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">signal</span>(<span class="number">2</span>, EXIT);</span><br><span class="line">    <span class="built_in">signal</span>(<span class="number">15</span>, EXIT);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>å‘ç¨‹åºå‘é€0ä¿¡å·ï¼Œå¯ä»¥æ£€æµ‹ç¨‹åºæ˜¯å¦å­˜æ´»<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-45.png" alt="Alt text"></li>
</ol>
<h4 id="å‘é€ä¿¡å·">å‘é€ä¿¡å·</h4>
<p>å¯ä»¥ä½¿ç”¨killï¼ˆï¼‰å‡½æ•°å‘å…¶ä»–è¿›ç¨‹å‘é€ä¿¡å·</p>
<ol>
<li>å‡½æ•°å£°æ˜ int kill(pid_t pid, int sig);
<ol>
<li>sigè¡¨ç¤ºæ˜¯å•¥ä¿¡å·</li>
<li>pid è¡¨ç¤ºæŒ‡å®šçš„è¿›ç¨‹å·</li>
</ol>
</li>
<li>pidçš„å‡ ç§æƒ…å†µ
<ol>
<li>pid&gt;0 å°†ä¿¡å·ä¼ ç»™è¿›ç¨‹å·ä¸ºpidçš„è¿›ç¨‹</li>
<li>pid=0 å°†ä¿¡å·ä¼ é€’ç»™å’Œç›®å‰è¿›ç¨‹ç›¸åŒè¿›ç¨‹ç»„çš„æ‰€æœ‰è¿›ç¨‹å¸¸ç”¨äºçˆ¶è¿›ç¨‹ç»™å­è¿›ç¨‹å‘é€ä¿¡å·ï¼Œæ³¨æ„ï¼Œå‘é€ä¿¡å·è€…ä¹Ÿä¼šæ”¶åˆ°è‡ªå·±å‘å‡ºçš„ä¿¡å·</li>
<li>pid=-1 å°†ä¿¡å·å¹¿æ’­å‘é€ç»™ç³»ç»Ÿå†…æ‰€æœ‰è¿›ç¨‹ï¼Œä¾‹å¦‚ç³»ç»Ÿå…³æœºæ—¶ï¼Œä¼šå‘æ‰€æœ‰çš„ç™»å½•çª—å£å¹¿æ’­å…³æœºä¿¡æ¯</li>
</ol>
</li>
</ol>
<h3 id="è¿›ç¨‹ç»ˆæ­¢">è¿›ç¨‹ç»ˆæ­¢</h3>
<h4 id="è¿›ç¨‹ç»ˆæ­¢æ–¹å¼">è¿›ç¨‹ç»ˆæ­¢æ–¹å¼</h4>
<ul>
<li>æœ‰8ç§æ–¹å¼å¯ä»¥ç»ˆæ­¢è¿›ç¨‹</li>
<li>å…¶ä¸­äº”ç§ä¸ºæ­£å¸¸ç»ˆæ­¢
<ol>
<li>main()å‡½æ•°ç”¨return è¿”å›</li>
<li>ç”¨exit()é€€å‡º</li>
<li>è°ƒç”¨_exit()æˆ–_Exit()å‡½æ•°</li>
<li>æœ€åä¸€ä¸ªçº¿ç¨‹ä»å¯åŠ¨ä¾‹ç¨‹(çº¿ç¨‹ä¸»å‡½æ•°)ç”¨returnè¿”å›</li>
<li>åœ¨æœ€åä¸€ä¸ªçº¿ç¨‹ä¸­è°ƒç”¨pthread_exit()è¿”å›</li>
</ol>
</li>
<li>å¼‚å¸¸ç»ˆæ­¢æœ‰ä¸‰ä¸ªæ–¹å¼
<ol>
<li>è°ƒç”¨abort() å‡½æ•°</li>
<li>æ¥æ”¶åˆ°ä¸€ä¸ªä¿¡å·</li>
<li>æœ€åä¸€ä¸ªçº¿ç¨‹å¯¹å–æ¶ˆè¯·æ±‚åšå‡ºå“åº”</li>
</ol>
</li>
</ul>
<h4 id="è¿›ç¨‹ç»ˆæ­¢çŠ¶æ€">è¿›ç¨‹ç»ˆæ­¢çŠ¶æ€</h4>
<ol>
<li>é»˜è®¤ç»ˆæ­¢çŠ¶æ€ä¸º0</li>
<li>æŸ¥çœ‹è¿›ç¨‹ç»ˆæ­¢çŠ¶æ€ä¸º echo $?</li>
<li>3ä¸ªæ­£å¸¸ç»ˆæ­¢å‡½æ•°çš„å‚æ•°å°±æ˜¯çŠ¶æ€<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-46.png" alt="Alt text"></li>
<li>å¼‚å¸¸ç»ˆæ­¢ çŠ¶æ€ä¸ºé0</li>
</ol>
<h4 id="èµ„æºé‡Šæ”¾çš„é—®é¢˜">èµ„æºé‡Šæ”¾çš„é—®é¢˜</h4>
<ul>
<li>return åœ¨å“ªä¸ªå‡½æ•°ä¸­è¿”å›å°±ä¼šæ¸…ç†å“ªä¸ªå±€éƒ¨å¯¹è±¡çš„ææ„å‡½æ•°ï¼Œåœ¨mainä¸­è¿˜ä¼šè°ƒç”¨å…¨å±€å¯¹è±¡çš„ææ„</li>
<li><em><strong>exit()ä¸ä¼šè°ƒç”¨å±€éƒ¨å¯¹è±¡çš„ææ„ï¼Œä¼šè°ƒç”¨å…¨å±€å¯¹è±¡ææ„</strong></em></li>
<li>exit()ä¼šæ‰§è¡Œæ¸…ç†å·¥ä½œï¼Œåœ¨é€€å‡º è€Œ_exit(),_Exit()ä¼šç›´æ¥é€€å‡ºï¼Œä¸æ‰§è¡Œæ¸…ç†å·¥ä½œ</li>
</ul>
<h4 id="è¿›ç¨‹çš„ç»ˆæ­¢å‡½æ•°">è¿›ç¨‹çš„ç»ˆæ­¢å‡½æ•°</h4>
<ul>
<li>atexit()å‡½æ•°ç™»è®°ç»ˆæ­¢å‡½æ•°æœ€å¤š32ä¸ªï¼Œè¿™äº›å‡½æ•°ç”±exit()è‡ªåŠ¨è°ƒç”¨
<ol>
<li>int atexit(void(*function)(void));</li>
<li>exit()è°ƒç”¨ç»ˆæ­¢å‡½æ•°é¡ºåºä¸ç™»è®°æ—¶ç›¸å</li>
<li>å¯ä»¥å¹²äº›è¿›ç¨‹ç»ˆæ­¢å‰çš„æ”¶å°¾å·¥ä½œ</li>
</ol>
</li>
</ul>
<h3 id="è°ƒç”¨å¯æ‰§è¡Œç¨‹åº">è°ƒç”¨å¯æ‰§è¡Œç¨‹åº</h3>
<h4 id="system-åº“å‡½æ•°">system()åº“å‡½æ•°</h4>
<h5 id="åŠŸèƒ½">åŠŸèƒ½</h5>
<p>è°ƒç”¨å¯æ‰§è¡Œç¨‹åºï¼ŒæŠŠéœ€è¦æ‰§è¡Œçš„ç¨‹åºå’Œå‚æ•°ç”¨ä¸€ä¸ªå­—ç¬¦ä¸²ä¼ ç»™system()å°±å¥½äº†<br>
å¤´æ–‡ä»¶å¯ç”¨ man system()æ¥æŸ¥çœ‹</p>
<h5 id="è¿”å›å€¼">è¿”å›å€¼</h5>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">system</span>(<span class="string">&quot;/bin/ls -l /tmp&quot;</span>);<span class="comment">//æ³¨æ„ä½¿ç”¨å…¨è·¯å¾„ï¼Œå› ä¸ºå¯ä»¥é¿å…ç¯å¢ƒå˜é‡é—®é¢˜</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;ret=&quot;</span> &lt;&lt; ret &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">perror</span>(<span class="string">&quot;system&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-47.png" alt="Alt text"></p>
<h4 id="execå‡½æ•°æ—">execå‡½æ•°æ—</h4>
<p>execå‡½æ•°æ—æä¾›äº†å¦ä¸€ç§åœ¨è¿›ç¨‹ä¸­è°ƒç”¨ç¨‹åº(äºŒè¿›åˆ¶æ–‡ä»¶æˆ–shellè„šæœ¬)çš„æ–¹æ³•</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-48.png" alt="Alt text"></p>
<p>å…¶ä¸­é‡è¦çš„å·²ç»åŠ ç²—</p>
<h5 id="execl-å‡½æ•°">execl()å‡½æ•°</h5>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">execl</span>(<span class="string">&quot;/bin/ls&quot;</span>, <span class="string">&quot;/bin/ls&quot;</span>, <span class="string">&quot;-lt&quot;</span>, <span class="string">&quot;/tmp&quot;</span>, <span class="number">0</span>);<span class="comment">//æœ€åä¸€ä¸ª0ä¸èƒ½çœç•¥ï¼Œå› ä¸ºä»–è¡¨ç¤ºå¯å˜å‚æ•°ç»“æŸï¼Œç¬¬ä¸€ä¸ªä¸ç¬¬äºŒä¸ªå¡«éœ€è¦æ‰§è¡Œçš„å‡½æ•°ï¼Œåé¢æ˜¯å¯å˜å‚æ•°å¡«éœ€è¦æ‰§è¡Œå‡½æ•°çš„å‚æ•°</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;ret=&quot;</span> &lt;&lt; ret &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">perror</span>(<span class="string">&quot;execl&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>æ³¨æ„äº‹é¡¹:<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-49.png" alt="Alt text">
<ol>
<li>å…¶ä¸­ç¬¬äºŒç‚¹å°¤ä¸ºé‡è¦ï¼Œæ–°è¿›ç¨‹çš„è¿›ç¨‹ç¼–å·ä¸åŸè¿›ç¨‹ç›¸åŒï¼Œä½†æ˜¯ï¼Œæ–°è¿›ç¨‹å–ä»£äº†åŸè¿›ç¨‹çš„ä»£ç æ®µï¼Œæ•°æ®æ®µï¼Œå’Œå †æ ˆ<br>
ä¸¾ä¾‹ï¼š</li>
</ol>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    <span class="comment">// æ–°è¿›ç¨‹çš„è¿›ç¨‹ç¼–å·ä¸åŸè¿›ç¨‹ç¼–å·ç›¸åŒï¼Œä½†æ˜¯ï¼Œæ–°è¿›ç¨‹å–ä»£äº†åŸè¿›ç¨‹çš„ä»£ç æ®µï¼Œæ•°æ®æ®µå’Œå †æ ˆ</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;demo æœ¬è¿›ç¨‹çš„ç¼–å·æ˜¯: &quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; std::endl;</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">execl</span>(<span class="string">&quot;/home/pigcanstudy/test1/demo01&quot;</span>,<span class="string">&quot;/home/pigcanstudy/test1/demo01&quot;</span>,<span class="number">0</span>);<span class="comment">//æœ€åä¸€ä¸ª0ä¸èƒ½çœç•¥ï¼Œå› ä¸ºä»–è¡¨ç¤ºå¯å˜å‚æ•°ç»“æŸï¼Œç¬¬ä¸€ä¸ªä¸ç¬¬äºŒä¸ªå¡«éœ€è¦æ‰§è¡Œçš„å‡½æ•°ï¼Œåé¢æ˜¯å¯å˜å‚æ•°å¡«éœ€è¦æ‰§è¡Œå‡½æ•°çš„å‚æ•°</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;ret=&quot;</span> &lt;&lt; ret &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">perror</span>(<span class="string">&quot;execl&quot;</span>);</span><br><span class="line">    <span class="comment">/*int res = system(&quot;/home/pigcanstudy/test1.demo01&quot;);</span></span><br><span class="line"><span class="comment">    std::cout &lt;&lt; &quot;res=&quot; &lt;&lt; res &lt;&lt; std::endl;</span></span><br><span class="line"><span class="comment">    perror(&quot;system&quot;);*/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-50.png" alt="Alt text"></p>
<h5 id="execv-å‡½æ•°">execv()å‡½æ•°</h5>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-52.png" alt="Alt text"><br>
æ³¨æ„ char* å¿…ä¸å¯å°‘å¦åˆ™ä¼šæŠ¥é”™</p>
<h3 id="åˆ›å»ºè¿›ç¨‹">åˆ›å»ºè¿›ç¨‹</h3>
<h4 id="Linuxçš„0ï¼Œ1ï¼Œ2å·è¿›ç¨‹">Linuxçš„0ï¼Œ1ï¼Œ2å·è¿›ç¨‹</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-53.png" alt="Alt text"></p>
<ul>
<li>æ³¨æ„ä»–æ˜¯ä¸€ä¸ªæ ‘å½¢ç»“æ„</li>
</ul>
<h4 id="è¿›ç¨‹æ ‡è¯†">è¿›ç¨‹æ ‡è¯†</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-54.png" alt="Alt text"></p>
<h4 id="fork-å‡½æ•°">fork()å‡½æ•°</h4>
<p>ç”¨æ¥åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-55.png" alt="Alt text"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> bh = <span class="number">8</span>;</span><br><span class="line">    std::string message=<span class="string">&quot;æˆ‘æ˜¯ä¸€åªå°çŒª&quot;</span>;</span><br><span class="line">    <span class="type">pid_t</span> pid = fork();</span><br><span class="line">    <span class="type">pid_t</span> pid1 = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;fu&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; pid &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;zi&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; pid &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(pid1 &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;fu&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; pid1 &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;zi&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; pid1 &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="fork-çš„ä¸¤ç§ç”¨æ³•">fork()çš„ä¸¤ç§ç”¨æ³•</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-56.png" alt="Alt text"></p>
<ul>
<li>ç¬¬ä¸€ç§ä¸ºä¸Šè¿°Cpp</li>
<li>ç¬¬äºŒç§ç¤ºä¾‹ä¸ºä¸‹ï¼š</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(fork() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">//çˆ¶è¿›ç¨‹æ‰§è¡Œè¿™ä¸€æ®µä»£ç </span></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;çˆ¶è¿›ç¨‹è¿è¡Œä¸­...\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// å­è¿›ç¨‹æ‰§è¡Œè¿™ä¸€æ®µä»£ç </span></span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">10</span>);</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;å­è¿›ç¨‹å¼€å§‹æ‰§è¡Œä»»åŠ¡....\n&quot;</span>;</span><br><span class="line">        <span class="built_in">execl</span>(<span class="string">&quot;/home/pigcanstudy/test1/demo01&quot;</span>, <span class="string">&quot;/home/pigcanstudy/test1/demo01&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;å­è¿›ç¨‹æ‰§è¡Œä»»åŠ¡ç»“æŸï¼Œé€€å‡º\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è¡¥å…… <em><strong>shellçš„åŸç†æ˜¯åœ¨bashè¿™ä¸ªè¿›ç¨‹ä¸‹åˆ›å»ºå­è¿›ç¨‹æ¥æ‰§è¡Œä½ å†™çš„æ“ä½œ</strong></em></li>
</ul>
<h4 id="å…±äº«æ–‡ä»¶">å…±äº«æ–‡ä»¶</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-58.png" alt="Alt text"><br>
å¯¹è¿™å¥è¯çš„è§£é‡Šå°±æ˜¯çˆ¶å­è¿›ç¨‹ä¸­ï¼Œå¦‚æœçˆ¶è¿›ç¨‹å…ˆæ‰§è¡Œå®Œæ–‡ä»¶å†™æ“ä½œï¼Œå­è¿›ç¨‹ä¼šæ¥ç€çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æŒ‡é’ˆçš„ä¸‹ä¸€ä¸ªæ¥å†™ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ä¼šè¦†ç›–æ–‡ä»¶çš„å†…å®¹ï¼Œè€Œæ˜¯æ¥åœ¨åé¢</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-59.png" alt="Alt text"><br>
<em><strong>éœ€è¦é‡‡ç”¨è¿›ç¨‹åŒæ­¥</strong></em></p>
<h4 id="vfork">vfork()</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-60.png" alt="Alt text"></p>
<h3 id="åƒµå°¸è¿›ç¨‹">åƒµå°¸è¿›ç¨‹</h3>
<h4 id="åƒµå°¸è¿›ç¨‹çš„äº§ç”Ÿ">åƒµå°¸è¿›ç¨‹çš„äº§ç”Ÿ</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-63.png" alt="Alt text"></p>
<ul>
<li>
<p>å¯¹äºç¬¬ä¸€å¥è¯çš„è§£é‡Š<br>
ä»£ç ï¼š<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-62.png" alt="Alt text"><br>
ç»“æœï¼š<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-61.png" alt="Alt text"></p>
<p>å°†ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºæ”¾åœ¨åå°è¿è¡Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š</p>
<ol>
<li>ç›´æ¥æ‰§è¡Œ ./demo &amp;</li>
<li>åœ¨ç¨‹åºçš„ä»£ç ä¸­ åŠ å…¥ä¸€è¡Œif(fork() &gt; 0) return 0;</li>
</ol>
<ul>
<li>
<p>å¯¹äºç¬¬äºŒå¥è¯è§£é‡Š</p>
<p>ä»£ç ï¼š<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-64.png" alt="Alt text"></p>
<p>ç»“æœï¼š<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-65.png" alt="Alt text"></p>
<p>å½“ä¸€ä¸ªè¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œå®ƒçš„çŠ¶æ€ä¿¡æ¯ä»ç„¶è¢«ä¿ç•™åœ¨ç³»ç»Ÿä¸­ï¼Œç›´åˆ°å…¶çˆ¶è¿›ç¨‹è°ƒç”¨waitæˆ–waitpidç­‰ç³»ç»Ÿè°ƒç”¨æ¥è·å–å…¶ç»ˆæ­¢çŠ¶æ€ä¿¡æ¯ã€‚å¦‚æœçˆ¶è¿›ç¨‹æ²¡æœ‰åŠæ—¶è°ƒç”¨è¿™äº›ç³»ç»Ÿè°ƒç”¨æ¥è·å–ç»ˆæ­¢çŠ¶æ€ä¿¡æ¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå·²ç»ç»ˆæ­¢çš„å­è¿›ç¨‹å°±ä¼šæˆä¸ºä¸€ä¸ªåƒµå°¸è¿›ç¨‹ï¼ˆZombie Processï¼‰ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-66.png" alt="Alt text"></p>
</li>
</ul>
</li>
</ul>
<h4 id="åƒµå°¸è¿›ç¨‹åœ°é¿å…">åƒµå°¸è¿›ç¨‹åœ°é¿å…</h4>
<ol>
<li>å­è¿›ç¨‹é€€å‡ºçš„æ—¶å€™ï¼Œå†…æ ¸ä¼šç»™çˆ¶è¿›ç¨‹å‘å‡ºSIGCHLDä¿¡å·ï¼Œå¦‚æœçˆ¶è¿›ç¨‹è°ƒç”¨äº†signal(SIGCHLD,SIG_IGN)æ¥é€šçŸ¥å†…æ ¸ï¼Œå†…æ ¸å°±ä¼šæŠŠè¿™ä¸ªå­è¿›ç¨‹çš„æ•°æ®ç»“æ„é‡Šæ”¾ï¼Œä½†æ˜¯çˆ¶è¿›ç¨‹å¾—ä¸åˆ°å­è¿›ç¨‹è¢«é‡Šæ”¾çš„ä¿¡æ¯</li>
<li>ä½¿ç”¨waitæˆ–waitpid å¦‚å›¾ï¼š<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-67.png" alt="Alt text"></li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-68.png" alt="Alt text"><br>
3. å¦‚æœçˆ¶è¿›ç¨‹å¾ˆå¿™ï¼Œå¯ä»¥æ•è·SIFCHLDä¿¡å·ï¼Œåœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­è°ƒç”¨waitï¼ˆï¼‰/waitpidï¼ˆï¼‰</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-69.png" alt="Alt text"></p>
<h3 id="å¤šè¿›ç¨‹ä¸ä¿¡å·">å¤šè¿›ç¨‹ä¸ä¿¡å·</h3>
<ul>
<li>åœ¨å¤šè¿›ç¨‹çš„æœåŠ¡ç¨‹åºä¸­ï¼Œå¦‚æœå­è¿›ç¨‹æ”¶åˆ°é€€å‡ºä¿¡å·ï¼Œå­è¿›ç¨‹è‡ªè¡Œé€€å‡ºï¼Œå¦‚æœçˆ¶è¿›ç¨‹æ”¶åˆ°é€€å‡ºä¿¡å·ï¼Œåº”è¯¥å…ˆå‘æ‰€æœ‰å­è¿›ç¨‹å‘é€é€€å‡ºä¿¡å·ï¼Œå†è‡ªå·±é€€å‡º</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FatherEXIT</span><span class="params">(<span class="type">int</span> sig)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChildEXIT</span><span class="params">(<span class="type">int</span> sig)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// å¿½è§†å…¨éƒ¨çš„ä¿¡å·ï¼Œä¸å¸Œæœ›è¢«æ‰“æ‰°</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">65</span>; i ++) <span class="built_in">signal</span>(i, SIG_IGN);</span><br><span class="line">    <span class="comment">//è®¾ç½®ä¿¡å·ï¼Œåœ¨shellçŠ¶æ€ä¸‹ï¼Œå¯ç”¨kill è¿›ç¨‹å· æˆ–è€… Cirl + c æ­£å¸¸ç»ˆæ­¢è¿™äº›è¿›ç¨‹</span></span><br><span class="line">    <span class="comment">// ä½†è¯·ä¸è¦ç”¨ kill -9 + è¿›ç¨‹å· å¼ºè¡Œç»ˆæ­¢</span></span><br><span class="line">    <span class="built_in">signal</span>(SIGTERM, FatherEXIT); <span class="comment">//15ä¿¡å·,è¿™è¡Œçš„ä»£ç æ„æ€æ˜¯è‡ªå·±è§„å®šä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°</span></span><br><span class="line">    <span class="built_in">signal</span>(SIGINT, FatherEXIT);<span class="comment">// 2ä¿¡å·</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(fork() &gt; <span class="number">0</span>)&#123; <span class="comment">//çˆ¶è¿›ç¨‹æµç¨‹</span></span><br><span class="line">            <span class="built_in">sleep</span>(<span class="number">5</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123; <span class="comment">//å­è¿›ç¨‹æµç¨‹</span></span><br><span class="line">            <span class="built_in">signal</span>(SIGTERM, ChildEXIT);<span class="comment">//è§„å®šä¸€ä¸ªå­è¿›ç¨‹é€€å‡ºä¿¡å·</span></span><br><span class="line">            <span class="built_in">signal</span>(SIGINT, SIG_IGN);<span class="comment">//å­è¿›ç¨‹ä¸éœ€è¦æ•è·SIGINTä¿¡å·</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;å­è¿›ç¨‹&quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">&quot;æ­£åœ¨è¿è¡Œä¸­ã€‚\n&quot;</span>;</span><br><span class="line">                <span class="built_in">sleep</span>(<span class="number">3</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FatherEXIT</span><span class="params">(<span class="type">int</span> sig)</span></span>&#123;</span><br><span class="line">    <span class="comment">// ä»¥ä¸‹ä»£ç æ˜¯ä¸ºäº†é˜²æ­¢ä¿¡å·å¤„ç†å‡½æ•°åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­è¢«ä¿¡å·å†æ¬¡ä¸­æ–­</span></span><br><span class="line">    <span class="built_in">signal</span>(SIGTERM, SIG_IGN);</span><br><span class="line">    <span class="built_in">signal</span>(SIGINT, SIG_IGN);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;çˆ¶è¿›ç¨‹&quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">&quot;æ­£åœ¨é€€å‡º, sig=&quot;</span> &lt;&lt; sig &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">kill</span>(<span class="number">0</span>,SIGTERM);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;å­è¿›ç¨‹&quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">&quot;æ­£åœ¨é‡Šæ”¾çˆ¶è¿›ç¨‹çš„èµ„æºä»¥åŠå…¨å±€èµ„æº&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">// è¿™é‡Œäº›é‡Šæ”¾èµ„æºçš„ä»£ç </span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChildEXIT</span><span class="params">(<span class="type">int</span> sig)</span></span>&#123;</span><br><span class="line">    <span class="comment">// ä»¥ä¸‹ä»£ç æ˜¯ä¸ºäº†é˜²æ­¢ä¿¡å·å¤„ç†å‡½æ•°åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­è¢«ä¿¡å·å†æ¬¡ä¸­æ–­</span></span><br><span class="line">    <span class="built_in">signal</span>(SIGTERM, SIG_IGN);</span><br><span class="line">    <span class="built_in">signal</span>(SIGINT, SIG_IGN);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;å­è¿›ç¨‹&quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">&quot;æ­£åœ¨é€€å‡º, sig=&quot;</span> &lt;&lt; sig &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;å­è¿›ç¨‹&quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">&quot;æ­£åœ¨é‡Šæ”¾å­è¿›ç¨‹çš„èµ„æº&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">// è¿™é‡Œäº›é‡Šæ”¾èµ„æºçš„ä»£ç </span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>); </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å…±äº«å†…å­˜">å…±äº«å†…å­˜</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-70.png" alt="Alt text"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-71.png" alt="Alt text"></p>
<h4 id="shmget-å‡½æ•°">shmget()å‡½æ•°</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-72.png" alt="Alt text"></p>
<ul>
<li>
<p>è¡¥å……è¯´æ˜ï¼šshmget()å‡½æ•°ï¼Œå¦‚æœå…±äº«å†…å­˜ä¸å­˜åœ¨å°±åˆ›å»ºå®ƒï¼Œå¦‚æœæœ‰å°±è¿”å›ä»–çš„IP</p>
</li>
<li>
<p><em><strong>ipcs -m</strong></em> ç”¨æ¥æŸ¥çœ‹å…±äº«å­—æ®µ<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-73.png" alt="Alt text"></p>
</li>
<li>
<p><em><strong>ipcrm -m + shimd</strong></em> ç”¨æ¥åˆ é™¤å…±äº«å†…å­˜<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-74.png" alt="Alt text"></p>
</li>
</ul>
<h4 id="shmat-å‡½æ•°">shmat()å‡½æ•°</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-75.png" alt="Alt text"></p>
<h4 id="shmdt-å‡½æ•°">shmdt()å‡½æ•°</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-76.png" alt="Alt text"></p>
<h4 id="shmctl-å‡½æ•°">shmctl()å‡½æ•°</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-77.png" alt="Alt text"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">node</span>&#123;</span><br><span class="line">    <span class="type">int</span> no;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">51</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ­¥åˆ›å»ºå…±äº«å†…å­˜</span></span><br><span class="line">    <span class="type">int</span> shmid = <span class="built_in">shmget</span>(<span class="number">0x5005</span>, <span class="built_in">sizeof</span>(node), <span class="number">0640</span>|IPC_CREAT);</span><br><span class="line">    <span class="keyword">if</span>(shmid == <span class="number">-1</span>)&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;shgmget(0x5005) failed.\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;shmid=&quot;</span> &lt;&lt; shmid &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">//ç¬¬äºŒæ­¥ï¼šæŠŠå…±äº«å†…å­˜è¿æ¥åˆ°å½“å‰è¿›ç¨‹çš„åœ°å€ç©ºé—´</span></span><br><span class="line">    node *ptr = (node *)<span class="built_in">shmat</span>(shmid,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(ptr == (<span class="type">void</span> *)<span class="number">-1</span>)&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;shmat() failed\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨å…±äº«å†…å­˜ï¼Œå¯¹å…±äº«å†…å­˜è¿›è¡Œè¯»/å†™æ“ä½œ</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;åŸå€¼ï¼šno=&quot;</span> &lt;&lt; ptr-&gt;no &lt;&lt; <span class="string">&quot;,name=&quot;</span> &lt;&lt; ptr-&gt;name &lt;&lt; std::endl;</span><br><span class="line">    ptr-&gt;no = <span class="built_in">atoi</span>(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">strcpy</span>(ptr-&gt;name, argv[<span class="number">2</span>]);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;æ–°å€¼ï¼šno=&quot;</span> &lt;&lt; ptr-&gt;no &lt;&lt; <span class="string">&quot;,name=&quot;</span> &lt;&lt; ptr-&gt;name &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">// ç¬¬å››æ­¥æŠŠå…±äº«å†…å­˜ä»å½“å‰è¿›ç¨‹ä¸­åˆ†ç¦»</span></span><br><span class="line">    <span class="built_in">shmdt</span>(ptr);</span><br><span class="line">    <span class="comment">//ç¬¬äº”æ­¥ï¼šåˆ é™¤å…±äº«è¿›ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">shmctl</span>(shmid, IPC_RMID,<span class="number">0</span>) == <span class="number">-1</span>)&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;shmctl failed\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><em><strong>æ³¨æ„åˆ†é…å…±äº«å†…å­˜çš„æ—¶å€™ä¸èƒ½åˆ†é…å †åŒºï¼Œæ‰€ä»¥åœ¨æ•°æ®ç»“æ„ä¸­çš„stlé‚£äº›éƒ½ä¸èƒ½åˆ†é…</strong></em></li>
</ul>
<h3 id="å¾ªç¯é˜Ÿåˆ—">å¾ªç¯é˜Ÿåˆ—</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-78.png" alt="Alt text"></p>
<h4 id="åŸç†">åŸç†</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-79.png" alt="Alt text"></p>
<p>ç»†èŠ‚ï¼šç”¨æ¥åŠ¨æ€ä½¿ç”¨<br>
<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV11Z4y157RY/?p=22&amp;spm_id_from=pageDriver&amp;vd_source=772b61fb408cdf9169f726ab21790987">https://www.bilibili.com/video/BV11Z4y157RY/?p=22&amp;spm_id_from=pageDriver&amp;vd_source=772b61fb408cdf9169f726ab21790987</a></p>
<h3 id="ä¿¡å·é‡">ä¿¡å·é‡</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-80.png" alt="Alt text"></p>
<ul>
<li>pæ“ä½œwait å°†ä¿¡å·é‡çš„å€¼å‡ä¸€ï¼Œå¦‚æœä¿¡å·é‡çš„å€¼ä¸º0ï¼Œå°†é˜»å¡ç­‰å¾…ï¼ŒçŸ¥é“ä¿¡å·é‡å¤§äº0</li>
<li>Væ“ä½œpost å°†ä¿¡å·é‡çš„å€¼åŠ 1 ä»»ä½•æ—¶å€™éƒ½ä¸ä¼šé˜»å¡</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV11Z4y157RY/?p=23&amp;spm_id_from=pageDriver&amp;vd_source=772b61fb408cdf9169f726ab21790987">https://www.bilibili.com/video/BV11Z4y157RY/?p=23&amp;spm_id_from=pageDriver&amp;vd_source=772b61fb408cdf9169f726ab21790987</a></p>
<h3 id="pthread-çº¿ç¨‹åº“">pthread çº¿ç¨‹åº“</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-81.png" alt="Alt text"></p>
<h2 id="ç¬¬äºŒéƒ¨åˆ†">ç¬¬äºŒéƒ¨åˆ†</h2>
<h3 id="ç¬¬ä¸€ä¸ªç½‘ç»œé€šä¿¡ç¨‹åºæˆ·ç«¯">ç¬¬ä¸€ä¸ªç½‘ç»œé€šä¿¡ç¨‹åºæˆ·ç«¯</h3>
<h3 id="åŸºäºlinuxçš„æ–‡ä»¶æ“ä½œ">åŸºäºlinuxçš„æ–‡ä»¶æ“ä½œ</h3>
<h4 id="æ–‡ä»¶æè¿°ç¬¦çš„åˆ†é…è§„åˆ™">æ–‡ä»¶æè¿°ç¬¦çš„åˆ†é…è§„åˆ™</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-82.png" alt="Alt text"></p>
<ul>
<li>
<p>å…¶åˆ†é…è§„åˆ™æ˜¯æ‰¾åˆ°æœ€å°çš„ï¼Œæ²¡æœ‰è¢«å ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬æŠŠ0ï¼Œ1ï¼Œ2ä¸‰ä¸ªæè¿°ç¬¦å…³æ‰åï¼Œå†æ‰“å¼€æ–‡ä»¶ï¼Œåˆ†é…çš„å°±æ˜¯0ï¼Œå¦‚æœéƒ½ä¸å…³åˆ™åˆ†é…3ï¼Œå…³æ‰0ï¼Œå¯¹åº”å°±ä¸èƒ½è¾“å…¥ï¼Œå…¶ä»–äº¦ç„¶</p>
</li>
<li>
<p>åœ¨Linuxç³»ç»Ÿä¸­ï¼Œæ–‡ä»¶ä¸socketæ²¡æœ‰åŒºåˆ«ï¼Œsocketä¹Ÿä¼šåˆ†é…æ–‡ä»¶æè¿°ç¬¦ç»™ä»–</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-83.png" alt="Alt text"></p>
<ul>
<li><em><strong>linuxåº•å±‚çš„readç³»ç»Ÿè°ƒç”¨å’Œwriteç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿèƒ½ç”¨åœ¨socketä¸­</strong></em></li>
</ul>
<h3 id="socketå‡½æ•°è¯¦è§£">socketå‡½æ•°è¯¦è§£</h3>
<h4 id="åˆ›å»ºsocket">åˆ›å»ºsocket</h4>
<h5 id="å‡½æ•°çš„å£°æ˜">å‡½æ•°çš„å£°æ˜</h5>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-84.png" alt="Alt text"></p>
<ul>
<li>å…¶ä¸­ <em><strong>domain</strong></em> å‚æ•°ç”¨æ¥æŒ‡å®šåè®®å®¶æ—ï¼š<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-86.png" alt="Alt text"><br>
<strong>é‡è¦å‚æ•°</strong> <em><strong>IP_INET</strong></em></li>
</ul>
<h5 id="type-è¡¨ç¤ºæ•°æ®çš„ä¼ è¾“ç±»å‹">type è¡¨ç¤ºæ•°æ®çš„ä¼ è¾“ç±»å‹</h5>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-87.png" alt="Alt text"></p>
<h5 id="protocolåè®®">protocolåè®®</h5>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-88.png" alt="Alt text"></p>
<h5 id="ä¸¤ç§åˆ›å»ºæ–¹å¼">ä¸¤ç§åˆ›å»ºæ–¹å¼</h5>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-89.png" alt="Alt text"></p>
<p><em><strong>å‡ ä¹å…¨éƒ¨çš„ç½‘ç»œç¼–ç¨‹å‡½æ•°å¤±è´¥æ—¶éƒ½ä¼šè¿”å›-1ï¼Œå¹¶ä¸”errnoè¢«è®¾ç½®ï¼Œå•ä¸ªè¿›ç¨‹ä¸­åˆ›å»ºçš„socketæ•°é‡å—ç³»ç»Ÿçš„openfileé™åˆ¶ï¼ˆulimit -aï¼‰</strong></em></p>
<h4 id="ä¸»æœºå­—èŠ‚åºå’Œç½‘ç»œå­—èŠ‚åº">ä¸»æœºå­—èŠ‚åºå’Œç½‘ç»œå­—èŠ‚åº</h4>
<h5 id="å¤§ç«¯åºå’Œå°ç«¯åº">å¤§ç«¯åºå’Œå°ç«¯åº</h5>
<ul>
<li>
<p>å¤§ç«¯åºï¼šä½ä½å­—èŠ‚å­˜æ”¾åœ¨é«˜ä½ï¼Œé«˜ä½å­—èŠ‚å­˜æ”¾åœ¨ä½ä½</p>
</li>
<li>
<p>å°ç«¯åºï¼šåœ°ä½å­—èŠ‚å­˜æ”¾åœ¨åœ°ä½ï¼Œé«˜ä½å­—èŠ‚å­˜æ”¾åœ¨é«˜ä½</p>
</li>
<li>
<p>ä¸¾ä¾‹ï¼š<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-90.png" alt="Alt text"></p>
</li>
<li>
<p>é—®é¢˜ï¼š<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-98.png" alt="Alt text"></p>
</li>
</ul>
<h5 id="ç½‘ç»œå­—èŠ‚åº">ç½‘ç»œå­—èŠ‚åº</h5>
<ul>
<li>ä¸ºäº†è§£å†³ä¸»æœºå­—èŠ‚åºä¸åŒçš„é—®é¢˜ï¼Œå¼•å…¥äº†ç½‘ç»œå­—èŠ‚åºï¼ˆæ˜¯ä¸€ç§å¤§ç«¯åºï¼‰<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-91.png" alt="Alt text">
<ol>
<li>å…¶ä¸­ h è¡¨ç¤ºhostï¼ˆä¸»æœºï¼‰</li>
<li>to è½¬æ¢</li>
<li>n network ç½‘ç»œ</li>
<li>s short äºŒå­—èŠ‚ 16ä½æ•´æ•°</li>
<li>l long å››å­—èŠ‚ 32ä½æ•´æ•°</li>
</ol>
</li>
</ul>
<h5 id="IPåœ°å€å’Œé€šè®¯ç«¯å£">IPåœ°å€å’Œé€šè®¯ç«¯å£</h5>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-92.png" alt="Alt text"></p>
<h5 id="å¦‚ä½•å¤„ç†å¤§å°ç«¯åº">å¦‚ä½•å¤„ç†å¤§å°ç«¯åº</h5>
<ul>
<li>æ•°æ®æ”¶å‘çš„æ—¶å€™æœ‰è‡ªåŠ¨è½¬æ¢ï¼Œåªæœ‰å‘sockaddr_in ç»“æ„ä½“æˆå‘˜å˜é‡å¡«å……æ•°æ®çš„æ—¶å€™æ‰éœ€è¦è€ƒè™‘å­—èŠ‚åºé—®é¢˜</li>
</ul>
<h4 id="ä¸‡æ¶çš„ç»“æ„ä½“">ä¸‡æ¶çš„ç»“æ„ä½“</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-93.png" alt="Alt text"></p>
<h5 id="sockaddrç»“æ„ä½“">sockaddrç»“æ„ä½“</h5>
<ul>
<li>ç”¨æ¥å­˜æ”¾åè®®æ—ï¼Œç«¯å£å’Œåœ°å€ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯å’Œconnect()å‡½æ•°å’Œbindï¼ˆï¼‰å‡½æ•°éœ€è¦è¿™ä¸ªç»“æ„ä½“</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-94.png" alt="Alt text"></p>
<h5 id="sockaddr-inç»“æ„ä½“">sockaddr_inç»“æ„ä½“</h5>
<p>sockaddrç»“æ„ä½“æ˜¯ä¸ºäº†ç»Ÿä¸€æ¥å£å‡½æ•°ï¼Œæ“ä½œèµ·æ¥ä¸æ–¹ä¾¿ï¼Œæ‰€ä»¥åŠ äº†è¿™ä¸ªç­‰ä»·çš„ç»“æ„ä½“</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-95.png" alt="Alt text"><br>
ä¹Ÿå°±æ˜¯è¯´ åè€…çš„ç»“æ„ä½“æ˜¯ä¸ºäº†æ–¹ä¾¿æ“ä½œè€Œè®¾è®¡çš„</p>
<ul>
<li><em><strong>åœ¨ç¨‹åºä¸­æˆ‘ä»¬æ“ä½œçš„æ˜¯sockaddr_inç»“æ„ä½“ï¼Œåœ¨è°ƒç”¨å‡½æ•°çš„æ—¶å€™æˆ‘ä»¬è°ƒç”¨çš„soockaddrç»“æ„ä½“</strong></em></li>
</ul>
<h6 id="ç»†è¯´æ­¤ç»“æ„ä½“å†…éƒ¨çš„ç»†èŠ‚">ç»†è¯´æ­¤ç»“æ„ä½“å†…éƒ¨çš„ç»†èŠ‚</h6>
<ul>
<li>é¦–å…ˆç”±äºå®ƒçš„å¤§å°ä¸sockaddrç›¸åŒæ‰€ä»¥å¯ä»¥å¼ºåˆ¶è½¬æ¢ä¸ºsockaddr<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-96.png" alt="Alt text"></li>
</ul>
<p><em><strong>ä½†æ“ä½œipåœ°å€æˆå‘˜çš„æ—¶å€™ æˆ‘ä»¬è¯¥æ€ä¹ˆåŠï¼Ÿ</strong></em></p>
<h6 id="ä½¿ç”¨gethostbyname-å‡½æ•°">ä½¿ç”¨gethostbyname()å‡½æ•°</h6>
<ul>
<li>å‡½æ•°å£°æ˜ä»¥åŠå…¶è¿”å›ç»“æ„ä½“çš„å†…å®¹å¦‚ä¸‹ï¼š<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-97.png" alt="Alt text"></li>
</ul>
<p>ä¸¾ä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ­¤æ®µä»£ç å°±æ˜¯ä½¿ç”¨gethostbunameå‡½æ•°çš„ä¾‹å­</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">hostent</span>* h;</span><br><span class="line">    <span class="keyword">if</span>((h = <span class="built_in">gethostbyname</span>(argv[<span class="number">1</span>])) == <span class="literal">nullptr</span>)&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;gethostbyname failed.\n&quot;</span>;</span><br><span class="line">        <span class="built_in">close</span>(sockfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;servaddr.sin_addr, h-&gt;h_addr,h-&gt;h_length);</span><br></pre></td></tr></table></figure>
<h6 id="å­—ç¬¦ä¸²IPä¸å¤§ç«¯åºIPçš„è½¬æ¢">å­—ç¬¦ä¸²IPä¸å¤§ç«¯åºIPçš„è½¬æ¢</h6>
<ul>
<li>Cè¯­è¨€æä¾›äº†ä¸€ä¸ªåº“å‡½æ•°ï¼Œç”¨äºå­—ç¬¦ä¸²æ ¼å¼çš„IPå’Œå¤§ç«¯åºIPçš„äº’ç›¸è½¬æ¢ï¼Œç”¨äºç½‘ç»œé€šä¿¡çš„æœåŠ¡ç«¯ç¨‹åºä¸­</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="type">in_addr_t</span>; <span class="comment">//32ä½å¤§ç«¯åºçš„IPçš„å€¼</span></span><br><span class="line"><span class="comment">// æŠŠå­—ç¬¦ä¸²æ ¼å¼çš„IPï¼ˆ192.168.168.1ï¼‰è½¬æ¢ä¸ºå¤§ç«¯åºIPï¼Œè½¬æ¢åIPèµ‹å€¼ç»™sockaddr_in.int_addr.s_addr</span></span><br><span class="line"><span class="function"><span class="type">in_addr_t</span> <span class="title">inet_addr</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* cp)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠŠå­—ç¬¦ä¸²æ ¼å¼IPè½¬æ¢ä¸ºå¤§ç«¯åºIPï¼Œå°†è½¬æ¢åIPå¡«å……ç»™sockaddr_in.int_addr.s_addr</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">inet_ation</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* cp, <span class="keyword">struct</span> in_addr* inp)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠŠå¤§ç«¯åºIPè½¬æ¢ä¸ºå­—ç¬¦ä¸²æ ¼å¼çš„IPï¼Œç”¨äºåœ¨æœåŠ¡å™¨ç«¯ç¨‹åºä¸­è§£æå®¢æˆ·ç«¯çš„IPçš„å€¼</span></span><br><span class="line"><span class="function"><span class="type">char</span> *<span class="title">inet_ntoa</span><span class="params">(<span class="keyword">struct</span> in_addr in)</span></span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>åœ¨å®¢æˆ·ç«¯ç¨‹åºä¸­ä½¿ç”¨æ­¤æ–¹æ³•å°±åªèƒ½æŒ‡å®šipåœ°å€è€Œä¸èƒ½æŒ‡å®šåŸŸåæˆ–è€…ä¸»æœºå·ï¼Œè€Œç”¨gethostbyname æ–¹æ³•å°±è¡Œ</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//è¡¨ç¤ºæ“ä½œç³»ç»Ÿé‡Œçš„æ‰€æœ‰IPéƒ½èƒ½é€šä¿¡</span></span><br><span class="line"><span class="comment">//servaddr.sin_addr.s_addr = inet_addr(&quot;192.168.168.1&quot;); // æŒ‡å®šæœåŠ¡ç«¯ç”¨äºé€šè®¯çš„IP</span></span><br></pre></td></tr></table></figure>
<h3 id="æœªå°è£…çš„å®¢æˆ·ç«¯ä»£ç ">æœªå°è£…çš„å®¢æˆ·ç«¯ä»£ç </h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span><span class="comment">//sockaddr_inéœ€è¦</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span><span class="comment">//hostentéœ€è¦</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">3</span>)&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Using:./client æœåŠ¡ç«¯IPåœ°å€ æœåŠ¡ç«¯çš„ç«¯å£\n Exampleï¼š./client 192.168.168.1 5005\n\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ­¥å»ºç«‹socket</span></span><br><span class="line">    <span class="type">int</span> sockfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);<span class="comment">//  åˆ†åˆ«æŒ‡å®šIPV4åè®®æ—ï¼Œé¢å‘æœ‰é“¾æ¥çš„ï¼Œå¦‚æœæ˜¯ 0 çš„è¯ï¼Œä½ ä¸å¿…è‡ªå·±æŒ‡å®šåè®®ï¼Œè€Œç”±æœåŠ¡æä¾›è€…ä¸ºä½ é€‰æ‹©åˆé€‚çš„åè®®ç±»å‹ï¼ˆæˆ–è€…å†™tcpåè®®å¯¹åº”ç¼–å·ï¼‰</span></span><br><span class="line">    std::cout &lt;&lt; sockfd &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">if</span>(sockfd == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç¬¬äºŒæ­¥å‘æœåŠ¡å™¨å‘é€é“¾æ¥è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> servaddr;<span class="comment">//ç”¨äºå­˜æ”¾åè®®ï¼ŒIPåœ°å€å’Œç«¯å£çš„ç»“æ„ä½“</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in">sizeof</span>(servaddr));</span><br><span class="line">    servaddr.sin_family = AF_INET; <span class="comment">// åè®®æ—</span></span><br><span class="line">    servaddr.sin_port = <span class="built_in">htons</span>(<span class="built_in">atoi</span>(argv[<span class="number">2</span>])); <span class="comment">// æŒ‡å®šæœåŠ¡ç«¯çš„é€šä¿¡ç«¯å£</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">hostent</span>* h;</span><br><span class="line">    <span class="keyword">if</span>((h = <span class="built_in">gethostbyname</span>(argv[<span class="number">1</span>])) == <span class="literal">nullptr</span>)&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;gethostbyname failed.\n&quot;</span>;</span><br><span class="line">        <span class="built_in">close</span>(sockfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;servaddr.sin_addr, h-&gt;h_addr,h-&gt;h_length);<span class="comment">//æŒ‡å®šæœåŠ¡ç«¯çš„é€šè®¯IP</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">connect</span>(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;servaddr, <span class="built_in">sizeof</span>(servaddr)) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(sockfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ç¬¬ä¸‰æ­¥ ä¸æœåŠ¡ç«¯é€šä¿¡ï¼Œå‘é€ä¸€ä¸ªè¯·æ±‚æŠ¥æ–‡åç­‰å¾…æœåŠ¡ç«¯çš„å›å¤ï¼Œæ”¶åˆ°ä¸‹ä¸€ä¸ªå›å¤åï¼Œå†å‘ä¸‹ä¸€ä¸ªè¯·æ±‚æŠ¥æ–‡</span></span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i ++)&#123;</span><br><span class="line">        <span class="type">int</span> iret;</span><br><span class="line">        <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line">        <span class="built_in">sprintf</span>(buffer, <span class="string">&quot;è¿™æ˜¯ç¬¬%dä¸ªæ™ºé­ï¼Œç¼–å·%03dã€‚&quot;</span>, i + <span class="number">1</span>, i + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(iret = <span class="built_in">send</span>(sockfd,buffer,<span class="built_in">sizeof</span>(buffer), <span class="number">0</span>) &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;å‘é€&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;å‘é€&quot;</span> &lt;&lt; buffer &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line">        <span class="comment">// æ¥æ”¶æœåŠ¡ç«¯çš„å›åº”æŠ¥æ–‡ï¼Œå¦‚æœæ²¡æœ‰å›åº”æŠ¥æ–‡ï¼Œrecvï¼ˆï¼‰å‡½æ•°å°†é˜»å¡ç­‰å¾…ã€‚</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">recv</span>(sockfd, buffer, <span class="built_in">sizeof</span>(buffer), <span class="number">0</span>) &lt;= <span class="number">0</span>)&#123;<span class="comment">//æ¥æ”¶å‡½æ•°å­˜å…¥buffer</span></span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;iret=&quot;</span> &lt;&lt; iret &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;æ¥æ”¶&quot;</span> &lt;&lt; buffer &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç¬¬å››æ­¥ å…³é—­socket</span></span><br><span class="line">    <span class="built_in">close</span>(sockfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æœªå°è£…çš„æœåŠ¡ç«¯ä»£ç ">æœªå°è£…çš„æœåŠ¡ç«¯ä»£ç </h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span><span class="comment">//sockaddr_inéœ€è¦</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span><span class="comment">//hostentéœ€è¦</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">2</span>)&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Using:./server é€šè®¯ç«¯å£\n Exampleï¼š./server 5005\n\n&quot;</span>;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;æ³¨æ„ï¼šè¿è¡ŒæœåŠ¡ç«¯çš„ç¨‹åºLinuxç³»ç»Ÿçš„é˜²ç«å¢™å¿…é¡»è¦å¼€é€š5005ç«¯å£\n&quot;</span>;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;å¦‚æœæ˜¯äº‘æœåŠ¡å™¨ï¼Œè¿˜æœ‰å¼€é€šäº‘å¹³å°çš„è®¿é—®ç­–ç•¥&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ­¥å»ºç«‹æœåŠ¡ç«¯çš„socket</span></span><br><span class="line">    <span class="type">int</span> listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(listenfd == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç¬¬äºŒéƒ¨ç”¨bindç»‘å®šipåœ°å€å’Œç«¯å£åˆ°socketä¸Š</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> servaddr;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in">sizeof</span>(servaddr));</span><br><span class="line">    servaddr.sin_family = AF_INET;<span class="comment">//å›ºå®šå¡«AF_INET</span></span><br><span class="line">    servaddr.sin_port = <span class="built_in">htons</span>(<span class="built_in">atoi</span>(argv[<span class="number">1</span>]));</span><br><span class="line">    servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//è¡¨ç¤ºæ“ä½œç³»ç»Ÿé‡Œçš„æ‰€æœ‰IPéƒ½èƒ½é€šä¿¡</span></span><br><span class="line">    <span class="comment">//servaddr.sin_addr.s_addr = inet_addr(&quot;192.168.168.1&quot;); // æŒ‡å®šæœåŠ¡ç«¯ç”¨äºé€šè®¯çš„IP</span></span><br><span class="line">    <span class="comment">//ç»‘å®šæœåŠ¡å™¨çš„IPå’Œç«¯å£</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd,(sockaddr *)&amp;servaddr, <span class="built_in">sizeof</span>(servaddr)) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç¬¬ä¸‰æ­¥æ‰“å¼€socketç›‘å¬çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">listen</span>(listenfd,<span class="number">5</span>) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç¬¬å››æ­¥ï¼šå—ç†å®¢æˆ·ç«¯çš„é“¾æ¥è¯·æ±‚ï¼Œå¦‚æœæ²¡æœ‰å®¢æˆ·ç«¯ç»ƒä¸Šæ¥ï¼Œacceptï¼ˆï¼‰å°†é˜»å¡ç­‰å¾…</span></span><br><span class="line">    <span class="comment">//acceptåé¢ä¸¤ä¸ªå‚æ•°ä¸€ä¸ªæ˜¯åœ°å€ä¿¡æ¯ï¼Œä¸€ä¸ªæ˜¯åœ°å€ç»“æ„ä½“å¤§å°ï¼Œä¸¤ä¸ªéƒ½å¡«0è¡¨ç¤ºä¸å…³å¿ƒåœ°å€ä¿¡æ¯</span></span><br><span class="line">    <span class="type">int</span> clientfd = <span class="built_in">accept</span>(listenfd, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(clientfd == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;accept&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;å®¢æˆ·ç«¯å·²è¿æ¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ç¬¬äº”æ­¥ï¼šæ¥æ”¶å®¢æˆ·ç«¯å‘æ¥çš„ä¿¡æ¯ï¼Œå¹¶å‘é€å›åº”æŠ¥æ–‡</span></span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="type">int</span> iret;</span><br><span class="line">        <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line">        <span class="comment">//æ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œæ²¡æœ‰å“¦è¯·æ±‚å°±é˜»å¡recv()ç­‰å¾…</span></span><br><span class="line">        <span class="comment">//å¦‚æœå®¢æˆ·ç«¯å·²æ–­å¼€è¿æ¥ï¼Œrecvå‡½æ•°å°†è¿”å›0</span></span><br><span class="line">        <span class="keyword">if</span>((iret = <span class="built_in">recv</span>(clientfd, buffer, <span class="built_in">sizeof</span>(buffer), <span class="number">0</span>)) &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">           std::cout &lt;&lt; <span class="string">&quot;iret= &quot;</span> &lt;&lt; iret &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;æ¥æ”¶&quot;</span> &lt;&lt; buffer &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">strcpy</span>(buffer, <span class="string">&quot;ok&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>((iret = <span class="built_in">send</span>(clientfd, buffer, <span class="built_in">sizeof</span>(buffer), <span class="number">0</span>) &lt;= <span class="number">0</span>))&#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;send&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;å‘é€ï¼š&quot;</span> &lt;&lt; buffer &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…³é—­socket é‡Šæ”¾èµ„æº</span></span><br><span class="line">    <span class="built_in">close</span>(listenfd);</span><br><span class="line">    <span class="built_in">close</span>(clientfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å°è£…çš„å®¢æˆ·ç«¯ä»£ç ">å°è£…çš„å®¢æˆ·ç«¯ä»£ç </h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span><span class="comment">//sockaddr_inéœ€è¦</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span><span class="comment">//hostentéœ€è¦</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ctcpclient</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> m_clientfd; <span class="comment">// å®¢æˆ·ç«¯çš„socketï¼Œ-1è¡¨ç¤ºæœªè¿æ¥æˆ–è¿æ¥å·²æ–­å¼€ï¼Œ&gt;=0 è¡¨ç¤ºæœ‰æ•ˆçš„socket</span></span><br><span class="line">    std::string m_ip; <span class="comment">// æœåŠ¡å™¨çš„IP/åŸŸå</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> m_port; <span class="comment">// é€šè®¯ç«¯å£</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å‘æœåŠ¡ç«¯å‘èµ·è¿æ¥è¯·æ±‚ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥false</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">connect</span><span class="params">(<span class="type">const</span> std::string&amp; in_ip, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">short</span> in_port)</span></span>&#123;</span><br><span class="line">        <span class="comment">// å»ºç«‹å¥—æ¥å­—</span></span><br><span class="line">        m_clientfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(m_clientfd == <span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å‘æœåŠ¡ç«¯å‘é€è¿æ¥è¯·æ±‚</span></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> servaddr;</span><br><span class="line">        m_ip = in_ip;</span><br><span class="line">        m_port = in_port;</span><br><span class="line">        servaddr.sin_family = AF_INET;</span><br><span class="line">        servaddr.sin_port = <span class="built_in">htons</span>(m_port);</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">hostent</span>* h;</span><br><span class="line">        <span class="keyword">if</span>((h = <span class="built_in">gethostbyname</span>(m_ip.<span class="built_in">c_str</span>())) == <span class="literal">nullptr</span>)&#123;</span><br><span class="line">            <span class="built_in">close</span>();</span><br><span class="line">            m_clientfd = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;servaddr.sin_addr, h-&gt;h_addr, h-&gt;h_length);</span><br><span class="line">        <span class="comment">// ä»¥ä¸‹é”™è¯¯å¸¸çŠ¯ï¼Œæ³¨æ„å½“ä½ æƒ³ä½¿ç”¨å…¨å±€å‡½æ•°æˆ–è€…å…¨å±€åŒåå˜é‡çš„æ—¶å€™ è¦åœ¨å‰é¢+::</span></span><br><span class="line">        <span class="keyword">if</span>(::<span class="built_in">connect</span>(m_clientfd, (<span class="keyword">struct</span> sockaddr *) &amp;servaddr, <span class="built_in">sizeof</span>(servaddr)) == <span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="built_in">close</span>();</span><br><span class="line">            m_clientfd = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¸ºä»€ä¹ˆä¸ç”¨const char * å› ä¸ºconst char * æ— æ³•æ”¯æŒstring,è€Œä¸‹åˆ—å¯ä»¥æ”¯æŒä»const char *</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">send</span><span class="params">(<span class="type">const</span> std::string&amp; buffer)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(m_clientfd == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">//ä¸€å®šä¸è¦å¿˜äº†::</span></span><br><span class="line">        <span class="keyword">if</span>(::<span class="built_in">send</span>(m_clientfd, buffer.<span class="built_in">data</span>(), buffer.<span class="built_in">size</span>(), <span class="number">0</span>) &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¥æ”¶æœåŠ¡ç«¯çš„æŠ¥æ–‡ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false</span></span><br><span class="line">    <span class="comment">//bufferå­˜æ”¾æ¥æ”¶åˆ°çš„æŠ¥æ–‡å†…å®¹ï¼Œmaxlenæœ¬æ¬¡æ¥æ”¶æŠ¥æ–‡çš„é•¿åº¦</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">recv</span><span class="params">(std::string&amp; buffer,<span class="type">const</span> <span class="type">size_t</span> maxlen)</span></span>&#123;</span><br><span class="line">        <span class="comment">//å¦‚æœç›´æ¥æ“ä½œstringå¯¹è±¡çš„å†…å­˜ï¼Œå¿…é¡»ä¿è¯1ï¼‰ä¸èƒ½è¶Šç•Œï¼Œ2ï¼‰æ“ä½œåæ‰‹åŠ¨è®¾ç½®æ•°æ®å¤§å°</span></span><br><span class="line">        buffer.<span class="built_in">clear</span>();</span><br><span class="line">        buffer.<span class="built_in">resize</span>(maxlen);</span><br><span class="line">        <span class="type">int</span> readn=::<span class="built_in">recv</span>(m_clientfd, &amp;buffer[<span class="number">0</span>], buffer.<span class="built_in">size</span>(), <span class="number">0</span>);</span><br><span class="line">        <span class="comment">//-1è¡¨ç¤ºå¤±è´¥ï¼Œ0è¡¨ç¤ºæ–­å¼€è¿æ¥ï¼ŒæˆåŠŸæ”¾å›æ•°æ®å¤§å°</span></span><br><span class="line">        <span class="keyword">if</span>(readn &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            buffer.<span class="built_in">clear</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        buffer.<span class="built_in">resize</span>(readn); <span class="comment">//é‡ç½®bufferçš„å®é™…å¤§å°</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">close</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(m_clientfd == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        ::<span class="built_in">close</span>(m_clientfd);</span><br><span class="line">        m_clientfd = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ctcpclient</span>():<span class="built_in">m_clientfd</span>(<span class="number">-1</span>)&#123;&#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">ctcpclient</span>()&#123;<span class="built_in">close</span>();&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">3</span>)&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Using:./client æœåŠ¡ç«¯IPåœ°å€ æœåŠ¡ç«¯çš„ç«¯å£\n Exampleï¼š./client 192.168.168.1 5005\n\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ctcpclient tcpclient;</span><br><span class="line">    <span class="keyword">if</span>(!tcpclient.<span class="built_in">connect</span>(argv[<span class="number">1</span>], <span class="built_in">atoi</span>(argv[<span class="number">2</span>])))&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç¬¬ä¸‰æ­¥ ä¸æœåŠ¡ç«¯é€šä¿¡ï¼Œå‘é€ä¸€ä¸ªè¯·æ±‚æŠ¥æ–‡åç­‰å¾…æœåŠ¡ç«¯çš„å›å¤ï¼Œæ”¶åˆ°ä¸‹ä¸€ä¸ªå›å¤åï¼Œå†å‘ä¸‹ä¸€ä¸ªè¯·æ±‚æŠ¥æ–‡</span></span><br><span class="line">    std::string buffer;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i ++)&#123;</span><br><span class="line">        buffer = <span class="string">&quot;è¿™æ˜¯ç¬¬&quot;</span> + std::<span class="built_in">to_string</span>(i + <span class="number">1</span>) + <span class="string">&quot;ä¸ªå°æ™ºé­, ç¼–å·&quot;</span> + std::<span class="built_in">to_string</span>(i + <span class="number">1</span>) + <span class="string">&quot;ã€‚&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(!tcpclient.<span class="built_in">send</span>(buffer))&#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;å‘é€&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;å‘é€:&quot;</span> &lt;&lt; buffer &lt;&lt; std::endl;</span><br><span class="line">        <span class="comment">// æ¥æ”¶æœåŠ¡ç«¯çš„å›åº”æŠ¥æ–‡ï¼Œå¦‚æœæ²¡æœ‰å›åº”æŠ¥æ–‡ï¼Œrecvï¼ˆï¼‰å‡½æ•°å°†é˜»å¡ç­‰å¾…ã€‚</span></span><br><span class="line">        <span class="keyword">if</span>(!tcpclient.<span class="built_in">recv</span>(buffer, <span class="number">1024</span>))&#123;<span class="comment">//æ¥æ”¶å‡½æ•°å­˜å…¥buffer</span></span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;recv&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;æ¥æ”¶:&quot;</span> &lt;&lt; buffer &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç¬¬å››æ­¥ å…³é—­socket</span></span><br><span class="line">    tcpclient.<span class="built_in">close</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å°è£…socketçš„æœåŠ¡ç«¯">å°è£…socketçš„æœåŠ¡ç«¯</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span><span class="comment">//sockaddr_inéœ€è¦</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span><span class="comment">//hostentéœ€è¦</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// acceptçš„è¿‡ç¨‹ç†è§£ä¸ºå—ç†å®¢æˆ·ç«¯çš„é“¾æ¥(ä»å·²è¿æ¥çš„å®¢æˆ·ç«¯ä¸­å–å‡ºä¸€ä¸ªå®¢æˆ·ç«¯)ï¼Œä¸€ä¸ªæœåŠ¡ç«¯å¯ä»¥å’Œå¾ˆå¤šå®¢æˆ·ç«¯é€šä¿¡</span></span><br><span class="line"><span class="comment">//å¦‚æœæ²¡æœ‰å·²è¿æ¥çš„å®¢æˆ·ç«¯ï¼Œacceptå°†é˜»å¡</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ctcpserver</span>&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> m_listenfd; <span class="comment">//ç›‘å¬çš„socketï¼Œ-1è¡¨ç¤ºæœªåˆå§‹åŒ–</span></span><br><span class="line">    <span class="type">int</span> m_clientfd; <span class="comment">//å®¢æˆ·ç«¯ç»ƒä¸Šæ¥çš„socketï¼Œ-1è¡¨ç¤ºæœªåˆå§‹åŒ–</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> m_port;<span class="comment">//æœåŠ¡å™¨ç”¨äºé€šä¿¡çš„ç«¯å£</span></span><br><span class="line">    std::string m_clientip; <span class="comment">//å®¢æˆ·ç«¯çš„IP</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ctcpserver</span>():<span class="built_in">m_clientfd</span>(<span class="number">-1</span>), <span class="built_in">m_listenfd</span>(<span class="number">-1</span>)&#123;&#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºç›‘å¬socket,å¹¶åˆå§‹åŒ–å®ƒ</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">initserver</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">short</span> in_port)</span></span>&#123;</span><br><span class="line">        <span class="comment">//ç¬¬ä¸€æ­¥åˆ›å»ºsocket</span></span><br><span class="line">        <span class="keyword">if</span>((m_listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// ç¬¬äºŒéƒ¨ å°†ipåœ°å€å’Œç«¯å£ç»‘åœ¨socketä¸Š</span></span><br><span class="line">        m_port = in_port;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> servaddr;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in">sizeof</span>(servaddr));</span><br><span class="line">        servaddr.sin_family = AF_INET;</span><br><span class="line">        servaddr.sin_port = <span class="built_in">htons</span>(m_port);</span><br><span class="line">        servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">bind</span>(m_listenfd, (<span class="type">const</span> sockaddr *)&amp;servaddr, <span class="built_in">sizeof</span>(servaddr)) == <span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="built_in">close</span>(m_listenfd);</span><br><span class="line">            m_listenfd = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç¬¬ä¸‰æ­¥æ‰“å¼€ç›‘å¬çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">listen</span>(m_listenfd, <span class="number">5</span>) == <span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="built_in">close</span>(m_listenfd);</span><br><span class="line">            m_listenfd = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">accept</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> caddr; <span class="comment">// å®¢æˆ·ç«¯çš„åœ°å€ä¿¡æ¯</span></span><br><span class="line">        <span class="type">socklen_t</span> addrlen = <span class="built_in">sizeof</span>(caddr); <span class="comment">// ä¸Šé¢çš„å¤§å°</span></span><br><span class="line">        <span class="comment">//accept,ä¸‰ä¸ªå‚æ•°ç¬¬ä¸€ä¸ªä¸ºç›‘å¬socketçš„fdå€¼ï¼Œç¬¬äºŒä¸ªä¸ºipåœ°å€çš„åœ°å€ï¼Œç¬¬ä¸‰ä¸ªä¸ºipåœ°å€å¤§å°çš„åœ°å€</span></span><br><span class="line">        <span class="keyword">if</span>((m_clientfd = ::<span class="built_in">accept</span>(m_listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;caddr, &amp;addrlen)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        m_clientip = <span class="built_in">inet_ntoa</span>(caddr.sin_addr); <span class="comment">//æŠŠå®¢æˆ·ç«¯çš„åœ°å€ä»å¤§ç«¯åºè½¬æ¢æˆå­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="keyword">return</span> truei;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string &amp; <span class="title">clientip</span><span class="params">()</span> <span class="type">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> m_clientip;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">send</span><span class="params">(<span class="type">const</span> std::string&amp; buffer)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(m_clientfd == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span>((::<span class="built_in">send</span>(m_clientfd, buffer.<span class="built_in">data</span>(), buffer.<span class="built_in">size</span>(), <span class="number">0</span>)) &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">recv</span><span class="params">(std::string &amp;buffer, <span class="type">const</span> <span class="type">size_t</span> maxlen)</span></span>&#123;</span><br><span class="line">        buffer.<span class="built_in">clear</span>();  <span class="comment">//æ¸…ç©ºå†…å­˜</span></span><br><span class="line">        buffer.<span class="built_in">resize</span>(maxlen); <span class="comment">//è®¾ç½®å®¹å™¨å¤§å°ä¸ºmaxlen</span></span><br><span class="line">        <span class="type">int</span> readn = ::<span class="built_in">recv</span>(m_clientfd, &amp;buffer[<span class="number">0</span>], buffer.<span class="built_in">size</span>(), <span class="number">0</span>); <span class="comment">//ç›´æ¥æ“ä½œbufferçš„å†…å­˜</span></span><br><span class="line">        <span class="keyword">if</span>(readn &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            buffer.<span class="built_in">clear</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        buffer.<span class="built_in">resize</span>(readn);<span class="comment">//é‡ç½®å¤§å°</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä»¥ä¸‹è¦åˆ†å¼€ä¸¤ä¸ªæˆå‘˜å‡½æ•° ä¸èƒ½å†™åœ¨ä¸€ä¸ªå‡½æ•°é‡Œé¢</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">closelisten</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(m_listenfd == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        ::<span class="built_in">close</span>(m_listenfd);</span><br><span class="line">        m_listenfd = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">closeclient</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(m_clientfd == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        ::<span class="built_in">close</span>(m_clientfd);</span><br><span class="line">        m_clientfd = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…³é—­socketèµ„æº</span></span><br><span class="line">    ~<span class="built_in">ctcpserver</span>()&#123;</span><br><span class="line">        <span class="built_in">closelisten</span>();</span><br><span class="line">        <span class="built_in">closeclient</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">2</span>)&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Using:./server é€šè®¯ç«¯å£\n Exampleï¼š./server 5005\n\n&quot;</span>;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;æ³¨æ„ï¼šè¿è¡ŒæœåŠ¡ç«¯çš„ç¨‹åºLinuxç³»ç»Ÿçš„é˜²ç«å¢™å¿…é¡»è¦å¼€é€š5005ç«¯å£\n&quot;</span>;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;å¦‚æœæ˜¯äº‘æœåŠ¡å™¨ï¼Œè¿˜æœ‰å¼€é€šäº‘å¹³å°çš„è®¿é—®ç­–ç•¥&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ctcpserver tcpserver;</span><br><span class="line">    <span class="keyword">if</span>(!tcpserver.<span class="built_in">initserver</span>(<span class="built_in">atoi</span>(argv[<span class="number">1</span>])))&#123;<span class="comment">// åˆå§‹åŒ–æœåŠ¡ç«¯ç”¨äºç›‘å¬çš„socket</span></span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;initserver&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">//ç¬¬å››æ­¥ï¼šå—ç†å®¢æˆ·ç«¯çš„é“¾æ¥è¯·æ±‚ï¼Œå¦‚æœæ²¡æœ‰å®¢æˆ·ç«¯ç»ƒä¸Šæ¥ï¼Œacceptï¼ˆï¼‰å°†é˜»å¡ç­‰å¾…</span></span><br><span class="line">    <span class="keyword">if</span>(!tcpserver.<span class="built_in">accept</span>())&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;accept&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;å®¢æˆ·ç«¯å·²è¿æ¥( &quot;</span> &lt;&lt; tcpserver.<span class="built_in">clientip</span>() &lt;&lt; <span class="string">&quot;)ã€‚\n&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ç¬¬äº”æ­¥ï¼šæ¥æ”¶å®¢æˆ·ç«¯å‘æ¥çš„ä¿¡æ¯ï¼Œå¹¶å‘é€å›åº”æŠ¥æ–‡</span></span><br><span class="line">    std::string buffer;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//æ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œæ²¡æœ‰å“¦è¯·æ±‚å°±é˜»å¡recv()ç­‰å¾…</span></span><br><span class="line">        <span class="comment">//å¦‚æœå®¢æˆ·ç«¯å·²æ–­å¼€è¿æ¥ï¼Œrecvå‡½æ•°å°†è¿”å›0</span></span><br><span class="line">        <span class="keyword">if</span>(!tcpserver.<span class="built_in">recv</span>(buffer, <span class="number">1024</span>))&#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;recv&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;æ¥æ”¶&quot;</span> &lt;&lt; buffer &lt;&lt; std::endl;</span><br><span class="line">        </span><br><span class="line">        buffer = <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(!tcpserver.<span class="built_in">send</span>(buffer))&#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;send&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;å‘é€ï¼š&quot;</span> &lt;&lt; buffer &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¤šè¿›ç¨‹çš„æœåŠ¡ç«¯ä»£ç ">å¤šè¿›ç¨‹çš„æœåŠ¡ç«¯ä»£ç </h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    ç¨‹åºå:server2.cpp æ˜¯ç”¨æ¥æ¼”ç¤ºå¤šè¿›ç¨‹çš„socketæœåŠ¡ç«¯</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span><span class="comment">//sockaddr_inéœ€è¦</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span><span class="comment">//hostentéœ€è¦</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FatherEXIT</span><span class="params">(<span class="type">int</span> sig)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChildEXIT</span><span class="params">(<span class="type">int</span> sig)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// acceptçš„è¿‡ç¨‹ç†è§£ä¸ºå—ç†å®¢æˆ·ç«¯çš„é“¾æ¥(ä»å·²è¿æ¥çš„å®¢æˆ·ç«¯ä¸­å–å‡ºä¸€ä¸ªå®¢æˆ·ç«¯)ï¼Œä¸€ä¸ªæœåŠ¡ç«¯å¯ä»¥å’Œå¾ˆå¤šå®¢æˆ·ç«¯é€šä¿¡</span></span><br><span class="line"><span class="comment">//å¦‚æœæ²¡æœ‰å·²è¿æ¥çš„å®¢æˆ·ç«¯ï¼Œacceptå°†é˜»å¡</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ctcpserver</span>&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> m_listenfd; <span class="comment">//ç›‘å¬çš„socketï¼Œ-1è¡¨ç¤ºæœªåˆå§‹åŒ–</span></span><br><span class="line">    <span class="type">int</span> m_clientfd; <span class="comment">//å®¢æˆ·ç«¯ç»ƒä¸Šæ¥çš„socketï¼Œ-1è¡¨ç¤ºæœªåˆå§‹åŒ–</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> m_port;<span class="comment">//æœåŠ¡å™¨ç”¨äºé€šä¿¡çš„ç«¯å£</span></span><br><span class="line">    std::string m_clientip; <span class="comment">//å®¢æˆ·ç«¯çš„IP</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ctcpserver</span>():<span class="built_in">m_clientfd</span>(<span class="number">-1</span>), <span class="built_in">m_listenfd</span>(<span class="number">-1</span>)&#123;&#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºç›‘å¬socket,å¹¶åˆå§‹åŒ–å®ƒ</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">initserver</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">short</span> in_port)</span></span>&#123;</span><br><span class="line">        <span class="comment">//ç¬¬ä¸€æ­¥åˆ›å»ºsocket</span></span><br><span class="line">        <span class="keyword">if</span>((m_listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// ç¬¬äºŒéƒ¨ å°†ipåœ°å€å’Œç«¯å£ç»‘åœ¨socketä¸Š</span></span><br><span class="line">        m_port = in_port;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> servaddr;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in">sizeof</span>(servaddr));</span><br><span class="line">        servaddr.sin_family = AF_INET;</span><br><span class="line">        servaddr.sin_port = <span class="built_in">htons</span>(m_port);</span><br><span class="line">        servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">bind</span>(m_listenfd, (<span class="type">const</span> sockaddr *)&amp;servaddr, <span class="built_in">sizeof</span>(servaddr)) == <span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="built_in">close</span>(m_listenfd);</span><br><span class="line">            m_listenfd = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç¬¬ä¸‰æ­¥æ‰“å¼€ç›‘å¬çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">listen</span>(m_listenfd, <span class="number">5</span>) == <span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="built_in">close</span>(m_listenfd);</span><br><span class="line">            m_listenfd = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">accept</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> caddr; <span class="comment">// å®¢æˆ·ç«¯çš„åœ°å€ä¿¡æ¯</span></span><br><span class="line">        <span class="type">socklen_t</span> addrlen = <span class="built_in">sizeof</span>(caddr); <span class="comment">// ä¸Šé¢çš„å¤§å°</span></span><br><span class="line">        <span class="comment">//accept,ä¸‰ä¸ªå‚æ•°ç¬¬ä¸€ä¸ªä¸ºç›‘å¬socketçš„fdå€¼ï¼Œç¬¬äºŒä¸ªä¸ºipåœ°å€çš„åœ°å€ï¼Œç¬¬ä¸‰ä¸ªä¸ºipåœ°å€å¤§å°çš„åœ°å€</span></span><br><span class="line">        <span class="keyword">if</span>((m_clientfd = ::<span class="built_in">accept</span>(m_listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;caddr, &amp;addrlen)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        m_clientip = <span class="built_in">inet_ntoa</span>(caddr.sin_addr); <span class="comment">//æŠŠå®¢æˆ·ç«¯çš„åœ°å€ä»å¤§ç«¯åºè½¬æ¢æˆå­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string &amp; <span class="title">clientip</span><span class="params">()</span> <span class="type">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> m_clientip;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">send</span><span class="params">(<span class="type">const</span> std::string&amp; buffer)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(m_clientfd == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span>((::<span class="built_in">send</span>(m_clientfd, buffer.<span class="built_in">data</span>(), buffer.<span class="built_in">size</span>(), <span class="number">0</span>)) &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">recv</span><span class="params">(std::string &amp;buffer, <span class="type">const</span> <span class="type">size_t</span> maxlen)</span></span>&#123;</span><br><span class="line">        buffer.<span class="built_in">clear</span>();  <span class="comment">//æ¸…ç©ºå†…å­˜</span></span><br><span class="line">        buffer.<span class="built_in">resize</span>(maxlen); <span class="comment">//è®¾ç½®å®¹å™¨å¤§å°ä¸ºmaxlen</span></span><br><span class="line">        <span class="type">int</span> readn = ::<span class="built_in">recv</span>(m_clientfd, &amp;buffer[<span class="number">0</span>], buffer.<span class="built_in">size</span>(), <span class="number">0</span>); <span class="comment">//ç›´æ¥æ“ä½œbufferçš„å†…å­˜</span></span><br><span class="line">        <span class="keyword">if</span>(readn &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            buffer.<span class="built_in">clear</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        buffer.<span class="built_in">resize</span>(readn);<span class="comment">//é‡ç½®å¤§å°</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä»¥ä¸‹è¦åˆ†å¼€ä¸¤ä¸ªæˆå‘˜å‡½æ•° ä¸èƒ½å†™åœ¨ä¸€ä¸ªå‡½æ•°é‡Œé¢</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">closelisten</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(m_listenfd == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        ::<span class="built_in">close</span>(m_listenfd);</span><br><span class="line">        m_listenfd = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">closeclient</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(m_clientfd == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        ::<span class="built_in">close</span>(m_clientfd);</span><br><span class="line">        m_clientfd = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…³é—­socketèµ„æº</span></span><br><span class="line">    ~<span class="built_in">ctcpserver</span>()&#123;</span><br><span class="line">        <span class="built_in">closelisten</span>();</span><br><span class="line">        <span class="built_in">closeclient</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ctcpserver tcpserver;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">2</span>)&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Using:./server é€šè®¯ç«¯å£\n Exampleï¼š./server 5005\n\n&quot;</span>;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;æ³¨æ„ï¼šè¿è¡ŒæœåŠ¡ç«¯çš„ç¨‹åºLinuxç³»ç»Ÿçš„é˜²ç«å¢™å¿…é¡»è¦å¼€é€š5005ç«¯å£\n&quot;</span>;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;å¦‚æœæ˜¯äº‘æœåŠ¡å™¨ï¼Œè¿˜æœ‰å¼€é€šäº‘å¹³å°çš„è®¿é—®ç­–ç•¥&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¿½è§†å…¨éƒ¨çš„ä¿¡å·ï¼Œä¸å¸Œæœ›è¢«æ‰“æ‰°ï¼Œé¡ºä¾¿è§£å†³äº†åƒµå°¸è¿›ç¨‹çš„é—®é¢˜</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">65</span>; i ++) <span class="built_in">signal</span>(i, SIG_IGN);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®ä¿¡å·ï¼Œåœ¨shellçŠ¶æ€ä¸‹ï¼Œå¯ç”¨kill è¿›ç¨‹å· æˆ–è€… Cirl + c æ­£å¸¸ç»ˆæ­¢è¿™äº›è¿›ç¨‹</span></span><br><span class="line">    <span class="comment">// ä½†è¯·ä¸è¦ç”¨ kill -9 + è¿›ç¨‹å· å¼ºè¡Œç»ˆæ­¢</span></span><br><span class="line">    <span class="built_in">signal</span>(SIGTERM, FatherEXIT); <span class="comment">//15ä¿¡å·,è¿™è¡Œçš„ä»£ç æ„æ€æ˜¯è‡ªå·±è§„å®šä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°</span></span><br><span class="line">    <span class="built_in">signal</span>(SIGINT, FatherEXIT);<span class="comment">// 2ä¿¡å·</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!tcpserver.<span class="built_in">initserver</span>(<span class="built_in">atoi</span>(argv[<span class="number">1</span>])))&#123;<span class="comment">// åˆå§‹åŒ–æœåŠ¡ç«¯ç”¨äºç›‘å¬çš„socket</span></span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;initserver&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç¬¬å››æ­¥ï¼šå—ç†å®¢æˆ·ç«¯çš„é“¾æ¥è¯·æ±‚ï¼Œå¦‚æœæ²¡æœ‰å®¢æˆ·ç«¯ç»ƒä¸Šæ¥ï¼Œacceptï¼ˆï¼‰å°†é˜»å¡ç­‰å¾…</span></span><br><span class="line">        <span class="keyword">if</span>(!tcpserver.<span class="built_in">accept</span>())&#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;accept&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> pid = fork();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç³»ç»Ÿèµ„æºä¸è¶³æ—¶</span></span><br><span class="line">        <span class="keyword">if</span>(pid == <span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// çˆ¶è¿›ç¨‹è¿”å›åˆ°å¾ªç¯å¼€å§‹çš„ä½ç½®ï¼Œç»§ç»­å—ç†å®¢æˆ·ç«¯çš„é“¾æ¥</span></span><br><span class="line">        <span class="keyword">if</span>(pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//çˆ¶è¿›ç¨‹ä¸éœ€è¦å®¢æˆ·ç«¯è¿æ¥socket</span></span><br><span class="line">            <span class="comment">//tcpserver.closeclient();</span></span><br><span class="line">            <span class="keyword">continue</span>; </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å­è¿›ç¨‹è´Ÿè´£ä¸å®¢æˆ·ç«¯è¿›è¡Œé€šè®¯</span></span><br><span class="line">        <span class="comment">// å­è¿›ç¨‹ä¸éœ€è¦ç›‘å¬çª—å£</span></span><br><span class="line">       <span class="comment">// tcpserver.closelisten();</span></span><br><span class="line">        <span class="built_in">signal</span>(SIGTERM, ChildEXIT);<span class="comment">//è§„å®šä¸€ä¸ªå­è¿›ç¨‹é€€å‡ºä¿¡å·</span></span><br><span class="line">        <span class="built_in">signal</span>(SIGINT, SIG_IGN);<span class="comment">//å­è¿›ç¨‹ä¸éœ€è¦æ•è·SIGINTä¿¡å·</span></span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;å®¢æˆ·ç«¯å·²è¿æ¥( &quot;</span> &lt;&lt; tcpserver.<span class="built_in">clientip</span>() &lt;&lt; <span class="string">&quot;)ã€‚\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç¬¬äº”æ­¥ï¼šæ¥æ”¶å®¢æˆ·ç«¯å‘æ¥çš„ä¿¡æ¯ï¼Œå¹¶å‘é€å›åº”æŠ¥æ–‡</span></span><br><span class="line">        std::string buffer;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//æ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œæ²¡æœ‰å“¦è¯·æ±‚å°±é˜»å¡recv()ç­‰å¾…</span></span><br><span class="line">            <span class="comment">//å¦‚æœå®¢æˆ·ç«¯å·²æ–­å¼€è¿æ¥ï¼Œrecvå‡½æ•°å°†è¿”å›0</span></span><br><span class="line">            <span class="keyword">if</span>(!tcpserver.<span class="built_in">recv</span>(buffer, <span class="number">1024</span>))&#123;</span><br><span class="line">                <span class="built_in">perror</span>(<span class="string">&quot;recv&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;æ¥æ”¶&quot;</span> &lt;&lt; buffer &lt;&lt; std::endl;</span><br><span class="line">            buffer = <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span>(!tcpserver.<span class="built_in">send</span>(buffer))&#123;</span><br><span class="line">                <span class="built_in">perror</span>(<span class="string">&quot;send&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;å‘é€ï¼š&quot;</span> &lt;&lt; buffer &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FatherEXIT</span><span class="params">(<span class="type">int</span> sig)</span></span>&#123;</span><br><span class="line">    <span class="comment">// ä»¥ä¸‹ä»£ç æ˜¯ä¸ºäº†é˜²æ­¢ä¿¡å·å¤„ç†å‡½æ•°åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­è¢«ä¿¡å·å†æ¬¡ä¸­æ–­</span></span><br><span class="line">    <span class="built_in">signal</span>(SIGTERM, SIG_IGN);</span><br><span class="line">    <span class="built_in">signal</span>(SIGINT, SIG_IGN);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;çˆ¶è¿›ç¨‹&quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">&quot;æ­£åœ¨é€€å‡º, sig=&quot;</span> &lt;&lt; sig &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">kill</span>(<span class="number">0</span>,SIGTERM);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;å­è¿›ç¨‹&quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">&quot;æ­£åœ¨é‡Šæ”¾çˆ¶è¿›ç¨‹çš„èµ„æºä»¥åŠå…¨å±€èµ„æº&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">// è¿™é‡Œäº›é‡Šæ”¾èµ„æºçš„ä»£ç </span></span><br><span class="line">    tcpserver.<span class="built_in">closelisten</span>(); <span class="comment">// å…³é—­ç›‘å¬socket</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChildEXIT</span><span class="params">(<span class="type">int</span> sig)</span></span>&#123;</span><br><span class="line">    <span class="comment">// ä»¥ä¸‹ä»£ç æ˜¯ä¸ºäº†é˜²æ­¢ä¿¡å·å¤„ç†å‡½æ•°åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­è¢«ä¿¡å·å†æ¬¡ä¸­æ–­</span></span><br><span class="line">    <span class="built_in">signal</span>(SIGTERM, SIG_IGN);</span><br><span class="line">    <span class="built_in">signal</span>(SIGINT, SIG_IGN);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;å­è¿›ç¨‹&quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">&quot;æ­£åœ¨é€€å‡º, sig=&quot;</span> &lt;&lt; sig &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;å­è¿›ç¨‹&quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">&quot;æ­£åœ¨é‡Šæ”¾å­è¿›ç¨‹çš„èµ„æº&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">// è¿™é‡Œäº›é‡Šæ”¾èµ„æºçš„ä»£ç </span></span><br><span class="line">    tcpserver.<span class="built_in">closeclient</span>(); <span class="comment">// å…³é—­å®¢æˆ·ç«¯è¿æ¥socket</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>); </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>æ³¨æ„ä¸€å®šè¦é‡Šæ”¾èµ„æºï¼Œåœ¨å­è¿›ç¨‹ä¸­å…³é—­ç›‘å¬socketï¼Œåœ¨çˆ¶è¿›ç¨‹ä¸­å…³é—­ å®¢æˆ·ç«¯è¿æ¥socketï¼Œæ€æ­»è¿›ç¨‹æ—¶ä¸€å®šè¦é‡Šæ”¾èµ„æº</li>
</ul>
<h4 id="void-æ˜¯ä»€ä¹ˆï¼Ÿ">void * æ˜¯ä»€ä¹ˆï¼Ÿ</h4>
<ul>
<li>void * æ˜¯ä¸€ä¸ªè·³è·ƒåŠ›(+1 åè·¨è¶Šçš„å¹…åº¦)æœªå®šçš„æŒ‡é’ˆ<br>
è¿™å°±æ˜¯å®ƒçš„ç¥å¥‡ä¹‹å¤„äº†ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±æ§åˆ¶åœ¨éœ€è¦çš„æ—¶å€™å°†å®ƒå®ç°ä¸ºéœ€è¦çš„ç±»å‹ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯ï¼šç¼–ç¨‹æ—¶å€™èŠ‚çº¦ä»£ç ï¼Œå®ç°æ³›å‹ç¼–ç¨‹ã€‚</li>
<li>void <em>æ˜¯ä¸€ç§æŒ‡é’ˆç±»å‹ï¼Œå¸¸ç”¨åœ¨å‡½æ•°å‚æ•°ã€å‡½æ•°è¿”å›å€¼ä¸­éœ€è¦å…¼å®¹ä¸åŒæŒ‡é’ˆç±»å‹çš„åœ°æ–¹ã€‚æˆ‘ä»¬å¯ä»¥å°†åˆ«çš„ç±»å‹çš„æŒ‡é’ˆæ— éœ€å¼ºåˆ¶ç±»å‹è½¬æ¢çš„èµ‹å€¼ç»™void</em>ç±»å‹ã€‚ä¹Ÿå¯ä»¥å°†void *å¼ºåˆ¶ç±»å‹è½¬æ¢æˆä»»ä½•åˆ«çš„æŒ‡é’ˆç±»å‹ï¼Œè‡³äºå¼ºè½¬çš„ç±»å‹æ˜¯å¦åˆç†ï¼Œå°±éœ€è¦æˆ‘ä»¬ç¨‹åºå‘˜è‡ªå·±æ§åˆ¶äº†ã€‚</li>
</ul>
<h3 id="æ–‡ä»¶ä¼ è¾“">æ–‡ä»¶ä¼ è¾“</h3>
<h4 id="æœåŠ¡ç«¯ä»£ç ">æœåŠ¡ç«¯ä»£ç </h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    ç¨‹åºå:server3.cpp æ˜¯ç”¨æ¥æ¼”ç¤ºæ–‡ä»¶ä¼ è¾“çš„å¤šè¿›ç¨‹çš„socketæœåŠ¡ç«¯</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span><span class="comment">//sockaddr_inéœ€è¦</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span><span class="comment">//hostentéœ€è¦</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FatherEXIT</span><span class="params">(<span class="type">int</span> sig)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChildEXIT</span><span class="params">(<span class="type">int</span> sig)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// acceptçš„è¿‡ç¨‹ç†è§£ä¸ºå—ç†å®¢æˆ·ç«¯çš„é“¾æ¥(ä»å·²è¿æ¥çš„å®¢æˆ·ç«¯ä¸­å–å‡ºä¸€ä¸ªå®¢æˆ·ç«¯)ï¼Œä¸€ä¸ªæœåŠ¡ç«¯å¯ä»¥å’Œå¾ˆå¤šå®¢æˆ·ç«¯é€šä¿¡</span></span><br><span class="line"><span class="comment">//å¦‚æœæ²¡æœ‰å·²è¿æ¥çš„å®¢æˆ·ç«¯ï¼Œacceptå°†é˜»å¡</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ctcpserver</span>&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> m_listenfd; <span class="comment">//ç›‘å¬çš„socketï¼Œ-1è¡¨ç¤ºæœªåˆå§‹åŒ–</span></span><br><span class="line">    <span class="type">int</span> m_clientfd; <span class="comment">//å®¢æˆ·ç«¯ç»ƒä¸Šæ¥çš„socketï¼Œ-1è¡¨ç¤ºæœªåˆå§‹åŒ–</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> m_port;<span class="comment">//æœåŠ¡å™¨ç”¨äºé€šä¿¡çš„ç«¯å£</span></span><br><span class="line">    std::string m_clientip; <span class="comment">//å®¢æˆ·ç«¯çš„IP</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ctcpserver</span>():<span class="built_in">m_clientfd</span>(<span class="number">-1</span>), <span class="built_in">m_listenfd</span>(<span class="number">-1</span>)&#123;&#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºç›‘å¬socket,å¹¶åˆå§‹åŒ–å®ƒ</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">initserver</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">short</span> in_port)</span></span>&#123;</span><br><span class="line">        <span class="comment">//ç¬¬ä¸€æ­¥åˆ›å»ºsocket</span></span><br><span class="line">        <span class="keyword">if</span>((m_listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// ç¬¬äºŒéƒ¨ å°†ipåœ°å€å’Œç«¯å£ç»‘åœ¨socketä¸Š</span></span><br><span class="line">        m_port = in_port;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> servaddr;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in">sizeof</span>(servaddr));</span><br><span class="line">        servaddr.sin_family = AF_INET;</span><br><span class="line">        servaddr.sin_port = <span class="built_in">htons</span>(m_port);</span><br><span class="line">        servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">bind</span>(m_listenfd, (<span class="type">const</span> sockaddr *)&amp;servaddr, <span class="built_in">sizeof</span>(servaddr)) == <span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="built_in">close</span>(m_listenfd);</span><br><span class="line">            m_listenfd = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç¬¬ä¸‰æ­¥æ‰“å¼€ç›‘å¬çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">listen</span>(m_listenfd, <span class="number">5</span>) == <span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="built_in">close</span>(m_listenfd);</span><br><span class="line">            m_listenfd = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">accept</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> caddr; <span class="comment">// å®¢æˆ·ç«¯çš„åœ°å€ä¿¡æ¯</span></span><br><span class="line">        <span class="type">socklen_t</span> addrlen = <span class="built_in">sizeof</span>(caddr); <span class="comment">// ä¸Šé¢çš„å¤§å°</span></span><br><span class="line">        <span class="comment">//accept,ä¸‰ä¸ªå‚æ•°ç¬¬ä¸€ä¸ªä¸ºç›‘å¬socketçš„fdå€¼ï¼Œç¬¬äºŒä¸ªä¸ºipåœ°å€çš„åœ°å€ï¼Œç¬¬ä¸‰ä¸ªä¸ºipåœ°å€å¤§å°çš„åœ°å€</span></span><br><span class="line">        <span class="keyword">if</span>((m_clientfd = ::<span class="built_in">accept</span>(m_listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;caddr, &amp;addrlen)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        m_clientip = <span class="built_in">inet_ntoa</span>(caddr.sin_addr); <span class="comment">//æŠŠå®¢æˆ·ç«¯çš„åœ°å€ä»å¤§ç«¯åºè½¬æ¢æˆå­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string &amp; <span class="title">clientip</span><span class="params">()</span> <span class="type">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> m_clientip;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘é€æŠ¥æ–‡</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">send</span><span class="params">(<span class="type">const</span> std::string&amp; buffer)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(m_clientfd == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span>((::<span class="built_in">send</span>(m_clientfd, buffer.<span class="built_in">data</span>(), buffer.<span class="built_in">size</span>(), <span class="number">0</span>)) &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ¥å—æŠ¥æ–‡</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">recv</span><span class="params">(std::string &amp;buffer, <span class="type">const</span> <span class="type">size_t</span> maxlen)</span></span>&#123;</span><br><span class="line">        buffer.<span class="built_in">clear</span>();  <span class="comment">//æ¸…ç©ºå†…å­˜</span></span><br><span class="line">        buffer.<span class="built_in">resize</span>(maxlen); <span class="comment">//è®¾ç½®å®¹å™¨å¤§å°ä¸ºmaxlen</span></span><br><span class="line">        <span class="type">int</span> readn = ::<span class="built_in">recv</span>(m_clientfd, &amp;buffer[<span class="number">0</span>], buffer.<span class="built_in">size</span>(), <span class="number">0</span>); <span class="comment">//ç›´æ¥æ“ä½œbufferçš„å†…å­˜</span></span><br><span class="line">        <span class="keyword">if</span>(readn &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            buffer.<span class="built_in">clear</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        buffer.<span class="built_in">resize</span>(readn);<span class="comment">//é‡ç½®å¤§å°</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ¥æ”¶æ–‡ä»¶åç§°å’Œå¤§å°</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">recv</span><span class="params">(<span class="type">void</span> *buffer, <span class="type">const</span> <span class="type">size_t</span> maxlen)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(::<span class="built_in">recv</span>(m_clientfd, buffer, maxlen, <span class="number">0</span>) &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¥æ”¶æ–‡ä»¶å†…å®¹</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">recvfile</span><span class="params">(<span class="type">const</span> std::string &amp;filename, <span class="type">const</span> <span class="type">size_t</span> filesize)</span></span>&#123;</span><br><span class="line">        std::ofstream fout;</span><br><span class="line">        fout.<span class="built_in">open</span>(filename, std::ios::out);</span><br><span class="line">        <span class="keyword">if</span>(!fout.<span class="built_in">is_open</span>()) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;æ‰“å¼€æ–‡ä»¶&quot;</span> &lt;&lt; filename &lt;&lt; <span class="string">&quot;å¤±è´¥ã€‚\n&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> totalbytes = <span class="number">0</span>; <span class="comment">//å·²ç»æ¥å—çš„æ–‡ä»¶æ€»å­—èŠ‚æ•°</span></span><br><span class="line">        <span class="type">int</span> onread = <span class="number">0</span>; <span class="comment">//æœ¬æ¬¡æ‰“ç®—æ¥å—çš„å­—èŠ‚æ•°</span></span><br><span class="line">        <span class="type">char</span> buffer[<span class="number">1000</span>]; <span class="comment">// æ¥æ”¶æ–‡ä»¶å†…å®¹çš„ç¼“å†²åŒº</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="comment">// è®¡ç®—è¢«ä½ åº”è¯¥å°±æ”¶çš„å­—èŠ‚æ•°</span></span><br><span class="line">            <span class="keyword">if</span>(filesize - totalbytes &gt; <span class="number">1000</span>) onread = <span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">else</span> onread = filesize - totalbytes;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//æ¥æ”¶æ–‡ä»¶å†…å®¹</span></span><br><span class="line">            <span class="keyword">if</span>(!<span class="built_in">recv</span>(buffer, onread)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æŠŠæ¥æ”¶åˆ°çš„å†…å®¹å†™å…¥æ–‡ä»¶</span></span><br><span class="line">            fout.<span class="built_in">write</span>(buffer, onread);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//è®¡ç®—å·²ç»æ¥æ”¶æ–‡ä»¶çš„æ€»å­—èŠ‚æ•°ï¼Œå¦‚æœæ–‡ä»¶æ¥å—å®Œè·³å‡ºå¾ªç¯</span></span><br><span class="line">            totalbytes += onread;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(totalbytes == filesize) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä»¥ä¸‹è¦åˆ†å¼€ä¸¤ä¸ªæˆå‘˜å‡½æ•° ä¸èƒ½å†™åœ¨ä¸€ä¸ªå‡½æ•°é‡Œé¢</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">closelisten</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(m_listenfd == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        ::<span class="built_in">close</span>(m_listenfd);</span><br><span class="line">        m_listenfd = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">closeclient</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(m_clientfd == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        ::<span class="built_in">close</span>(m_clientfd);</span><br><span class="line">        m_clientfd = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…³é—­socketèµ„æº</span></span><br><span class="line">    ~<span class="built_in">ctcpserver</span>()&#123;</span><br><span class="line">        <span class="built_in">closelisten</span>();</span><br><span class="line">        <span class="built_in">closeclient</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ctcpserver tcpserver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">st_fileinfo</span>&#123;</span><br><span class="line">    <span class="type">char</span> filename[<span class="number">256</span>];</span><br><span class="line">    <span class="type">int</span> filesize;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">3</span>)&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Using:./server é€šè®¯ç«¯å£ æ–‡ä»¶å­˜æ”¾ç›®å½•\n Exampleï¼š./server 5005 /tmp\n\n&quot;</span>;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;æ³¨æ„ï¼šè¿è¡ŒæœåŠ¡ç«¯çš„ç¨‹åºLinuxç³»ç»Ÿçš„é˜²ç«å¢™å¿…é¡»è¦å¼€é€š5005ç«¯å£\n&quot;</span>;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;å¦‚æœæ˜¯äº‘æœåŠ¡å™¨ï¼Œè¿˜æœ‰å¼€é€šäº‘å¹³å°çš„è®¿é—®ç­–ç•¥&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¿½è§†å…¨éƒ¨çš„ä¿¡å·ï¼Œä¸å¸Œæœ›è¢«æ‰“æ‰°ï¼Œé¡ºä¾¿è§£å†³äº†åƒµå°¸è¿›ç¨‹çš„é—®é¢˜</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">65</span>; i ++) <span class="built_in">signal</span>(i, SIG_IGN);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®ä¿¡å·ï¼Œåœ¨shellçŠ¶æ€ä¸‹ï¼Œå¯ç”¨kill è¿›ç¨‹å· æˆ–è€… Cirl + c æ­£å¸¸ç»ˆæ­¢è¿™äº›è¿›ç¨‹</span></span><br><span class="line">    <span class="comment">// ä½†è¯·ä¸è¦ç”¨ kill -9 + è¿›ç¨‹å· å¼ºè¡Œç»ˆæ­¢</span></span><br><span class="line">    <span class="built_in">signal</span>(SIGTERM, FatherEXIT); <span class="comment">//15ä¿¡å·,è¿™è¡Œçš„ä»£ç æ„æ€æ˜¯è‡ªå·±è§„å®šä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°</span></span><br><span class="line">    <span class="built_in">signal</span>(SIGINT, FatherEXIT);<span class="comment">// 2ä¿¡å·</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!tcpserver.<span class="built_in">initserver</span>(<span class="built_in">atoi</span>(argv[<span class="number">1</span>])))&#123;<span class="comment">// åˆå§‹åŒ–æœåŠ¡ç«¯ç”¨äºç›‘å¬çš„socket</span></span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;initserver&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç¬¬å››æ­¥ï¼šå—ç†å®¢æˆ·ç«¯çš„é“¾æ¥è¯·æ±‚ï¼Œå¦‚æœæ²¡æœ‰å®¢æˆ·ç«¯ç»ƒä¸Šæ¥ï¼Œacceptï¼ˆï¼‰å°†é˜»å¡ç­‰å¾…</span></span><br><span class="line">        <span class="keyword">if</span>(!tcpserver.<span class="built_in">accept</span>())&#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;accept&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> pid = fork();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç³»ç»Ÿèµ„æºä¸è¶³æ—¶</span></span><br><span class="line">        <span class="keyword">if</span>(pid == <span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// çˆ¶è¿›ç¨‹è¿”å›åˆ°å¾ªç¯å¼€å§‹çš„ä½ç½®ï¼Œç»§ç»­å—ç†å®¢æˆ·ç«¯çš„é“¾æ¥</span></span><br><span class="line">        <span class="keyword">if</span>(pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//çˆ¶è¿›ç¨‹ä¸éœ€è¦å®¢æˆ·ç«¯è¿æ¥socket</span></span><br><span class="line">            <span class="comment">//tcpserver.closeclient();</span></span><br><span class="line">            <span class="keyword">continue</span>; </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å­è¿›ç¨‹è´Ÿè´£ä¸å®¢æˆ·ç«¯è¿›è¡Œé€šè®¯</span></span><br><span class="line">        <span class="comment">// å­è¿›ç¨‹ä¸éœ€è¦ç›‘å¬çª—å£</span></span><br><span class="line">       <span class="comment">// tcpserver.closelisten();</span></span><br><span class="line">        <span class="built_in">signal</span>(SIGTERM, ChildEXIT);<span class="comment">//è§„å®šä¸€ä¸ªå­è¿›ç¨‹é€€å‡ºä¿¡å·</span></span><br><span class="line">        <span class="built_in">signal</span>(SIGINT, SIG_IGN);<span class="comment">//å­è¿›ç¨‹ä¸éœ€è¦æ•è·SIGINTä¿¡å·</span></span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;å®¢æˆ·ç«¯å·²è¿æ¥( &quot;</span> &lt;&lt; tcpserver.<span class="built_in">clientip</span>() &lt;&lt; <span class="string">&quot;)ã€‚\n&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//ä»¥ä¸‹æ˜¯æœåŠ¡ç«¯çš„æµç¨‹</span></span><br><span class="line">        <span class="comment">//1ï¼‰æ¥æ”¶æ–‡ä»¶åå’Œæ–‡ä»¶å¤§å°ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">st_fileinfo</span> fileinfo;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;fileinfo, <span class="number">0</span>, <span class="built_in">sizeof</span>(fileinfo));</span><br><span class="line">        <span class="comment">// ç”¨ç»“æ„ä½“æ–‡ä»¶æ¥æ¥å—å‘æ¥çš„æ–‡ä»¶ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">if</span>(!tcpserver.<span class="built_in">recv</span>(&amp;fileinfo, <span class="built_in">sizeof</span>(fileinfo)))&#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;recv&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;æ”¶åˆ°æ–‡ä»¶å ï¼ˆ&quot;</span> &lt;&lt; fileinfo.filename &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; fileinfo.filesize &lt;&lt; std::endl;</span><br><span class="line">       </span><br><span class="line">        <span class="comment">//2ï¼‰ç»™å®¢æˆ·ç«¯å›å¤ç¡®è®¤æŠ¥æ–‡ï¼ˆè¡¨ç¤ºå®¢æˆ·ç«¯å¯ä»¥å‘æ–‡ä»¶ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span>(!tcpserver.<span class="built_in">send</span>(<span class="string">&quot;ok&quot;</span>))&#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;send&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;å‘é€OK&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3ï¼‰æ¥æ”¶æ–‡ä»¶å†…å®¹</span></span><br><span class="line">        <span class="keyword">if</span>(!tcpserver.<span class="built_in">recvfile</span>(std::<span class="built_in">string</span>(argv[<span class="number">2</span>]) + <span class="string">&quot;/&quot;</span> + fileinfo.filename, fileinfo.filesize))&#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;æ¥æ”¶æ–‡ä»¶å†…å®¹å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;æ¥æ”¶æ–‡ä»¶å†…å®¹æˆåŠŸ&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="comment">//4ï¼‰ç»™å®¢æˆ·ç«¯å›å¤ç¡®è®¤æŠ¥æ–‡ï¼ˆè¡¨ç¤ºæœåŠ¡ç«¯æ¥æ”¶æˆåŠŸï¼‰</span></span><br><span class="line">        <span class="keyword">if</span>(!tcpserver.<span class="built_in">send</span>(<span class="string">&quot;ok&quot;</span>))&#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;send&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;æ–‡ä»¶ä¼ è¾“å®Œæ¯•\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FatherEXIT</span><span class="params">(<span class="type">int</span> sig)</span></span>&#123;</span><br><span class="line">    <span class="comment">// ä»¥ä¸‹ä»£ç æ˜¯ä¸ºäº†é˜²æ­¢ä¿¡å·å¤„ç†å‡½æ•°åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­è¢«ä¿¡å·å†æ¬¡ä¸­æ–­</span></span><br><span class="line">    <span class="built_in">signal</span>(SIGTERM, SIG_IGN);</span><br><span class="line">    <span class="built_in">signal</span>(SIGINT, SIG_IGN);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;çˆ¶è¿›ç¨‹&quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">&quot;æ­£åœ¨é€€å‡º, sig=&quot;</span> &lt;&lt; sig &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">kill</span>(<span class="number">0</span>,SIGTERM);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;å­è¿›ç¨‹&quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">&quot;æ­£åœ¨é‡Šæ”¾çˆ¶è¿›ç¨‹çš„èµ„æºä»¥åŠå…¨å±€èµ„æº&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">// è¿™é‡Œäº›é‡Šæ”¾èµ„æºçš„ä»£ç </span></span><br><span class="line">    tcpserver.<span class="built_in">closelisten</span>(); <span class="comment">// å…³é—­ç›‘å¬socket</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChildEXIT</span><span class="params">(<span class="type">int</span> sig)</span></span>&#123;</span><br><span class="line">    <span class="comment">// ä»¥ä¸‹ä»£ç æ˜¯ä¸ºäº†é˜²æ­¢ä¿¡å·å¤„ç†å‡½æ•°åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­è¢«ä¿¡å·å†æ¬¡ä¸­æ–­</span></span><br><span class="line">    <span class="built_in">signal</span>(SIGTERM, SIG_IGN);</span><br><span class="line">    <span class="built_in">signal</span>(SIGINT, SIG_IGN);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;å­è¿›ç¨‹&quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">&quot;æ­£åœ¨é€€å‡º, sig=&quot;</span> &lt;&lt; sig &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;å­è¿›ç¨‹&quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">&quot;æ­£åœ¨é‡Šæ”¾å­è¿›ç¨‹çš„èµ„æº&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">// è¿™é‡Œäº›é‡Šæ”¾èµ„æºçš„ä»£ç </span></span><br><span class="line">    tcpserver.<span class="built_in">closeclient</span>(); <span class="comment">// å…³é—­å®¢æˆ·ç«¯è¿æ¥socket</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>); </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å®¢æˆ·ç«¯ä»£ç ">å®¢æˆ·ç«¯ä»£ç </h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span><span class="comment">//sockaddr_inéœ€è¦</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span><span class="comment">//hostentéœ€è¦</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    ç”¨æ¥æ¼”ç¤ºæ–‡ä»¶ä¼ è¾“çš„å®¢æˆ·ç«¯</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ctcpclient</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> m_clientfd; <span class="comment">// å®¢æˆ·ç«¯çš„socketï¼Œ-1è¡¨ç¤ºæœªè¿æ¥æˆ–è¿æ¥å·²æ–­å¼€ï¼Œ&gt;=0 è¡¨ç¤ºæœ‰æ•ˆçš„socket</span></span><br><span class="line">    std::string m_ip; <span class="comment">// æœåŠ¡å™¨çš„IP/åŸŸå</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> m_port; <span class="comment">// é€šè®¯ç«¯å£</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å‘æœåŠ¡ç«¯å‘èµ·è¿æ¥è¯·æ±‚ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥false</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">connect</span><span class="params">(<span class="type">const</span> std::string&amp; in_ip, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">short</span> in_port)</span></span>&#123;</span><br><span class="line">        <span class="comment">// å»ºç«‹å¥—æ¥å­—</span></span><br><span class="line">        m_clientfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(m_clientfd == <span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å‘æœåŠ¡ç«¯å‘é€è¿æ¥è¯·æ±‚</span></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> servaddr;</span><br><span class="line">        m_ip = in_ip;</span><br><span class="line">        m_port = in_port;</span><br><span class="line">        servaddr.sin_family = AF_INET;</span><br><span class="line">        servaddr.sin_port = <span class="built_in">htons</span>(m_port);</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">hostent</span>* h;</span><br><span class="line">        <span class="keyword">if</span>((h = <span class="built_in">gethostbyname</span>(m_ip.<span class="built_in">c_str</span>())) == <span class="literal">nullptr</span>)&#123;</span><br><span class="line">            <span class="built_in">close</span>();</span><br><span class="line">            m_clientfd = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;servaddr.sin_addr, h-&gt;h_addr, h-&gt;h_length);</span><br><span class="line">        <span class="comment">// ä»¥ä¸‹é”™è¯¯å¸¸çŠ¯ï¼Œæ³¨æ„å½“ä½ æƒ³ä½¿ç”¨å…¨å±€å‡½æ•°æˆ–è€…å…¨å±€åŒåå˜é‡çš„æ—¶å€™ è¦åœ¨å‰é¢+::</span></span><br><span class="line">        <span class="keyword">if</span>(::<span class="built_in">connect</span>(m_clientfd, (<span class="keyword">struct</span> sockaddr *) &amp;servaddr, <span class="built_in">sizeof</span>(servaddr)) == <span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="built_in">close</span>();</span><br><span class="line">            m_clientfd = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¸ºä»€ä¹ˆä¸ç”¨const char * å› ä¸ºconst char * æ— æ³•æ”¯æŒstring,è€Œä¸‹åˆ—å¯ä»¥æ”¯æŒä»const char *</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">send</span><span class="params">(<span class="type">const</span> std::string&amp; buffer)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(m_clientfd == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">//ä¸€å®šä¸è¦å¿˜äº†::</span></span><br><span class="line">        <span class="keyword">if</span>(::<span class="built_in">send</span>(m_clientfd, buffer.<span class="built_in">data</span>(), buffer.<span class="built_in">size</span>(), <span class="number">0</span>) &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ç”¨äºå‘é€æ–‡ä»¶ç»“æ„ä½“</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">send</span><span class="params">(<span class="type">void</span> *buffer, <span class="type">const</span> <span class="type">size_t</span> maxlen)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(m_clientfd == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(::<span class="built_in">send</span>(m_clientfd, buffer, maxlen, <span class="number">0</span>) &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">sendfile</span><span class="params">(<span class="type">const</span> std::string &amp;filename, <span class="type">const</span> <span class="type">size_t</span> filesize)</span></span>&#123;</span><br><span class="line">        <span class="comment">// ä»¥äºŒè¿›åˆ¶å½¢å¼æ‰“å¼€æ–‡ä»¶</span></span><br><span class="line">        <span class="function">std::ifstream <span class="title">fin</span><span class="params">(filename, std::ios::in)</span></span>;</span><br><span class="line">        <span class="keyword">if</span>(fin.<span class="built_in">is_open</span>() == <span class="literal">false</span>)&#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;æ‰“å¼€æ–‡ä»¶&quot;</span> &lt;&lt; filename &lt;&lt; <span class="string">&quot;å¤±è´¥.\n&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> onread = <span class="number">0</span>; <span class="comment">//æ¯æ¬¡è°ƒç”¨fin.read()æ‰“ç®—è¯»å–çš„å­—èŠ‚æ•°</span></span><br><span class="line">        <span class="type">int</span> totalbytes = <span class="number">0</span>;<span class="comment">// ä»æ–‡ä»¶ä¸­å·²ç»è¯»å–çš„å­—èŠ‚æ€»æ•°</span></span><br><span class="line">        <span class="type">char</span> buffer[<span class="number">1000</span>]; <span class="comment">// å­˜æ”¾è¯»å–æ•°æ®çš„buffer</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è®¡ç®—æœ¬æ¬¡åº”è¯¥è¯»å–çš„å­—èŠ‚æ•°ï¼Œå¦‚æœå‰©ä½™è¶…è¿‡1000å­—èŠ‚ï¼Œå°±è¯»1000å­—èŠ‚</span></span><br><span class="line">            <span class="keyword">if</span>(filesize - totalbytes &gt; <span class="number">1000</span>) onread = <span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">else</span> onread = filesize - totalbytes;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®</span></span><br><span class="line">            fin.<span class="built_in">read</span>(buffer, onread);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æŠŠè¯»å–åˆ°çš„æ•°æ®å‘é€ç»™å¯¹ç«¯</span></span><br><span class="line">            <span class="keyword">if</span>(!<span class="built_in">send</span>(buffer, onread)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è®¡ç®—æ–‡ä»¶å·²ç»è¯»å–çš„å­—èŠ‚æ€»ä¸ªæ•°ï¼Œå¦‚æœæ–‡ä»¶å·²ç»è¯»å®Œï¼Œè·³å‡ºå¾ªç¯</span></span><br><span class="line">            totalbytes += onread;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(totalbytes == filesize) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¥æ”¶æœåŠ¡ç«¯çš„æŠ¥æ–‡ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false</span></span><br><span class="line">    <span class="comment">//bufferå­˜æ”¾æ¥æ”¶åˆ°çš„æŠ¥æ–‡å†…å®¹ï¼Œmaxlenæœ¬æ¬¡æ¥æ”¶æŠ¥æ–‡çš„é•¿åº¦</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">recv</span><span class="params">(std::string&amp; buffer,<span class="type">const</span> <span class="type">size_t</span> maxlen)</span></span>&#123;</span><br><span class="line">        <span class="comment">//å¦‚æœç›´æ¥æ“ä½œstringå¯¹è±¡çš„å†…å­˜ï¼Œå¿…é¡»ä¿è¯1ï¼‰ä¸èƒ½è¶Šç•Œï¼Œ2ï¼‰æ“ä½œåæ‰‹åŠ¨è®¾ç½®æ•°æ®å¤§å°</span></span><br><span class="line">        buffer.<span class="built_in">clear</span>();</span><br><span class="line">        std::cout &lt;&lt; buffer &lt;&lt;  std::endl;</span><br><span class="line">        buffer.<span class="built_in">resize</span>(maxlen);</span><br><span class="line">        <span class="type">int</span> readn=::<span class="built_in">recv</span>(m_clientfd, &amp;buffer[<span class="number">0</span>], buffer.<span class="built_in">size</span>(), <span class="number">0</span>);</span><br><span class="line">        <span class="comment">//-1è¡¨ç¤ºå¤±è´¥ï¼Œ0è¡¨ç¤ºæ–­å¼€è¿æ¥ï¼ŒæˆåŠŸæ”¾å›æ•°æ®å¤§å°</span></span><br><span class="line">        <span class="keyword">if</span>(readn &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            buffer.<span class="built_in">clear</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        buffer.<span class="built_in">resize</span>(readn); <span class="comment">//é‡ç½®bufferçš„å®é™…å¤§å°</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">close</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(m_clientfd == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        ::<span class="built_in">close</span>(m_clientfd);</span><br><span class="line">        m_clientfd = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ctcpclient</span>():<span class="built_in">m_clientfd</span>(<span class="number">-1</span>)&#123;&#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">ctcpclient</span>()&#123;<span class="built_in">close</span>();&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">5</span>)&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Using:./client æœåŠ¡ç«¯IPåœ°å€ æœåŠ¡ç«¯çš„ç«¯å£, æ–‡ä»¶åï¼Œæ–‡ä»¶å¤§å°\n&quot;</span>;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Exampleï¼š./client 192.168.168.1 5005 aaa.txt 2424\n\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ctcpclient tcpclient;</span><br><span class="line">    <span class="keyword">if</span>(!tcpclient.<span class="built_in">connect</span>(argv[<span class="number">1</span>], <span class="built_in">atoi</span>(argv[<span class="number">2</span>])))&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»¥ä¸‹æ˜¯å‘é€æ–‡ä»¶çš„æµç¨‹</span></span><br><span class="line">    <span class="comment">// 1ï¼‰æŠŠä¼ è¾“çš„æ–‡ä»¶åå’Œæ–‡ä»¶å¤§å°å‘Šè¯‰æœåŠ¡ç«¯</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å®šä¹‰æ–‡ä»¶ä¿¡æ¯ç»“æ„ä½“</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">st_fileinfo</span>&#123;</span><br><span class="line">        <span class="type">char</span> filename[<span class="number">256</span>];</span><br><span class="line">        <span class="type">int</span> filesize;</span><br><span class="line">    &#125;fileinfo;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;fileinfo, <span class="number">0</span>, <span class="built_in">sizeof</span>(fileinfo));</span><br><span class="line">    <span class="built_in">strcpy</span>(fileinfo.filename, argv[<span class="number">3</span>]);<span class="comment">//æ–‡ä»¶å</span></span><br><span class="line">    fileinfo.filesize = <span class="built_in">atoi</span>(argv[<span class="number">4</span>]);<span class="comment">//æ–‡ä»¶å¤§å°</span></span><br><span class="line">    <span class="comment">//æŠŠæ–‡ä»¶ä¿¡æ¯çš„ç»“æ„é¢˜å‘é€ç»™æœåŠ¡ç«¯</span></span><br><span class="line">    <span class="keyword">if</span>(!tcpclient.<span class="built_in">send</span>(&amp;fileinfo, <span class="built_in">sizeof</span>(fileinfo)))&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;send&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;å‘é€æ–‡ä»¶ä¿¡æ¯çš„ç»“æ„ä½“&quot;</span> &lt;&lt; fileinfo.filename &lt;&lt; <span class="string">&quot;(&quot;</span> &lt;&lt; fileinfo.filesize &lt;&lt; <span class="string">&quot;)&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2ï¼‰ç­‰å¾…æœåŠ¡ç«¯çš„ç¡®è®¤æŠ¥æ–‡ï¼ˆå¯¹æ–‡ä»¶åå’Œæ–‡ä»¶çš„å¤§å°çš„ç¡®è®¤ï¼‰</span></span><br><span class="line">    std::string buffer;</span><br><span class="line">    <span class="keyword">if</span>(!tcpclient.<span class="built_in">recv</span>(buffer, <span class="number">1024</span>))&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;recv&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(buffer != <span class="string">&quot;ok&quot;</span>) std::cout &lt;&lt; <span class="string">&quot;æœåŠ¡ç«¯æ²¡æœ‰å›å¤ok\n&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">// 3ï¼‰å‘é€æ–‡ä»¶å†…å®¹</span></span><br><span class="line">    <span class="keyword">if</span>(!tcpclient.<span class="built_in">sendfile</span>(fileinfo.filename, fileinfo.filesize))&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;sendfile&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4ï¼‰ç­‰å¾…æœåŠ¡ç«¯çš„ç¡®è®¤æŠ¥æ–‡ï¼ˆæœåŠ¡ç«¯å·²æ¥å—å®Œæ–‡ä»¶ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span>(!tcpclient.<span class="built_in">recv</span>(buffer, <span class="number">2</span>))&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;recv&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(buffer != <span class="string">&quot;ok&quot;</span>) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;å‘é€æ–‡ä»¶å†…å®¹å¤±è´¥ã€‚\n&quot;</span>; </span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ä¸‰æ¬¡æ¡æ‰‹ï¼Œå››æ¬¡æŒ¥æ‰‹">ä¸‰æ¬¡æ¡æ‰‹ï¼Œå››æ¬¡æŒ¥æ‰‹</h3>
<ul>
<li>yum install net-tools -y; ä¸‹è½½å·¥å…·åŒ…</li>
<li>netstat -na|less æŸ¥çœ‹å¥—æ¥å­—çŠ¶æ€</li>
</ul>
<h4 id="ä¸‰æ¬¡æ¡æ‰‹">ä¸‰æ¬¡æ¡æ‰‹</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-99.png" alt="Alt text"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-100.png" alt="Alt text"></p>
<h5 id="ç»†èŠ‚">ç»†èŠ‚</h5>
<ul>
<li>å®¢æˆ·ç«¯ä¹Ÿæœ‰ç«¯å£å·ï¼Œå¯¹äºç¨‹åºå‘˜æ¥è¯´ï¼Œå¯ä»¥ä¸å¿…å…³å¿ƒå®¢æˆ·ç«¯çš„ç«¯å£å·ï¼Œæ‰€ä»¥ç³»ç»Ÿéšæœºåˆ†é…ï¼ˆsocket é€šè®¯ä¸­çš„åœ°å€åŒ…æ‹¬ipå’Œç«¯å£å·ï¼Œä½†æ˜¯ä¹ æƒ¯åœ°å€ä»…ä»…æŒ‡ipåœ°å€ï¼‰</li>
<li>æœåŠ¡ç«¯çš„bindå‡½æ•°ï¼Œæ™®é€šç”¨æˆ·å¿…é¡»æ˜¯ä½¿ç”¨1024ä»¥ä¸Šç«¯å£ï¼Œrootä»»æ„</li>
<li>listenå‡½æ•°ç¬¬äºŒä¸ªå‚æ•°+1ä¸ºå·²è¿æ¥é˜Ÿåˆ—çš„å¤§å°ï¼Œä¸€æ¬¡èƒ½æ¥å—å¤šå°‘</li>
<li>SYN_RECVçŠ¶æ€çš„è¿æ¥ä¹Ÿç§°åŠè¿æ¥</li>
<li>CLOSEDæ˜¯å‡è±¡çŠ¶æ€ï¼Œå®é™…ä¸å­˜åœ¨</li>
</ul>
<h4 id="å››æ¬¡æŒ¥æ‰‹">å››æ¬¡æŒ¥æ‰‹</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-102.png" alt="Alt text"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-101.png" alt="Alt text"></p>
<h5 id="ç»†èŠ‚-2">ç»†èŠ‚</h5>
<ul>
<li>ä¸»åŠ¨æ–­å¼€çŸ­ç«¯åœ¨å››æ¬¡æŒ¥æ‰‹åï¼Œsocketçš„çŠ¶æ€ä¸º TIME_WAITçŠ¶æ€ï¼Œå°†æŒç»­2MSLï¼ˆ30s/1min/2minï¼‰MSLè¡¨ç¤ºæŠ¥æ–‡åœ¨ç½‘è·¯ä¸­å­˜åœ¨çš„æœ€é•¿æ—¶é—´</li>
<li>å¦‚æœå®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥ï¼ŒTIME_WAITçŠ¶æ€å‡ ä¹ä¸ä¼šé€ æˆå±å®³
<ol>
<li>å®¢æˆ·ç«¯ç¨‹åºçš„socketå¾ˆå°‘</li>
<li>å®¢æˆ·ç«¯çš„çª—å£æ˜¯éšæœºåˆ†é…çš„ï¼Œä¸å­˜åœ¨é‡ç”¨é—®é¢˜</li>
</ol>
</li>
<li>å¦‚æœå®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€ï¼Œæœ‰ä¸¤æ–¹é¢çš„å±å®³ï¼š1ï¼‰socketæ²¡æœ‰ç«‹å³é‡Šæ”¾ï¼›2ï¼‰ç«¯å£ååªèƒ½åœ¨2MSLåæ‰èƒ½é‡ç”¨<br>
ä¹Ÿå°±æ˜¯ä¼šæŠ¥è¿™ä¸ªé”™è¯¯ï¼š<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-103.png" alt="Alt text"></li>
</ul>
<h5 id="è§£å†³ä¸Šè¿°é—®é¢˜åŠæ³•">è§£å†³ä¸Šè¿°é—®é¢˜åŠæ³•</h5>
<p>åœ¨æœåŠ¡ç«¯ç¨‹åºä¸­ï¼Œç”¨setsockopt()å‡½æ•°è®¾ç½®socketçš„å±æ€§(ä¸€å®šè¦æ”¾åœ¨bind()å‰)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TIME_WAITçŠ¶æ€è¿˜åœ¨ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥æ‰“å¼€</span></span><br><span class="line"><span class="type">int</span> opt = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">setsockopt</span>(m_listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;opt,<span class="built_in">sizeof</span>(opt));</span><br></pre></td></tr></table></figure>
<h3 id="TCPç¼“å­˜">TCPç¼“å­˜</h3>
<ul>
<li>ç³»ç»Ÿä¸ºæ¯ä¸ªsocketåˆ›å»ºäº†å‘é€ç¼“å†²åŒºå’Œæ¥æ”¶ç¼“å†²åŒºï¼Œåº”ç”¨ç¨‹åºè°ƒç”¨send()/write()å‡½æ•°å‘é€æ•°æ®çš„æ—¶å€™ï¼Œå†…æ ¸æŠŠæ•°æ®ä»åº”ç”¨è¿›ç¨‹æ‹·è´åˆ°sokcetçš„å‘é€ç¼“å­˜ä¸­åŒºä¸­;åœ¨è°ƒç”¨recv()/read()å‡½æ•°æ¥æ”¶æ•°æ®çš„æ—¶å€™ï¼Œå†…æ ¸æŠŠæ•°æ®ä»socketçš„æ¥æ”¶ç¼“å†²åŒºæ‹·è´åˆ°åº”ç”¨è¿›ç¨‹ä¸­</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-104.png" alt="Alt text"></p>
<h4 id="æŸ¥çœ‹ç¼“å†²åŒºçš„å¤§å°">æŸ¥çœ‹ç¼“å†²åŒºçš„å¤§å°</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> bufsize = <span class="number">0</span>;</span><br><span class="line"><span class="type">socklen_t</span> optlen = <span class="built_in">sizeof</span>(bufsize);</span><br><span class="line"></span><br><span class="line"><span class="built_in">gersockopt</span>(sockfd, SOL_SOCKET, SO_SNDBUF, &amp;bufsize, &amp;optlen);</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;Send bufsize=&quot;</span> &lt;&lt; buffer &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line"><span class="built_in">getsockopt</span>(sockfd, SOL_SOCKET,SO_RCVBUF,&amp;bufsizem &amp;optlen);</span><br><span class="line"></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;recv bufsize =&quot;</span> &lt;&lt; bufsize &lt;&lt; std::endl;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å¯èƒ½é‡åˆ°çš„é—®é¢˜ï¼š</p>
<ol>
<li>
<p><strong>sendï¼ˆï¼‰å‡½æ•°å¯èƒ½ä¼šé˜»å¡å—ï¼Ÿ</strong></p>
<p>ä¼šï¼Œå½“å‘é€ç¼“å†²åŒºæ»¡äº†å’ŒæœåŠ¡ç«¯æ¥æ”¶æ»¡äº† å°±ä¼š</p>
</li>
<li>
<p><strong>å‘socketä¸­å†™å…¥æ•°æ®åï¼Œå¦‚æœå…³é—­äº†socketï¼Œå¯¹ç«¯è¿˜èƒ½æ¥æ”¶åˆ°æ•°æ®å—ï¼Ÿ</strong></p>
<p>èƒ½ï¼Œå› ä¸ºè¿™äº›æ•°æ®å·²ç»å­˜å…¥äº†å¯¹ç«¯çš„æ¥æ”¶ç¼“å­˜åŒºä¸­äº†ï¼Œå³ä½¿å…³é—­äº†socketï¼Œä¹‹å‰å‘é€çš„æ•°æ®åªè¦è¿˜åœ¨ç¼“å†²åŒºä¸­å°±èƒ½æ¥å—</p>
</li>
</ol>
<h4 id="Nagle-ç®—æ³•">Nagle ç®—æ³•</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-105.png" alt="Alt text"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-106.png" alt="Alt text"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-107.png" alt="Alt text"></p>
<h3 id="IOå¤šè·¯å¤ç”¨-selectæ¨¡å‹">IOå¤šè·¯å¤ç”¨ -selectæ¨¡å‹</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-108.png" alt="Alt text"></p>
<h4 id="ä»€ä¹ˆæ˜¯IOå¤šè·¯å¤ç”¨">ä»€ä¹ˆæ˜¯IOå¤šè·¯å¤ç”¨</h4>
<ul>
<li>ç”¨ä¸€ä¸ªè¿›/çº¿ç¨‹å¤„ç†å¤šä¸ªTCPè¿æ¥ï¼Œå‡å°‘ç³»ç»Ÿå¼€é”€</li>
<li>ä¸‰ç§æ¨¡å‹:select(1024), poll(æ•°åƒ)å’Œepoll(ç™¾ä¸‡)</li>
</ul>
<p>æ‹¬å·ä¸­è¡¨ç¤ºå…¶å¤„ç†TCPè¿æ¥çš„æ•°é‡</p>
<h4 id="ç½‘ç»œé€šè®¯-è¯»äº‹ä»¶">ç½‘ç»œé€šè®¯-è¯»äº‹ä»¶</h4>
<ul>
<li>å·²è¿æ¥é˜Ÿåˆ—ä¸­æœ‰å·²ç»å‡†å¤‡å¥½çš„socket(æœ‰æ–°çš„å®¢æˆ·ç«¯è¿ä¸Šæ¥)</li>
<li>æ¥æ”¶ç¼“å­˜ä¸­æœ‰æ•°æ®å¯ä»¥è¯»</li>
<li>tcpè¿æ¥å·²æ–­å¼€ï¼ˆå¯¹ç«¯å…³é—­äº†é“¾æ¥ï¼‰</li>
</ul>
<h4 id="ç½‘ç»œé€šè®¯-å†™äº‹ä»¶">ç½‘ç»œé€šè®¯-å†™äº‹ä»¶</h4>
<ul>
<li>å‘é€ç¼“å†²åŒºæ²¡æœ‰æ»¡ï¼Œå¯ä»¥å†™å…¥æ•°æ®(å¯ä»¥å‘å¯¹ç«¯å‘é€æŠ¥æ–‡).</li>
</ul>
<h4 id="select-çš„åŸç†">select çš„åŸç†</h4>
<p>selectä¹‹äºæœåŠ¡å™¨serverï¼Œç›¸å½“äºç§˜ä¹¦ä¹‹äºè€æ¿ï¼Œselectæ˜¯ç”±å†…æ ¸æä¾›çš„ã€‚ä¹‹å‰æ²¡æœ‰selectæ—¶ï¼Œserverè¦ä¸€ç›´accept()é˜»å¡ï¼Œç­‰å¾…æœ‰å®¢æˆ·ç«¯çš„è¿æ¥ã€‚</p>
<p>æœ‰äº†selectä¹‹åï¼Œç›¸å½“äºç»™å„ä¸ªå®¢æˆ·ç«¯ç•™ç”µè¯ï¼Œè°æœ‰äº‹å°±ç»™ç§˜ä¹¦æ‰“ç”µè¯ï¼Œç„¶åç§˜ä¹¦å‘Šè¯‰è€æ¿å»è°ƒç”¨accept()ï¼Œåˆ›å»ºcfdï¼Œå’Œå®¢æˆ·ç«¯å»ºç«‹è¿æ¥ã€‚</p>
<p>selectè‡ªå·±ä¸ä¼šåˆ›å»ºå‡ºcfdï¼Œä¸å®¢æˆ·ç«¯è¿æ¥ã€‚</p>
<p>æ‰€ä»¥selectåšçš„å°±æ˜¯ç›‘å¬ï¼Œlfdã€‚å…¶å®è¯·æ±‚è¿æ¥æœ¬è´¨æ˜¯ä¸€ä¸ªè¯»äº‹ä»¶ï¼Œåªæ˜¯è¯»åˆ°çš„æ•°æ®æ˜¯è¿æ¥è¯·æ±‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-109.png" alt="Alt text"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-125.png" alt="alt text"></p>
<h4 id="select-å‡½æ•°çš„ä½¿ç”¨">select å‡½æ•°çš„ä½¿ç”¨</h4>
<h5 id="selectå‡½æ•°çš„å£°æ˜">selectå‡½æ•°çš„å£°æ˜</h5>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¤´æ–‡ä»¶ </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="comment">//æˆåŠŸè¿”å›å¤§äº0çš„æ•°ï¼Œå¤±è´¥è¿”å›-1ï¼›è¿™ä¸ªå¤§äº0çš„æ•°æ˜¯å‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦æ•°ï¼Œè¿”å›0å°±æ˜¯æ²¡æœ‰å“ªä¸ªæ–‡ä»¶æè¿°ç¬¦æœ‰äº‹ä»¶</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">select</span><span class="params">(<span class="type">int</span> maxfd, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, <span class="keyword">struct</span> timeval *timeout)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// ç”¨äºä»bitmapä¸­åˆ é™¤socket</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FD_CLR</span><span class="params">(<span class="type">int</span> fd, fd_set *set)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç”¨äºè¯¢é—®socket æ˜¯å¦å­˜åœ¨äºbitmap</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">FD_ISSET</span><span class="params">(<span class="type">int</span> fd, fd_set *set)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç”¨äºå°†socket å­˜å…¥bitmapé‡Œ</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FD_SET</span><span class="params">(<span class="type">int</span> fd, fd_set *set)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºåˆå§‹åŒ–bitmap(éƒ½ç½®ä¸º0)</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FD_ZERO</span><span class="params">(fd_set *set)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//fd_setæ˜¯ä¸€ä¸ªé›†åˆï¼Œfd_setçš„sizeå€¼åœ¨linuxä¸‹ä¸€èˆ¬è¢«å®šä¹‰ä¸º1024ï¼Œæ„æ€æ˜¯selectç®¡ç†çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡ä¸èƒ½å¤§äº1024ï¼Œç»§è€Œæ–‡ä»¶æè¿°ç¬¦å–å€¼ä¸º0~1023</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//readsetã€ writesetã€exceptsetåˆ†åˆ«å¯¹åº”æ–‡ä»¶æè¿°ç¬¦çš„ä¸‰ç§äº‹ä»¶ï¼Œåˆ†åˆ«æ˜¯è¯»äº‹ä»¶ï¼Œå†™äº‹ä»¶ï¼Œå¼‚å¸¸äº‹ä»¶</span></span><br><span class="line"><span class="comment">//timeoutæ˜¯è®¾ç½®çš„è¶…æ—¶æ—¶é—´ï¼Œé˜²æ­¢é™·å…¥æ— é™é˜»å¡</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h6 id="fd-setçš„æœ¬è´¨å¦‚å›¾æ‰€ç¤º">fd_setçš„æœ¬è´¨å¦‚å›¾æ‰€ç¤º</h6>
<p>æ˜¯ä¸€ä¸ªbitmapï¼ˆå…±1024ä½ï¼‰<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-110.png" alt="Alt text"></p>
<h6 id="selecæœåŠ¡å¨ç«¯ä»£ç ">selecæœåŠ¡å¨ç«¯ä»£ç </h6>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    æ­¤ç¨‹åºç”¨äºæ¼”ç¤ºé‡‡ç”¨selectæ¨¡å‹å®ç°ç½‘ç»œé€šè®¯çš„æœåŠ¡å™¨</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–æœåŠ¡å™¨çš„ç›‘å¬ç«¯å£</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">initserver</span><span class="params">(<span class="type">int</span> port)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> * argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">2</span>)&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;usage:./tcpselect port\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–æœåŠ¡ç«¯ç”¨äºç›‘å¬çš„socket</span></span><br><span class="line">    <span class="type">int</span> listensock = <span class="built_in">initserver</span>(<span class="built_in">atoi</span>(argv[<span class="number">1</span>]));</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;listensock= &quot;</span> &lt;&lt; listensock &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(listensock &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;initserver() failed.\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    fd_set readfds;                 <span class="comment">//éœ€è¦ç›‘è§†è¯»äº‹ä»¶çš„socketçš„é›†åˆï¼Œå¤§å°ä¸º16å­—èŠ‚ï¼ˆ1024ä½ï¼‰çš„ä½å›¾ï¼ˆbitmapï¼‰</span></span><br><span class="line">    <span class="built_in">FD_ZERO</span>(&amp;readfds);              <span class="comment">//åˆå§‹åŒ–readfdsï¼ŒæŠŠbitmapæ¯ä½è®¾ç½®ä¸º0</span></span><br><span class="line">    <span class="built_in">FD_SET</span>(listensock, &amp;readfds);   <span class="comment">//æŠŠæœåŠ¡ç«¯ç”¨äºç›‘æ§çš„socketåŠ å…¥readfds</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> maxfd = listensock;         <span class="comment">//readfdsä¸­socketçš„æœ€å¤§å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">timeval</span> timeout;     <span class="comment">//ç”¨äºè¡¨ç¤ºè¶…æ—¶é—´çš„ç»“æ„ä½“</span></span><br><span class="line">        timeout.tv_sec = <span class="number">10</span>;</span><br><span class="line">        timeout.tv_usec = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨selectå‡½æ•°ä¸­ï¼Œä¼šä¿®æ”¹bitmap æ‰€ä»¥è¦å¤åˆ¶ä¸€ä»½ç»™tmpfdsï¼Œåœ¨å°†tmpfdsä¼ å›ç»™select</span></span><br><span class="line">        fd_set tmpfds = readfds;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//select()ç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿ(ç›‘è§†å“ªäº›socketå‘ç”Ÿäº†äº‹ä»¶), ç¬¬ä¸‰ä¸ªä¸ºå†™äº‹ä»¶çš„bitmapï¼Œå››ä¸ªä¸ºæ£€æµ‹å¼‚å¸¸äº‹ä»¶ï¼ˆå¯ä»¥æ™®é€šIOï¼‰çš„bitmap</span></span><br><span class="line">        <span class="type">int</span> infds = <span class="built_in">select</span>(maxfd + <span class="number">1</span>, &amp;tmpfds, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, &amp;timeout);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//å¦‚æœinfds &lt; 0 è¡¨ç¤ºç”¨äºè¡¨ç¤ºè°ƒç”¨selectå¤±è´¥</span></span><br><span class="line">        <span class="keyword">if</span>(infds &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;select() failed&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœinfds == 0 è¡¨ç¤ºselectï¼ˆï¼‰è¶…æ—¶</span></span><br><span class="line">        <span class="keyword">if</span>(infds == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;timeout&quot;</span>);</span><br><span class="line">           <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¦‚æœinfds&gt;0 è¡¨ç¤ºæœ‰äº‹ä»¶å‘ç”Ÿï¼Œinfdså­˜æ”¾äº†å·²å‘ç”Ÿäº‹ä»¶çš„ä¸ªæ•°</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> eventfd = <span class="number">0</span>; eventfd &lt;= maxfd; eventfd ++)&#123;</span><br><span class="line">            <span class="comment">//å¦‚æœeventfdåœ¨bitmapä¸­æ ‡å¿—ä¸º0ï¼Œ è¡¨ç¤ºå®ƒæ²¡æœ‰äº‹ä»¶ï¼Œcontinue</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">FD_ISSET</span>(eventfd, &amp;tmpfds) == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//å¦‚æœå‘ç”Ÿäº‹ä»¶çš„æ˜¯listensockï¼Œè¡¨ç¤ºå·²è¿æ¥é˜Ÿåˆ—ä¸­æœ‰å·²ç»å‡†å¤‡å¥½çš„socket(æœ‰æ–°çš„å®¢æˆ·ç«¯è¿ä¸Šæ¥äº†)</span></span><br><span class="line">            <span class="keyword">if</span>(eventfd == listensock)&#123;</span><br><span class="line">                sockaddr_in client;</span><br><span class="line">                <span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(client);</span><br><span class="line">                <span class="type">int</span> clientsock = <span class="built_in">accept</span>(listensock, (sockaddr *)&amp;client, &amp;len);</span><br><span class="line">                <span class="keyword">if</span>(clientsock &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="built_in">perror</span>(<span class="string">&quot;accept() failed&quot;</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;accept client(socket = %d)pk.\n&quot;</span>, clientsock);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// æŠŠbitmapä¸­æ–°è¿ä¸Šæ¥çš„å®¢æˆ·ç«¯æ ‡å¿—ä½ç½®ä¸º1</span></span><br><span class="line">                <span class="built_in">FD_SET</span>(clientsock, &amp;readfds);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//æ›´æ–°maxfdçš„å€¼,å› ä¸ºå¦‚æœå»ºç«‹äº†è¿æ¥æè¿°ç¬¦ä¼šå»ºç«‹åœ¨ä¹‹å‰å»ºå®Œåçš„ä¸‹ä¸€ä½ï¼Œä¸ç®¡é‚£ä¸ªæè¿°ç¬¦æ˜¯å¦è¢«åˆ é™¤</span></span><br><span class="line">                <span class="keyword">if</span>(maxfd &lt; clientsock) maxfd = clientsock;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//å¦‚æœæ˜¯å®¢æˆ·ç«¯è¿æ¥çš„socketæœ‰äº‹ä»¶ï¼Œè¡¨ç¤ºæ¥æ”¶ç¼“å­˜ä¸­æœ‰æ•°æ®å¯ä»¥è¯»ï¼Œæˆ–è€…å®¢æˆ·ç«¯å·²æ–­å¼€è¿æ¥</span></span><br><span class="line">                <span class="type">char</span> buffer[<span class="number">1024</span>];</span><br><span class="line">                <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">recv</span>(eventfd, buffer, <span class="built_in">sizeof</span>(buffer), <span class="number">0</span>) &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="comment">//å¦‚æœå®¢æˆ·ç«¯çš„é“¾æ¥å·²ç»æ–­å¼€</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;client(eventfd = %d) disconnected.\n&quot;</span>, eventfd);</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">close</span>(eventfd);</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">FD_CLR</span>(eventfd, &amp;readfds);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//é‡æ–°è®¡ç®—maxfdçš„å€¼ï¼Œæ³¨æ„åªæœ‰å½“eventfd==maxfdæ—¶æ‰éœ€è¦è®¡ç®—</span></span><br><span class="line">                    <span class="keyword">if</span>(eventfd == maxfd)&#123;</span><br><span class="line">                        <span class="keyword">for</span>(<span class="type">int</span> i = maxfd; i &gt; <span class="number">0</span>; i --)&#123; <span class="comment">//ä»åå¾€å‰æ‰¾</span></span><br><span class="line">                            <span class="keyword">if</span>(<span class="built_in">FD_ISSET</span>(i,&amp;readfds))&#123;</span><br><span class="line">                                maxfd = i;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="comment">//å¦‚æœå®¢æˆ·ç«¯æœ‰æŠ¥æ–‡å‘è¿‡æ¥</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;recv(eventfd=%d)%s\n&quot;</span>, eventfd, buffer);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//æŠŠæ¥æ”¶åˆ°çš„æŠ¥æ–‡å†…å®¹åŸå°ä¸åŠ¨çš„å‘å›å»</span></span><br><span class="line">                    <span class="built_in">send</span>(eventfd, buffer, <span class="built_in">strlen</span>(buffer), <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–æœåŠ¡ç«¯çš„ç›‘å¬ç«¯å£</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">initserver</span><span class="params">(<span class="type">int</span> port)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> sock = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(sock &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;socket() failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> opt = <span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> len = <span class="built_in">sizeof</span>(opt);</span><br><span class="line">    <span class="built_in">setsockopt</span>(sock, SOL_SOCKET, SO_REUSEADDR,&amp;opt,len);</span><br><span class="line"></span><br><span class="line">    sockaddr_in servaddr;</span><br><span class="line">    servaddr.sin_family = AF_INET;</span><br><span class="line">    servaddr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">bind</span>(sock, (sockaddr *)&amp;servaddr, <span class="built_in">sizeof</span>(servaddr)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;bind() failed&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(sock);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">listen</span>(sock, <span class="number">5</span>) != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;listen() failed&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(sock);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sock;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="selectæ¨¡å‹çš„ç»†èŠ‚">selectæ¨¡å‹çš„ç»†èŠ‚</h4>
<h5 id="selectæ¨¡å‹-å†™äº‹ä»¶">selectæ¨¡å‹-å†™äº‹ä»¶</h5>
<ol>
<li>å¦‚æœtcpçš„å‘é€ç¼“å†²åŒºæ²¡æœ‰æ»¡ï¼Œé‚£ä¹ˆ, socketè¿æ¥æ˜¯å¯å†™çš„</li>
<li>å¦‚æœå‘é€æ•°æ®é‡å¤ªå¤§ï¼Œæˆ–ç½‘ç»œå¸¦å®½ä¸å¤Ÿï¼Œå‘é€ç¼“å†²åŒºå°±æœ‰å¡«æ»¡çš„å¯èƒ½</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    æ­¤ç¨‹åºç”¨äºæ¼”ç¤ºé‡‡ç”¨selectæ¨¡å‹å®ç°ç½‘ç»œé€šè®¯çš„æœåŠ¡å™¨</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–æœåŠ¡å™¨çš„ç›‘å¬ç«¯å£</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">initserver</span><span class="params">(<span class="type">int</span> port)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> * argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">2</span>)&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;usage:./tcpselect port\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–æœåŠ¡ç«¯ç”¨äºç›‘å¬çš„socket</span></span><br><span class="line">    <span class="type">int</span> listensock = <span class="built_in">initserver</span>(<span class="built_in">atoi</span>(argv[<span class="number">1</span>]));</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;listensock= &quot;</span> &lt;&lt; listensock &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(listensock &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;initserver() failed.\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    fd_set readfds;                 <span class="comment">//éœ€è¦ç›‘è§†è¯»äº‹ä»¶çš„socketçš„é›†åˆï¼Œå¤§å°ä¸º16å­—èŠ‚ï¼ˆ1024ä½ï¼‰çš„ä½å›¾ï¼ˆbitmapï¼‰</span></span><br><span class="line">    <span class="built_in">FD_ZERO</span>(&amp;readfds);              <span class="comment">//åˆå§‹åŒ–readfdsï¼ŒæŠŠbitmapæ¯ä½è®¾ç½®ä¸º0</span></span><br><span class="line">    <span class="built_in">FD_SET</span>(listensock, &amp;readfds);   <span class="comment">//æŠŠæœåŠ¡ç«¯ç”¨äºç›‘æ§çš„socketåŠ å…¥readfds</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> maxfd = listensock;         <span class="comment">//readfdsä¸­socketçš„æœ€å¤§å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">timeval</span> timeout;     <span class="comment">//ç”¨äºè¡¨ç¤ºè¶…æ—¶é—´çš„ç»“æ„ä½“</span></span><br><span class="line">        timeout.tv_sec = <span class="number">10</span>;</span><br><span class="line">        timeout.tv_usec = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨selectå‡½æ•°ä¸­ï¼Œä¼šä¿®æ”¹bitmap æ‰€ä»¥è¦å¤åˆ¶ä¸€ä»½ç»™tmpfdsï¼Œåœ¨å°†tmpfdsä¼ å›ç»™select</span></span><br><span class="line">        fd_set tmpfds = readfds;</span><br><span class="line">        fd_set tmpfds1 = readfds;<span class="comment">//ç”¨äºç›‘è§†å†™äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//select()ç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿ(ç›‘è§†å“ªäº›socketå‘ç”Ÿäº†äº‹ä»¶), ç¬¬ä¸‰ä¸ªä¸ºå†™äº‹ä»¶çš„bitmapï¼Œå››ä¸ªä¸ºæ£€æµ‹å¼‚å¸¸äº‹ä»¶ï¼ˆå¯ä»¥æ™®é€šIOï¼‰çš„bitmap</span></span><br><span class="line">        <span class="comment">// è¯¥å‡½æ•°è°ƒç”¨å ä¼šä¿®æ”¹bitmapï¼ŒæŠŠä¸ºå‡†å¤‡å¥½çš„ç½®ä¸º0ï¼Œæ‰€ä»¥å¾—ä¼ å…¥æ‹·è´</span></span><br><span class="line">        <span class="type">int</span> infds = <span class="built_in">select</span>(maxfd + <span class="number">1</span>, &amp;tmpfds, &amp;tmpfds1, <span class="literal">nullptr</span>, &amp;timeout);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//å¦‚æœinfds &lt; 0 è¡¨ç¤ºç”¨äºè¡¨ç¤ºè°ƒç”¨selectå¤±è´¥</span></span><br><span class="line">        <span class="keyword">if</span>(infds &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;select() failed&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœinfds == 0 è¡¨ç¤ºselectï¼ˆï¼‰è¶…æ—¶</span></span><br><span class="line">        <span class="keyword">if</span>(infds == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;timeout&quot;</span>);</span><br><span class="line">           <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰å†™äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> eventfd = <span class="number">0</span>; eventfd &lt;= maxfd; eventfd ++)&#123;</span><br><span class="line">            <span class="comment">//å¦‚æœeventfdåœ¨bitmapä¸­æ ‡å¿—ä¸º0ï¼Œ è¡¨ç¤ºå®ƒæ²¡æœ‰äº‹ä»¶ï¼Œcontinue</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">FD_ISSET</span>(eventfd, &amp;tmpfds) == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;eventfd=%då¯ä»¥å†™ã€‚\n&quot;</span>, eventfd);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¦‚æœinfds&gt;0 è¡¨ç¤ºæœ‰äº‹ä»¶å‘ç”Ÿï¼Œinfdså­˜æ”¾äº†å·²å‘ç”Ÿäº‹ä»¶çš„ä¸ªæ•°</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> eventfd = <span class="number">0</span>; eventfd &lt;= maxfd; eventfd ++)&#123;</span><br><span class="line">            <span class="comment">//å¦‚æœeventfdåœ¨bitmapä¸­æ ‡å¿—ä¸º0ï¼Œ è¡¨ç¤ºå®ƒæ²¡æœ‰äº‹ä»¶ï¼Œcontinue</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">FD_ISSET</span>(eventfd, &amp;tmpfds) == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//å¦‚æœå‘ç”Ÿäº‹ä»¶çš„æ˜¯listensockï¼Œè¡¨ç¤ºå·²è¿æ¥é˜Ÿåˆ—ä¸­æœ‰å·²ç»å‡†å¤‡å¥½çš„socket(æœ‰æ–°çš„å®¢æˆ·ç«¯è¿ä¸Šæ¥äº†)</span></span><br><span class="line">            <span class="keyword">if</span>(eventfd == listensock)&#123;</span><br><span class="line">                sockaddr_in client;</span><br><span class="line">                <span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(client);</span><br><span class="line">                <span class="comment">// accept å‡½æ•°è°ƒç”¨çš„æ—¶å€™ï¼Œ ä¼šæŠŠå®¢æˆ·ç«¯çš„å€¼å­˜å‚¨åœ¨client é‡Œ</span></span><br><span class="line">                <span class="type">int</span> clientsock = <span class="built_in">accept</span>(listensock, (sockaddr *)&amp;client, &amp;len);</span><br><span class="line">                <span class="keyword">if</span>(clientsock &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="built_in">perror</span>(<span class="string">&quot;accept() failed&quot;</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;accept client(socket = %d)pk.\n&quot;</span>, clientsock);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// æŠŠbitmapä¸­æ–°è¿ä¸Šæ¥çš„å®¢æˆ·ç«¯æ ‡å¿—ä½ç½®ä¸º1</span></span><br><span class="line">                <span class="built_in">FD_SET</span>(clientsock, &amp;readfds);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//æ›´æ–°maxfdçš„å€¼,å› ä¸ºå¦‚æœå»ºç«‹äº†è¿æ¥æè¿°ç¬¦ä¼šå»ºç«‹åœ¨ä¹‹å‰å»ºå®Œåçš„ä¸‹ä¸€ä½ï¼Œä¸ç®¡é‚£ä¸ªæè¿°ç¬¦æ˜¯å¦è¢«åˆ é™¤</span></span><br><span class="line">                <span class="keyword">if</span>(maxfd &lt; clientsock) maxfd = clientsock;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//å¦‚æœæ˜¯å®¢æˆ·ç«¯è¿æ¥çš„socketæœ‰äº‹ä»¶ï¼Œè¡¨ç¤ºæ¥æ”¶ç¼“å­˜ä¸­æœ‰æ•°æ®å¯ä»¥è¯»ï¼Œæˆ–è€…å®¢æˆ·ç«¯å·²æ–­å¼€è¿æ¥</span></span><br><span class="line">                <span class="type">char</span> buffer[<span class="number">1024</span>];</span><br><span class="line">                <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">recv</span>(eventfd, buffer, <span class="built_in">sizeof</span>(buffer), <span class="number">0</span>) &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="comment">//å¦‚æœå®¢æˆ·ç«¯çš„é“¾æ¥å·²ç»æ–­å¼€</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;client(eventfd = %d) disconnected.\n&quot;</span>, eventfd);</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">close</span>(eventfd);</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">FD_CLR</span>(eventfd, &amp;readfds);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//é‡æ–°è®¡ç®—maxfdçš„å€¼ï¼Œæ³¨æ„åªæœ‰å½“eventfd==maxfdæ—¶æ‰éœ€è¦è®¡ç®—</span></span><br><span class="line">                    <span class="keyword">if</span>(eventfd == maxfd)&#123;</span><br><span class="line">                        <span class="keyword">for</span>(<span class="type">int</span> i = maxfd; i &gt; <span class="number">0</span>; i --)&#123; <span class="comment">//ä»åå¾€å‰æ‰¾</span></span><br><span class="line">                            <span class="keyword">if</span>(<span class="built_in">FD_ISSET</span>(i,&amp;readfds))&#123;</span><br><span class="line">                                maxfd = i;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="comment">//å¦‚æœå®¢æˆ·ç«¯æœ‰æŠ¥æ–‡å‘è¿‡æ¥</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;recv(eventfd=%d)%s\n&quot;</span>, eventfd, buffer);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//æŠŠæ¥æ”¶åˆ°çš„æŠ¥æ–‡å†…å®¹åŸå°ä¸åŠ¨çš„å‘å›å»</span></span><br><span class="line">                    <span class="built_in">send</span>(eventfd, buffer, <span class="built_in">strlen</span>(buffer), <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–æœåŠ¡ç«¯çš„ç›‘å¬ç«¯å£</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">initserver</span><span class="params">(<span class="type">int</span> port)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> sock = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(sock &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;socket() failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> opt = <span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> len = <span class="built_in">sizeof</span>(opt);</span><br><span class="line">    <span class="built_in">setsockopt</span>(sock, SOL_SOCKET, SO_REUSEADDR,&amp;opt,len);</span><br><span class="line"></span><br><span class="line">    sockaddr_in servaddr;</span><br><span class="line">    servaddr.sin_family = AF_INET;</span><br><span class="line">    servaddr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">bind</span>(sock, (sockaddr *)&amp;servaddr, <span class="built_in">sizeof</span>(servaddr)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;bind() failed&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(sock);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">listen</span>(sock, <span class="number">5</span>) != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;listen() failed&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(sock);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sock;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="select-æ¨¡å‹-æ°´å¹³è§¦å‘">select æ¨¡å‹ æ°´å¹³è§¦å‘</h5>
<ul>
<li>
<p>select()ç›‘è§†çš„socketå¦‚æœå‘é€äº†äº‹ä»¶å°±ä¼šç«‹å³è¿”å›(é€šçŸ¥åº”ç”¨ç¨‹åºå¤„ç†äº‹ä»¶)ï¼Œå¦‚æœå‘ç°æ•°æ®ä¸€æ¬¡æ€§æ²¡æœ‰å¤„ç†å®Œï¼Œå°±ä¼šå†å‘é€šçŸ¥æ¥å¤„ç†ï¼Œä¹Ÿå°±æ˜¯è¯´åŸæœ¬ä¸€æ¬¡çš„ï¼Œç”¨äº†ä¸‰æ¬¡<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-111.png" alt="Alt text"></p>
</li>
<li>
<p>å¦‚æœäº‹ä»¶æ²¡æœ‰è¢«å¤„ç†ï¼Œå†æ¬¡è°ƒç”¨select()çš„æ—¶å€™ä¼šç«‹å³å†é€šçŸ¥(å› æŸç§åŸå› ä¼‘çœ äº†)</p>
</li>
</ul>
<h5 id="select-æ¨¡å‹æ€§èƒ½">select æ¨¡å‹æ€§èƒ½</h5>
<ul>
<li>1så¤§æ¦‚èƒ½å¤„ç†åäºŒä¸‡ä¸ªä¸šåŠ¡è¯·æ±‚</li>
</ul>
<h5 id="å­˜åœ¨çš„é—®é¢˜">å­˜åœ¨çš„é—®é¢˜</h5>
<ol>
<li>é‡‡ç”¨è½®è¯¢æ–¹å¼æ‰«æbitmapï¼Œæ€§èƒ½éšç€socketæ•°é‡å¢å¤šè€Œä¸‹é™</li>
<li>è°ƒç”¨ä¸€æ¬¡å°±éœ€è¦æ‹·è´ä¸€ä»½bitmap</li>
<li>bitmapçš„å¤§å°ç”±FD_SETSIZEå®è®¾ç½®ï¼Œé»˜è®¤æ˜¯1024ä¸ªï¼Œå¯ä»¥ä¿®æ”¹ä½†æ˜¯æ•ˆç‡æ›´ä½</li>
</ol>
<h3 id="POLLæ¨¡å‹">POLLæ¨¡å‹</h3>
<h4 id="pollfd-ç»“æ„ä½“">pollfd ç»“æ„ä½“</h4>
<p>è¿™ä¸ªç»“æ„ä½“æœ‰ä¸‰ä¸ªæˆå‘˜ï¼Œç¬¬ä¸€ä¸ªä¸ºsocketï¼Œç¬¬äºŒä¸ªä¸ºè¯·æ±‚äº‹ä»¶ï¼Œç¬¬ä¸‰ä¸ªä¸ºè¿”å›çš„äº‹ä»¶ï¼Œå¹¶ä¸”ä¿®æ”¹çš„æ—¶å€™åªä¼šä¿®æ”¹ç¬¬ä¸‰ä¸ªæˆå‘˜ã€‚<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-112.png" alt="Alt text"></p>
<h4 id="pollå¯è¦æ±‚socketæ•°">pollå¯è¦æ±‚socketæ•°</h4>
<p>å…¶ä¸æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥ç”±ç¨‹åºå‘˜è‡ªå·±å†³å®š</p>
<h4 id="pollfdç»“æ„ä½“æ•°ç»„åˆå§‹åŒ–çš„ç»†èŠ‚">pollfdç»“æ„ä½“æ•°ç»„åˆå§‹åŒ–çš„ç»†èŠ‚</h4>
<p>ä¸èƒ½ç”¨memset è€Œå¾—ç”¨å¾ªç¯<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-113.png" alt="Alt text"><br>
poll å¯¹socketå€¼ä¸º-1çš„ä¼šå¿½ç•¥</p>
<h4 id="pollçš„äº‹ä»¶å¸¸ç”¨">pollçš„äº‹ä»¶å¸¸ç”¨</h4>
<h5 id="è¯»äº‹ä»¶ï¼šPOLLINï¼Œ-å†™äº‹ä»¶ï¼šPOLLOUT">è¯»äº‹ä»¶ï¼šPOLLINï¼Œ å†™äº‹ä»¶ï¼šPOLLOUT</h5>
<p>å¦‚æœå³æƒ³è¯»åˆæƒ³å†™å¯ä»¥ä½¿ç”¨|æ¥è¿æ¥</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//listensock æ˜¯ç”¨äºç›‘å¬çš„socketç¬¦</span></span><br><span class="line">pollfd fds[<span class="number">2048</span>];</span><br><span class="line">fds[listensock].fd = POLLIN|POLLOUT</span><br></pre></td></tr></table></figure>
<h4 id="pollfdç»“æ„ä½“çš„ä½¿ç”¨æ–¹æ³•æœ‰ä¸¤ç§">pollfdç»“æ„ä½“çš„ä½¿ç”¨æ–¹æ³•æœ‰ä¸¤ç§</h4>
<h5 id="å¡«åœ¨ä¸è¯·æ±‚çš„socketç¬¦å·ç¼–ç ä¸€æ ·çš„ä½ç½®">å¡«åœ¨ä¸è¯·æ±‚çš„socketç¬¦å·ç¼–ç ä¸€æ ·çš„ä½ç½®</h5>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-114.png" alt="Alt text"></p>
<h5 id="å¡«åœ¨ç»“æ„ä½“æ•°ç»„æœ€å‰é¢">å¡«åœ¨ç»“æ„ä½“æ•°ç»„æœ€å‰é¢</h5>
<p>å¦‚ä¸‹å›¾çš„ä¸‰è¡Œ<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-115.png" alt="Alt text"></p>
<h5 id="ä¸¤è€…çš„åŒºåˆ«">ä¸¤è€…çš„åŒºåˆ«</h5>
<p>ç¬¬ä¸€ä¸ªå¯¹äºç¼–ç æ¥è¯´æ¯”è¾ƒæ–¹ä¾¿ï¼Œç¬¬äºŒä¸ªå¯¹æ•°ç»„åˆ©ç”¨ç‡æ›´é«˜</p>
<h4 id="pollæ¨¡å‹å­˜åœ¨çš„é—®é¢˜">pollæ¨¡å‹å­˜åœ¨çš„é—®é¢˜</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-116.png" alt="Alt text"></p>
<h4 id="pollç›¸å¯¹äºselectçš„åŒºåˆ«">pollç›¸å¯¹äºselectçš„åŒºåˆ«</h4>
<ul>
<li>å‡½æ•°åŠŸèƒ½å®ç°è¿‡ç¨‹</li>
</ul>
<p>ï¼ˆ1ï¼‰åº”ç”¨ç¨‹åºé€šè¿‡pollå‡½æ•°çš„pollfdç»“æ„ä½“å°†æ„Ÿå…´è¶£çš„æ–‡ä»¶æè¿°ç¬¦å’Œäº‹ä»¶ç±»å‹</p>
<p>ï¼ˆ2ï¼‰è°ƒç”¨pollç³»ç»Ÿè°ƒç”¨ï¼Œå°†pollfdç±»å‹çš„ç»“æ„ä½“æ•°ç»„æ‹·è´ç»™å†…æ ¸ç©ºé—´ï¼Œå†…æ ¸ç¨‹åºé‡‡ç”¨è½®è¯¢æ–¹å¼æŸ¥æ‰¾æ‰€ä¼ å…¥çš„æ•°ç»„ä¸­çš„å°±ç»ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå°†å†…æ ¸å¤„ç†ä¹‹åçš„ç»“æœé€šè¿‡reventså¸¦å›ï¼Œè¿™é‡Œçš„reventsä¸­ä¸ä½†æœ‰å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿæœ‰æœªå°±ç»ªçš„ï¼Œæ¯”selectæœ‰ä¼˜åŠ¿çš„åœ°æ–¹æ˜¯å†…æ ¸å¹¶æ²¡æœ‰ç›´æ¥åœ¨ä¼ è¿›çš„æ•°ç»„ä¸­ä¿®æ”¹çŠ¶æ€ï¼Œè€Œæ˜¯å°†ä¼ å…¥çš„æ•°ç»„æ‹·è´ä¸€ä»½è¿›è¡Œä¿®æ”¹å¹¶ç”±reventså¸¦å›ï¼Œæ‰€ä»¥ä¸‹ä¸€æ¬¡è°ƒç”¨æ—¶ä¸éœ€è¦é‡æ–°è®¾ç½®è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ï¼›ä½†æ˜¯é‡‡ç”¨è½®è¯¢æ–¹å¼æ—¶é—´å¤æ‚åº¦ä¸ºO(n)</p>
<p>ï¼ˆ3ï¼‰åº”ç”¨ç¨‹åºæ¥å—åˆ°å†…æ ¸è¿”å›çš„pollfdä¹‹åï¼ŒåŒæ ·é‡‡ç”¨è½®è¯¢æ–¹å¼å°†eventsä¸reventséå†æŸ¥æ‰¾ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(n)ï¼Œæ‰¾å‡ºå°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦</p>
<p>pollç›¸å¯¹äºselectçš„ä¼˜åŠ¿</p>
<p>pollæ‰€èƒ½ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦æ•°è¾¾åˆ°ç³»ç»Ÿå…è®¸æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°ï¼Œè€Œselectç”±äº_FD_SETSIZEçš„é™åˆ¶åªèƒ½è¾¾åˆ°1023ä¸ª</p>
<p>pollå‡½æ•°çš„ç¼ºç‚¹</p>
<p>ï¼ˆ1ï¼‰åº”ç”¨ç¨‹åºå’Œå†…æ ¸ç¨‹åºéƒ½é‡‡ç”¨è½®è¯¢æ–¹å¼æŸ¥æ‰¾å°±ç»ªæ–‡ä»¶æè¿°ç¬¦ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(n)ï¼Œ</p>
<p>ï¼ˆ2ï¼‰pollä»éœ€è¦æ¯æ¬¡è°ƒç”¨å°†æ–‡ä»¶æè¿°ç¬¦æ•°ç»„æ‹·è´ä¸€ä»½ç»™å†…æ ¸ç©ºé—´</p>
<p>ï¼ˆ3ï¼‰pollä¹‹å·¥ä½œåœ¨æ•ˆç‡ä½ä¸‹çš„LTæ¨¡å¼ä¸‹ï¼Œåœ¨æœªå¤„ç†å°±ç»ªäº‹ä»¶æ—¶ä¼šä¸€ç›´æé†’å°±ç»ªä¿¡æ¯</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-127.png" alt="alt text"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ç”¨äºæ¼”ç¤ºé‡‡ç”¨pollæ¨¡å‹å®ç°ç½‘ç»œé€šè®¯çš„æœåŠ¡ç«¯</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–æœåŠ¡ç«¯çš„ç›‘å¬ç«¯å£</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">initserver</span><span class="params">(<span class="type">int</span> port)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">2</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage:./tcppoll port\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æœåŠ¡ç«¯ç”¨äºç›‘å¬çš„çª—å£</span></span><br><span class="line">    <span class="type">int</span> listensock = <span class="built_in">initserver</span>(<span class="built_in">atoi</span>(argv[<span class="number">1</span>]));</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;listensock=&quot;</span> &lt;&lt; listensock &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(listensock &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;initserver failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºå­˜æ”¾éœ€è¦ç›‘è§†çš„socket</span></span><br><span class="line">    pollfd fds[<span class="number">2048</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ•°ç»„ï¼ŒæŠŠå…¨éƒ¨socketéƒ½è®¾ç½®ä¸º-1ï¼Œ pollä¼šå¿½ç•¥-1</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2048</span>; i ++)&#123;</span><br><span class="line">        fds[i].fd = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“ç®—è®©pollç›‘è§†listensock è¯»äº‹ä»¶</span></span><br><span class="line">    fds[listensock].fd = listensock;</span><br><span class="line">    <span class="comment">//è¯»äº‹ä»¶POLLIN å†™äº‹ä»¶POLLOUT</span></span><br><span class="line">    fds[listensock].events = POLLIN;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> maxfd = listensock; <span class="comment">// éœ€è¦ç›‘å¬çš„å®é™…å¤§å°</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="comment">//è°ƒç”¨pollç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿ(ç›‘å¬å“ªäº›socketå‘ç”Ÿäº†äº‹ä»¶)</span></span><br><span class="line">        <span class="type">int</span> infds = <span class="built_in">poll</span>(fds, maxfd + <span class="number">1</span>, <span class="number">10000</span>); <span class="comment">// è¶…æ—¶æ—¶é—´10s</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//poll å¤±è´¥</span></span><br><span class="line">        <span class="keyword">if</span>(infds &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;poll failed&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// poll è¶…æ—¶</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(infds == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;poll timeout&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// pollæ­£å¸¸è¿è¡Œ</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> eventfd = <span class="number">0</span>; eventfd &lt;= maxfd; eventfd ++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(fds[eventfd].fd &lt; <span class="number">0</span>) <span class="keyword">continue</span>; <span class="comment">//fd ä¸º-1 å°±å¿½ç•¥</span></span><br><span class="line">            <span class="comment">//æ²¡æœ‰è¯»æ—¶é—´å°±continue</span></span><br><span class="line">            <span class="keyword">if</span>(fds[eventfd].events &amp; POLLIN == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">//å¦‚æœå‘ç”Ÿçš„äº‹ä»¶æ˜¯listensock è¡¨ç¤ºå·²è¿æ¥é˜Ÿåˆ—ä¸­å·²ç»æœ‰å‡†å¤‡å¥½çš„socket(æœ‰æ–°çš„å®¢æˆ·ç«¯ç»ƒä¸Šæ¥)</span></span><br><span class="line">            <span class="keyword">if</span>(eventfd == listensock)&#123;</span><br><span class="line">                sockaddr_in client;</span><br><span class="line">                <span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(client);</span><br><span class="line">                <span class="type">int</span> clientsock = <span class="built_in">accept</span>(listensock,(sockaddr *) &amp;client, &amp;len);</span><br><span class="line">                <span class="keyword">if</span>(clientsock &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="built_in">perror</span>(<span class="string">&quot;accept(*) failed&quot;</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;accept client(socket = %d)ok.\n&quot;</span>, clientsock);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ä¿®æ”¹fdsæ•°ç»„ä¸­clientsockä½ç½®çš„å…ƒç´ </span></span><br><span class="line">                fds[clientsock].fd = clientsock;</span><br><span class="line">                fds[clientsock].events = POLLIN;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(maxfd &lt; clientsock) maxfd = clientsock; <span class="comment">// æ›´æ–°maxfd</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">// å¦‚æœæ˜¯å®¢æˆ·ç«¯è¿æ¥çš„socketæœ‰äº‹ä»¶ç›®æ ‡æ˜¯æœ‰æŠ¥æ–‡å‘è¿‡æ¥æˆ–è€…è¿æ¥å·²æ–­å¼€</span></span><br><span class="line"></span><br><span class="line">                <span class="type">char</span> buffer[<span class="number">1024</span>];</span><br><span class="line">                <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">recv</span>(eventfd, buffer, <span class="built_in">sizeof</span>(buffer), <span class="number">0</span>) &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœå®¢æˆ·ç«¯çš„é“¾æ¥å·²æ–­å¼€</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;client(eventfd = %d) disconnected.\n&quot;</span>, eventfd);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">//å…³é—­å®¢æˆ·ç«¯çš„socket</span></span><br><span class="line">                    <span class="built_in">close</span>(eventfd);</span><br><span class="line">                    fds[eventfd].fd = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//é‡æ–°è®¡ç®—maxfdçš„å€¼ï¼Œåªæœ‰å½“eventfdç­‰äºmaxfdæ‰å¼€å§‹è®¡ç®—</span></span><br><span class="line">                    <span class="keyword">if</span>(eventfd == maxfd)&#123;</span><br><span class="line">                        <span class="keyword">for</span>(<span class="type">int</span> i = maxfd; i &gt; <span class="number">0</span>; i --)&#123;</span><br><span class="line">                            <span class="keyword">if</span>(fds[i].fd != <span class="number">-1</span>)&#123;</span><br><span class="line">                                maxfd = i;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœå®¢æˆ·ç«¯æœ‰æŠ¥æ–‡å‘è¿‡æ¥</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;recv(eventfd = %d).%s\n&quot;</span>, eventfd,buffer);</span><br><span class="line">                    <span class="comment">//æŠŠæ¥æ”¶åˆ°çš„æŠ¥æ–‡å†…å®¹åŸå°ä¸åŠ¨çš„å‘å›å»</span></span><br><span class="line">                    <span class="built_in">send</span>(eventfd, buffer, <span class="built_in">strlen</span>(buffer), <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–æœåŠ¡ç«¯çš„ç›‘å¬ç«¯å£</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">initserver</span><span class="params">(<span class="type">int</span> port)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sock = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(sock &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;socket() failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="comment">// TIME_WAITçŠ¶æ€è¿˜åœ¨ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥æ‰“å¼€,ç”¨æ¥æ‰“å¼€/å…³é—­åœ°å€å¤ç”¨åŠŸèƒ½ï¼Œ1ä¸ºæ‰“å¼€ï¼Œ0ä¸ºå…³é—­</span></span><br><span class="line">    <span class="type">int</span> opt = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">setsockopt</span>(sock, SOL_SOCKET, SO_REUSEADDR, &amp;opt,<span class="built_in">sizeof</span>(opt));</span><br><span class="line"></span><br><span class="line">    sockaddr_in servaddr;</span><br><span class="line">    servaddr.sin_family = AF_INET;</span><br><span class="line">    servaddr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">bind</span>(sock, (sockaddr *) &amp;servaddr, <span class="built_in">sizeof</span>(servaddr)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;bind() failed&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(sock);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">listen</span>(sock, <span class="number">5</span>) != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;listen() failed&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(sock);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sock;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="epollæ¨¡å‹">epollæ¨¡å‹</h3>
<ul>
<li>epollå®ä¾‹çš„åˆ›é€ (ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦)</li>
</ul>
<h4 id="epoll-create-å‡½æ•°">epoll_create()å‡½æ•°</h4>
<p>è¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥åˆ›é€ epollçš„ï¼Œå‚æ•°ä¸ºä¸€ä¸ªæ•´æ•°ï¼Œè¿™ä¸ªå‚æ•°åœ¨Linux2.6.8ä¹‹åè¢«å¿½ç•¥ï¼Œåªè¦å¡«å¤§äº0å°±è¡Œ</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> epollfd = <span class="built_in">epoll_create</span>(<span class="number">1</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="epoll-ctl-å‡½æ•°">epoll_ctl()å‡½æ•°</h4>
<p>epoll_ctl å‡½æ•°</p>
<ul>
<li>int epoll_ctl(int epfd, int op, int fd, struct - - epoll_event *event);</li>
<li>åŠŸèƒ½ï¼šepoll çš„äº‹ä»¶æ³¨å†Œå‡½æ•°ï¼Œå®ƒä¸åŒäº select() æ˜¯åœ¨ç›‘å¬äº‹ä»¶æ—¶å‘Šè¯‰å†…æ ¸è¦ç›‘å¬ä»€ä¹ˆç±»å‹çš„äº‹ä»¶ï¼Œè€Œæ˜¯åœ¨è¿™é‡Œå…ˆæ³¨å†Œè¦ç›‘å¬çš„äº‹ä»¶ç±»å‹ã€‚</li>
<li>å‚æ•°epfd: epoll ä¸“ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œepoll_create()çš„è¿”å›å€¼</li>
<li>å‚æ•°op: è¡¨ç¤ºåŠ¨ä½œï¼Œç”¨ä¸‰ä¸ªå®æ¥è¡¨ç¤ºï¼š<br>
EPOLL_CTL_ADDï¼šæ³¨å†Œæ–°çš„ fd åˆ° epfd ä¸­ï¼›<br>
EPOLL_CTL_MODï¼šä¿®æ”¹å·²ç»æ³¨å†Œçš„fdçš„ç›‘å¬äº‹ä»¶ï¼›<br>
EPOLL_CTL_DELï¼šä» epfd ä¸­åˆ é™¤ä¸€ä¸ª fdï¼›</li>
<li>å‚æ•°fd: éœ€è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦</li>
<li>å‚æ•°event: å‘Šè¯‰å†…æ ¸è¦ç›‘å¬ä»€ä¹ˆäº‹ä»¶ï¼Œstruct epoll_event ç»“æ„å¦‚:<br>
eventså¯ä»¥æ˜¯ä»¥ä¸‹å‡ ä¸ªå®çš„é›†åˆï¼š<br>
EPOLLIN ï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¯»ï¼ˆåŒ…æ‹¬å¯¹ç«¯ SOCKET æ­£å¸¸å…³é—­ï¼‰ï¼›<br>
EPOLLOUTï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥å†™ï¼›<br>
EPOLLPRIï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦æœ‰ç´§æ€¥çš„æ•°æ®å¯è¯»ï¼ˆè¿™é‡Œåº”è¯¥è¡¨ç¤ºæœ‰å¸¦å¤–æ•°æ®åˆ°æ¥ï¼‰ï¼›<br>
EPOLLERRï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯ï¼›<br>
EPOLLHUPï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦è¢«æŒ‚æ–­ï¼›<br>
EPOLLET ï¼šå°† EPOLL è®¾ä¸ºè¾¹ç¼˜è§¦å‘(Edge Trigger)æ¨¡å¼ï¼Œè¿™æ˜¯ç›¸å¯¹äºæ°´å¹³è§¦å‘(Level Trigger)æ¥è¯´çš„ã€‚<br>
EPOLLONESHOTï¼šåªç›‘å¬ä¸€æ¬¡äº‹ä»¶ï¼Œå½“ç›‘å¬å®Œè¿™æ¬¡äº‹ä»¶ä¹‹åï¼Œå¦‚æœè¿˜éœ€è¦ç»§ç»­ç›‘å¬è¿™ä¸ª socket çš„è¯ï¼Œéœ€è¦å†æ¬¡æŠŠè¿™ä¸ª socket åŠ å…¥åˆ° EPOLL é˜Ÿåˆ—é‡Œ</li>
<li>è¿”å›å€¼ï¼š0è¡¨ç¤ºæˆåŠŸï¼Œ-1è¡¨ç¤ºå¤±è´¥ã€‚</li>
</ul>
<h4 id="epoll-waitå‡½æ•°">epoll_waitå‡½æ•°</h4>
<ul>
<li><strong>int epoll_wait(int epfd, struct epoll_event * events, int maxevents, int timeout);</strong></li>
<li><strong>åŠŸèƒ½</strong>ï¼šç­‰å¾…äº‹ä»¶çš„äº§ç”Ÿï¼Œæ”¶é›†åœ¨ epoll ç›‘æ§çš„äº‹ä»¶ä¸­å·²ç»å‘é€çš„äº‹ä»¶ï¼Œç±»ä¼¼äº select() è°ƒç”¨ã€‚</li>
<li><strong>å‚æ•°epfd</strong>: epoll ä¸“ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œepoll_create()çš„è¿”å›å€¼</li>
<li><strong>å‚æ•°events</strong>: åˆ†é…å¥½çš„ epoll_event ç»“æ„ä½“æ•°ç»„ï¼Œepoll å°†ä¼šæŠŠå‘ç”Ÿçš„äº‹ä»¶èµ‹å€¼åˆ°events æ•°ç»„ä¸­ï¼ˆevents ä¸å¯ä»¥æ˜¯ç©ºæŒ‡é’ˆï¼Œå†…æ ¸åªè´Ÿè´£æŠŠæ•°æ®å¤åˆ¶åˆ°è¿™ä¸ª events æ•°ç»„ä¸­ï¼Œä¸ä¼šå»å¸®åŠ©æˆ‘ä»¬åœ¨ç”¨æˆ·æ€ä¸­åˆ†é…å†…å­˜ï¼‰ã€‚</li>
<li><strong>å‚æ•°maxevents</strong>: maxevents å‘Šä¹‹å†…æ ¸è¿™ä¸ª events æœ‰å¤šå°‘ä¸ª ã€‚</li>
<li><strong>å‚æ•°timeout</strong>: è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼Œä¸º -1 æ—¶ï¼Œå‡½æ•°ä¸ºé˜»å¡ã€‚</li>
<li><strong>è¿”å›å€¼</strong>ï¼š<br>
å¦‚æœæˆåŠŸï¼Œè¡¨ç¤ºè¿”å›éœ€è¦å¤„ç†çš„äº‹ä»¶æ•°ç›®<br>
å¦‚æœè¿”å›0ï¼Œè¡¨ç¤ºå·²è¶…æ—¶<br>
å¦‚æœè¿”å›-1ï¼Œè¡¨ç¤ºå¤±è´¥</li>
</ul>
<h4 id="epollçš„ç›¸å…³ç»“æ„ä½“">epollçš„ç›¸å…³ç»“æ„ä½“</h4>
<h5 id="epoll-event">epoll_event</h5>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">epoll_event</span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> events; <span class="comment">//äº‹ä»¶</span></span><br><span class="line">    <span class="type">epoll_data_t</span> data; <span class="comment">//ç”¨æˆ·å¯ç”¨æ•°æ®</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> <span class="title class_">epoll_data</span>&#123;</span><br><span class="line">    <span class="type">void</span> *ptr;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="type">uint32_t</span>;</span><br><span class="line">    <span class="type">uint64_t</span>;</span><br><span class="line">&#125;<span class="type">epoll_data_t</span>;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-128.png" alt="alt text"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-129.png" alt="alt text"></p>
<ul>
<li>
<p>epollçš„è§†é¢‘æ¼”ç¤ºåœ¨åŒçº§ç›®å½•ä¸‹</p>
</li>
<li>
<p><strong>epollä¸ºä»€ä¹ˆå¿«?</strong></p>
</li>
<li>
<p>äº‹ä»¶è§¦å‘æ¨¡å¼ äº‹ä»¶åˆ°æ¥å”¤é†’fdçš„ç­‰å¾…é˜Ÿåˆ—ä¸­çš„è¿›ç¨‹ï¼Œå›è°ƒè¿›ç¨‹ä¹‹å‰çš„æ³¨å†Œçš„å›è°ƒå‡½æ•°ep_poll_callback ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°å®é™…ä¸Šå°±æ˜¯å°†çº¢é»‘æ ‘ä¸Šæ”¶åˆ°eventçš„epitemæ’å…¥åˆ°å®ƒçš„å°±ç»ªé˜Ÿåˆ—ä¸­å¹¶å”¤é†’è°ƒç”¨epoll_waitè¿›ç¨‹ã€‚ä¸ç”¨é€ä¸ªéå†</p>
</li>
</ul>
<h5 id="epollæœåŠ¡ç«¯ä»£ç ">epollæœåŠ¡ç«¯ä»£ç </h5>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ç”¨äºæ¼”ç¤ºé‡‡ç”¨epollæ¨¡å‹å®ç°ç½‘ç»œé€šè®¯çš„æœåŠ¡ç«¯</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/fcbtl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–æœåŠ¡ç«¯çš„ç›‘å¬ç«¯å£</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">initserver</span><span class="params">(<span class="type">int</span> port)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">2</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage:./tcppoll port\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æœåŠ¡ç«¯ç”¨äºç›‘å¬çš„çª—å£</span></span><br><span class="line">    <span class="type">int</span> listensock = <span class="built_in">initserver</span>(<span class="built_in">atoi</span>(argv[<span class="number">1</span>]));</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;listensock=&quot;</span> &lt;&lt; listensock &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(listensock &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;initserver failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºepollå¥æŸ„</span></span><br><span class="line">    <span class="type">int</span> epollfd = <span class="built_in">epoll_create</span>(<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ•°ç»„ï¼ŒæŠŠå…¨éƒ¨socketéƒ½è®¾ç½®ä¸º-1ï¼Œ pollä¼šå¿½ç•¥-1</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2048</span>; i ++)&#123;</span><br><span class="line">        fds[i].fd = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¸ºæœåŠ¡ç«¯çš„listensockå‡†å¤‡å¯è¯»äº‹ä»¶</span></span><br><span class="line">    epoll_event ev; <span class="comment">//å£°æ˜äº‹ä»¶çš„æ•°æ®ç»“æ„</span></span><br><span class="line">    ev.data.fd = listensock; <span class="comment">//æŒ‡å®šäº‹ä»¶çš„è‡ªå®šä¹‰æ•°æ®ï¼Œä¼šéšç€epoll_wait()è¿”å›çš„äº‹ä»¶ä¸€å¹¶è¿”å›</span></span><br><span class="line">    ev.events = EPOLLIN; <span class="comment">//æ‰“ç®—è®©epollç›‘è§†çš„listensockçš„è¯»äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, listensock, &amp;ev); <span class="comment">// æŠŠéœ€è¦ç›‘è§†çš„socketåŠ å…¥epollfdä¸­</span></span><br><span class="line">    epoll_event evs[<span class="number">10</span>]; <span class="comment">//å­˜æ”¾epollè¿”å›çš„äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="comment">//ç­‰å¾…ç›‘è§†çš„socketæœ‰äº‹ä»¶å‘ç”Ÿ</span></span><br><span class="line">        <span class="type">int</span> infds = <span class="built_in">epoll_wait</span>(epollfd, evs, <span class="number">10</span>, <span class="number">-1</span>); <span class="comment">// ä¸è®¾ç½®è¶…æ—¶æ—¶é—´</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//epoll å¤±è´¥</span></span><br><span class="line">        <span class="keyword">if</span>(infds &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;poll failed&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// epoll è¶…æ—¶</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(infds == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;poll timeout&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// epollæ­£å¸¸è¿è¡Œ</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; infds; i ++)&#123; <span class="comment">// éå†epollçš„è¿”å›æ•°ç»„evs</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//printf(&quot;socket=%d,events=%d\n&quot;,evs[i].data.fd, evs[i].events);</span></span><br><span class="line">        </span><br><span class="line">            <span class="comment">//å¦‚æœå‘ç”Ÿçš„äº‹ä»¶æ˜¯listensock è¡¨ç¤ºå·²è¿æ¥é˜Ÿåˆ—ä¸­å·²ç»æœ‰å‡†å¤‡å¥½çš„socket(æœ‰æ–°çš„å®¢æˆ·ç«¯ç»ƒä¸Šæ¥)</span></span><br><span class="line">            <span class="keyword">if</span>(evs[i].data.fd == listensock)&#123;</span><br><span class="line">                sockaddr_in client;</span><br><span class="line">                <span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(client);</span><br><span class="line">                <span class="type">int</span> clientsock = <span class="built_in">accept</span>(listensock,(sockaddr *) &amp;client, &amp;len);</span><br><span class="line">                <span class="keyword">if</span>(clientsock &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="built_in">perror</span>(<span class="string">&quot;accept(*) failed&quot;</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;accept client(socket = %d)ok.\n&quot;</span>, clientsock);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ä¸ºæ–°å®¢æˆ·ç«¯å‡†å¤‡å¯è¯»äº‹ä»¶ï¼Œå¹¶æ·»åŠ åˆ°epollä¸­</span></span><br><span class="line">                ev.data.fd = clientsock;</span><br><span class="line">                ev.events = EPOLLIN;</span><br><span class="line">                <span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, clientsock, &amp;ev);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">// å¦‚æœæ˜¯å®¢æˆ·ç«¯è¿æ¥çš„socketæœ‰äº‹ä»¶ç›®æ ‡æ˜¯æœ‰æŠ¥æ–‡å‘è¿‡æ¥æˆ–è€…è¿æ¥å·²æ–­å¼€</span></span><br><span class="line"></span><br><span class="line">                <span class="type">char</span> buffer[<span class="number">1024</span>];</span><br><span class="line">                <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">recv</span>(evs[i].data.fd, buffer, <span class="built_in">sizeof</span>(buffer), <span class="number">0</span>) &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœå®¢æˆ·ç«¯çš„é“¾æ¥å·²æ–­å¼€</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;client(eventfd = %d) disconnected.\n&quot;</span>, evs[i].data.fd);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">//å…³é—­å®¢æˆ·ç«¯çš„socket</span></span><br><span class="line">                    <span class="built_in">close</span>(evs[i].data.fd);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœå®¢æˆ·ç«¯æœ‰æŠ¥æ–‡å‘è¿‡æ¥</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;recv(eventfd = %d).%s\n&quot;</span>,evs[i].data.fd,buffer);</span><br><span class="line">                    <span class="comment">//æŠŠæ¥æ”¶åˆ°çš„æŠ¥æ–‡å†…å®¹åŸå°ä¸åŠ¨çš„å‘å›å»ï¼Œå¦‚æœæ¥æ”¶ç¼“å†²åŒºæ»¡äº†å°±ä¼šé˜»å¡</span></span><br><span class="line">                    <span class="built_in">send</span>(evs[i].data.fd, buffer, <span class="built_in">strlen</span>(buffer), <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–æœåŠ¡ç«¯çš„ç›‘å¬ç«¯å£</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">initserver</span><span class="params">(<span class="type">int</span> port)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sock = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(sock &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;socket() failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="comment">// TIME_WAITçŠ¶æ€è¿˜åœ¨ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥æ‰“å¼€,ç”¨æ¥æ‰“å¼€/å…³é—­åœ°å€å¤ç”¨åŠŸèƒ½ï¼Œ1ä¸ºæ‰“å¼€ï¼Œ0ä¸ºå…³é—­</span></span><br><span class="line">    <span class="type">int</span> opt = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">setsockopt</span>(sock, SOL_SOCKET, SO_REUSEADDR, &amp;opt,<span class="built_in">sizeof</span>(opt));</span><br><span class="line"></span><br><span class="line">    sockaddr_in servaddr;</span><br><span class="line">    servaddr.sin_family = AF_INET;</span><br><span class="line">    servaddr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">bind</span>(sock, (sockaddr *) &amp;servaddr, <span class="built_in">sizeof</span>(servaddr)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;bind() failed&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(sock);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">listen</span>(sock, <span class="number">5</span>) != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;listen() failed&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(sock);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sock;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="é˜»å¡I-O-ä¸-éé˜»å¡I-O">é˜»å¡I/O ä¸ éé˜»å¡I/O</h3>
<ul>
<li>é˜»å¡: åœ¨è¿›/çº¿ç¨‹ä¸­ï¼Œå‘èµ·ä¸€ä¸ªè°ƒç”¨æ—¶ï¼Œåœ¨è°ƒç”¨è¿”å›å‰ï¼Œè¿›/çº¿ç¨‹ä¼šè¢«é˜»å¡ç­‰å¾…ï¼Œç­‰å¾…ä¸­çš„è¿›/çº¿è®©å‡ºCPUçš„ä½¿ç”¨æƒ</li>
<li>éé˜»å¡: åœ¨è¿›/çº¿ç¨‹ä¸­ï¼Œå‘èµ·ä¸€ä¸ªè°ƒç”¨æ—¶ï¼Œä¼šç«‹å³è¿”å›</li>
<li>ä¼šé˜»å¡çš„å››ä¸ªå‡½æ•°:connect(), accept(), send(), recv()</li>
</ul>
<h4 id="é˜»å¡ä¸éé˜»å¡IOçš„åº”ç”¨åœºæ™¯">é˜»å¡ä¸éé˜»å¡IOçš„åº”ç”¨åœºæ™¯</h4>
<ul>
<li>åœ¨ä¼ ç»Ÿçš„ç½‘ç»œæœåŠ¡ç«¯ç¨‹åºä¸­ï¼ˆæ¯è¿æ¥æ¯çº¿/è¿›ç¨‹ï¼‰ï¼Œ é‡‡ç”¨é˜»å¡IO</li>
<li>åœ¨IOå¤ç”¨æ¨¡å‹ä¸­ æ˜¯é‡‡ç”¨éé˜»å¡IOï¼Œåœ¨äº‹ä»¶å¾ªç¯ä¸­æ˜¯ä¸èƒ½è¢«é˜»å¡çš„</li>
</ul>
<h4 id="éé˜»å¡IO-connect-å‡½æ•°">éé˜»å¡IO-connect()å‡½æ•°</h4>
<ul>
<li>å¯¹éé˜»å¡çš„IOè°ƒç”¨connect()å‡½æ•°ï¼Œä¸ç®¡æ˜¯å¦èƒ½è¿æ¥æˆåŠŸï¼Œconnect()éƒ½ä¼šç«‹å³è¿”å›å¤±è´¥ï¼Œerrno == EINPROGRESS</li>
<li>å¯¹éé˜»å¡çš„IOè°ƒç”¨connect()å‡½æ•°åï¼Œå¦‚æœsocketçš„çŠ¶æ€æ˜¯å¯å†™çš„ï¼Œè¯æ˜è¿æ¥æ˜¯æˆåŠŸçš„ï¼Œå¦åˆ™æ˜¯å¤±è´¥çš„</li>
</ul>
<p><em><strong>å¯¹äºä¸Šé¢ä¸¤å¥è¯çš„è¯¦ç»†è§£é‡Š</strong></em></p>
<ul>
<li>
<p>é¦–å…ˆconnect()å‡½æ•°æ˜¯å‘ç”Ÿåœ¨å®¢æˆ·ç«¯çš„ï¼Œå½“å®ƒä½¿ç”¨ä»¥ä¸‹æ–¹æ³•å˜ä¸ºéé˜»å¡æ¨¡å¼çš„æ—¶å€™ï¼Œä¸ç®¡è¿æ¥æˆåŠŸä¸å¦éƒ½ä¼šå¤±è´¥</p>
</li>
<li>
<p>ä»¥ä¸‹ä»£ç æ˜¯å°†æ­¤å¥—æ¥å­—è®¾ç½®ä¸ºéé˜»å¡çŠ¶æ€</p>
</li>
<li></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">setnonblocking</span><span class="params">(<span class="type">int</span> fd)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> flags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–fdçš„çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span>(flags = <span class="built_in">fcntl</span>(fd, F_GETFL, <span class="number">0</span>) == <span class="number">-1</span>)&#123;</span><br><span class="line">         flags = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">fcntl</span>(fd, F_SETTFL, flags|O_NONBKLOCK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿™æ ·çš„è¯æ€ä¹ˆåˆ¤æ–­æ˜¯å¦è¿æ¥æˆåŠŸå‘¢ï¼Ÿ</li>
<li>éœ€è¦åœ¨è¿æ¥çš„åœ°æ–¹åŠ å…¥ä¸€ä¸ªåˆ¤æ–­</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="built_in">connect</span>(sockfd, (sockaddr *)&amp;servaddr, <span class="built_in">sizeof</span>(servaddr)) != <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(errno!=EINPROGRESS)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;connect(%s:%s)failed.\n&quot;</span>, argv[<span class="number">1</span>], argv[<span class="number">2</span>]);</span><br><span class="line">        <span class="built_in">close</span>(sockfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å†çœ‹socketæ˜¯å¦å¯å†™</span></span><br><span class="line">pollfd fds;</span><br><span class="line">fds.fd = sockfd;</span><br><span class="line">fds.events = POLLOUT;</span><br><span class="line"><span class="built_in">poll</span>(&amp;fds, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"><span class="keyword">if</span>(fds.revents == POLLOUT) <span class="built_in">printf</span>(<span class="string">&quot;connect ok\n&quot;</span>);</span><br><span class="line"><span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">&quot;connect failed\n&quot;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="éé˜»å¡IO-accept-å‡½æ•°">éé˜»å¡IO accept()å‡½æ•°</h4>
<ul>
<li>å¯¹éé˜»å¡çš„IOè°ƒç”¨accept(), å¦‚æœå·²è¿æ¥é˜Ÿåˆ—ä¸­æ²¡æœ‰socketï¼Œ å‡½æ•°ç«‹å³è¿”å›å¤±è´¥, errno == EAGAIN;</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setnonblocking</span>(listensock);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="éé˜»å¡IO-recv">éé˜»å¡IO recv</h4>
<ul>
<li>å¯¹éé˜»å¡çš„IOè°ƒç”¨recv()ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®å¯è¯»(æ¥æ”¶ç¼“å†²åŒºä¸ºç©º)ï¼Œ å‡½æ•°ç«‹å³è¿”å›å¤±è´¥ï¼Œ errno == EAGAIN</li>
</ul>
<h4 id="éé˜»å¡IO-send">éé˜»å¡IO send()</h4>
<ul>
<li>å¯¹éé˜»å¡IOè°ƒç”¨send()ï¼Œ å¦‚æœsocket ä¸å¯å†™(å‘é€ç¼“å†²åŒºå·²æ»¡), å‡½æ•°ç«‹å³è¿”å›å¤±è´¥ï¼Œerrno==EAGAIN</li>
</ul>
<h3 id="æ°´å¹³è§¦å‘ä¸è¾¹ç¼˜è§¦å‘">æ°´å¹³è§¦å‘ä¸è¾¹ç¼˜è§¦å‘</h3>
<ul>
<li>select å’Œ poll é‡‡ç”¨ <em><strong>æ°´å¹³è§¦å‘</strong></em></li>
<li>epoll æ—¢æœ‰ <em><strong>æ°´å¹³è§¦å‘</strong></em> åˆæœ‰ <em><strong>è¾¹ç¼˜è§¦å‘</strong></em>, é»˜è®¤æ°´å¹³è§¦å‘</li>
</ul>
<h4 id="æ°´å¹³è§¦å‘å«ä¹‰">æ°´å¹³è§¦å‘å«ä¹‰</h4>
<ul>
<li>è¯»äº‹ä»¶ï¼šå¦‚æœepoll_waitè§¦å‘äº†è¯»äº‹ä»¶ï¼Œè¡¨ç¤ºæœ‰æ•°æ®å¯è¯»ï¼Œå¦‚æœç¨‹åºæ²¡æœ‰æŠŠæ•°æ®è¯»å®Œï¼Œå†æ¬¡è°ƒç”¨epoll_waitçš„æ—¶å€™ï¼Œå°†ç«‹å³å†æ¬¡è§¦å‘è¯»äº‹ä»¶</li>
<li>å†™äº‹ä»¶: å¦‚æœå‘é€ç¼“å†²åŒºæ²¡æœ‰æ»¡ï¼Œè¡¨ç¤ºå¯ä»¥å†™å…¥æ•°æ®ï¼Œæ­¤æ—¶å¦‚æœå†æ¬¡è°ƒç”¨epoll_waitçš„æ—¶å€™ï¼Œå°†ç«‹å³å†æ¬¡è§¦å‘å†™äº‹ä»¶</li>
</ul>
<h4 id="è¾¹ç¼˜è§¦å‘çš„å«ä¹‰">è¾¹ç¼˜è§¦å‘çš„å«ä¹‰</h4>
<ul>
<li>
<p>å¯¹äºè¯»äº‹ä»¶ï¼šepoll_waitè§¦å‘è¯»äº‹ä»¶åï¼Œä¸ç®¡ç¨‹åºæœ‰æ²¡æœ‰å¤„ç†è¯»äº‹ä»¶ï¼Œepoll_waitä¸ä¼šå†è§¦å‘è¯»äº‹ä»¶,åªæœ‰æ–°æ•°æ®åˆ°è¾¾æ‰ä¼šè§¦å‘ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°æ®ä»<strong>æ— åˆ°æœ‰æˆ–è€…ä»å°‘åˆ°å¤š</strong>çš„æ—¶å€™ï¼Œä¼šé€šçŸ¥ï¼Œç±»ä¼¼èœé¸Ÿé©¿ç«™</p>
</li>
<li>
<p>å¯¹äºå†™äº‹ä»¶ï¼šepoll_waitè§¦å‘è¯»äº‹ä»¶åï¼Œå¦‚æœå‘é€ç¼“å†²åŒºæ²¡æ»¡ï¼Œepoll_waitä¸ä¼šå†è§¦å‘å†™äº‹ä»¶, åªç”¨å½“å‘é€ç¼“å†²åŒºç”±<strong>æ»¡</strong>å˜æˆ<strong>ä¸æ»¡</strong>æ—¶ï¼Œæ‰å†æ¬¡è§¦å‘å†™äº‹ä»¶</p>
</li>
<li>
<p>å¦‚æœepollä½¿ç”¨è¾¹ç¼˜è§¦å‘ä¸€å®šè¦è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼</p>
</li>
<li>
<p>æœ‰æ–°å®¢æˆ·ç«¯è¿æ¥æƒ…å†µ<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-117.png" alt="alt text"></p>
</li>
<li>
<p>å¯¹äºæ¥æ”¶å‘é€æŠ¥æ–‡çš„æ—¶å€™å¦‚æœä½¿ç”¨è¾¹ç¼˜è§¦å‘è¦è¿™ä¹ˆç¼–ç ï¼Œå› ä¸ºè¿™æ ·æ‰èƒ½è¯»å®Œ</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-118.png" alt="alt text"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å°†epollè®¾ç½®ä¸ºè¾¹ç¼˜è§¦å‘</span></span><br><span class="line">ev.events = EPOLLOUT|EPOLLET;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="image-119.png" alt="alt text"></p>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>ç½‘ç»œç¼–ç¨‹æ•™ç¨‹</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://pigcanstudy.github.io/posts/95787e92.html">https://pigcanstudy.github.io/posts/95787e92.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>ä½œè€…</h><div class="post-copyright-cc-info"><h>PigCanStudy</h></div></div><div class="post-copyright-c"><h>å‘å¸ƒäº</h><div class="post-copyright-cc-info"><h>2024-07-16</h></div></div><div class="post-copyright-u"><h>æ›´æ–°äº</h><div class="post-copyright-cc-info"><h>2024-07-16</h></div></div><div class="post-copyright-c"><h>è®¸å¯åè®®</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>Linux</a><a class="post-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>ç½‘ç»œç¼–ç¨‹</a></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">æŠ•å–‚ä½œè€…</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://tuchuang.voooe.cn/images/2023/01/04/2.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://tuchuang.voooe.cn/images/2023/01/04/2.webp" alt="å¾®ä¿¡"/></a><div class="post-qr-code-desc">å¾®ä¿¡</div></li><li class="reward-item"><a href="https://tuchuang.voooe.cn/images/2023/01/04/20f8e49805975b8f8.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://tuchuang.voooe.cn/images/2023/01/04/20f8e49805975b8f8.webp" alt="æ”¯ä»˜å®"/></a><div class="post-qr-code-desc">æ”¯ä»˜å®</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/0.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_14.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info"></div></div></a></div><div class="next-post pull-right"><a href="/posts/2013454d.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_14.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">Markdownè¯­æ³•ä¸å¤–æŒ‚æ ‡ç­¾å†™æ³•æ±‡æ€»</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><svg class="meta_icon" style="width:22px;height:22px;position:relative;top:5px"><use xlink:href="#icon-mulu1"></use></svg><span style="font-weight:bold">ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">ç›®å½•</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86"><span class="toc-text">ç¬¬ä¸€éƒ¨åˆ†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%BA%93%E4%B8%8E%E5%8A%A8%E6%80%81%E5%BA%93%E7%9A%84%E5%BB%BA%E7%AB%8B"><span class="toc-text">é™æ€åº“ä¸åŠ¨æ€åº“çš„å»ºç«‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%BA%93%E7%9A%84%E5%BB%BA%E7%AB%8B%E5%92%8C%E4%BD%BF%E7%94%A8"><span class="toc-text">é™æ€åº“çš„å»ºç«‹å’Œä½¿ç”¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%BA%93%E7%9A%84%E5%BB%BA%E7%AB%8B%E5%92%8C%E4%BD%BF%E7%94%A8"><span class="toc-text">åŠ¨æ€åº“çš„å»ºç«‹å’Œä½¿ç”¨</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#makefile"><span class="toc-text">makefile</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%BC%95%E5%85%A5make%E8%BF%99%E4%B8%AA%E5%B7%A5%E5%85%B7"><span class="toc-text">ä¸ºä»€ä¹ˆè¦å¼•å…¥makeè¿™ä¸ªå·¥å…·</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#makefile%E7%9A%84%E4%BD%BF%E7%94%A8%E4%B8%8E%E7%BB%86%E8%8A%82"><span class="toc-text">makefileçš„ä½¿ç”¨ä¸ç»†èŠ‚</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#main%E5%87%BD%E6%95%B0%E7%9A%84%E5%8F%82%E6%95%B0"><span class="toc-text">mainå‡½æ•°çš„å‚æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#argc"><span class="toc-text">argc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#argv"><span class="toc-text">argv</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#envp"><span class="toc-text">envp</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gdb%E8%B0%83%E8%AF%95%E7%A8%8B%E5%BA%8F"><span class="toc-text">gdbè°ƒè¯•ç¨‹åº</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gdb%E7%9A%84%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-text">gdbçš„å¸¸ç”¨å‘½ä»¤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8gdb%E8%B0%83%E8%AF%95core%E6%96%87%E4%BB%B6"><span class="toc-text">ç”¨gdbè°ƒè¯•coreæ–‡ä»¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8gdb%E8%B0%83%E8%AF%95%E4%B8%80%E4%B8%AA%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E7%A8%8B%E5%BA%8F"><span class="toc-text">ç”¨gdbè°ƒè¯•ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ç¨‹åº</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux%E7%9A%84%E6%97%B6%E9%97%B4%E6%93%8D%E4%BD%9C"><span class="toc-text">linuxçš„æ—¶é—´æ“ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#time-t-%E5%88%AB%E5%90%8D"><span class="toc-text">time_t åˆ«å</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#time-%E5%BA%93%E5%87%BD%E6%95%B0"><span class="toc-text">time()åº“å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tm%E7%BB%93%E6%9E%84%E4%BD%93-timeval"><span class="toc-text">tmç»“æ„ä½“(timeval)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#localtime-%E5%BA%93%E5%87%BD%E6%95%B0"><span class="toc-text">localtime()åº“å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mktime-%E5%87%BD%E6%95%B0"><span class="toc-text">mktime()å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gettimeofday-%E5%87%BD%E6%95%B0"><span class="toc-text">gettimeofday()å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%9D%A1%E7%9C%A0"><span class="toc-text">ç¨‹åºçš„ç¡çœ </span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux-%E8%8E%B7%E5%8F%96%E7%9B%AE%E5%BD%95%E6%93%8D%E4%BD%9C"><span class="toc-text">linux è·å–ç›®å½•æ“ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%A0%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E7%9B%AE%E5%BD%95%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0"><span class="toc-text">å‡ ä¸ªç®€å•çš„ç›®å½•æ“ä½œå‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95"><span class="toc-text">è·å–å½“å‰å·¥ä½œç›®å½•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%87%E6%8D%A2%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95"><span class="toc-text">åˆ‡æ¢å·¥ä½œç›®å½•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95"><span class="toc-text">åˆ›å»ºç›®å½•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%9B%AE%E5%BD%95"><span class="toc-text">åˆ é™¤ç›®å½•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%9B%AE%E5%BD%95%E4%B8%AD%E6%96%87%E4%BB%B6%E7%9A%84%E5%88%97%E8%A1%A8"><span class="toc-text">è·å–ç›®å½•ä¸­æ–‡ä»¶çš„åˆ—è¡¨</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8C%85%E5%90%AB%E5%A4%B4%E6%96%87%E4%BB%B6"><span class="toc-text">åŒ…å«å¤´æ–‡ä»¶</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E7%9A%84%E5%BA%93%E5%87%BD%E6%95%B0"><span class="toc-text">ç›¸å…³çš„åº“å‡½æ•°</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux-%E7%9A%84%E7%B3%BB%E7%BB%9F%E9%94%99%E8%AF%AF"><span class="toc-text">linux çš„ç³»ç»Ÿé”™è¯¯</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sterror-%E5%BA%93%E5%87%BD%E6%95%B0"><span class="toc-text">sterror()åº“å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#perror-%E5%BA%93%E5%87%BD%E6%95%B0"><span class="toc-text">perror()åº“å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">æ³¨æ„äº‹é¡¹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E5%92%8C%E6%96%87%E4%BB%B6%E7%9A%84%E6%9B%B4%E5%A4%9A%E6%93%8D%E4%BD%9C"><span class="toc-text">ç›®å½•å’Œæ–‡ä»¶çš„æ›´å¤šæ“ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#access-%E5%BA%93%E5%87%BD%E6%95%B0"><span class="toc-text">access()åº“å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#stat%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-text">statç»“æ„ä½“</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#stat-%E5%BA%93%E5%87%BD%E6%95%B0"><span class="toc-text">stat()åº“å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#utime-%E5%BA%93%E5%87%BD%E6%95%B0"><span class="toc-text">utime()åº“å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rename-%E5%BA%93%E5%87%BD%E6%95%B0"><span class="toc-text">rename()åº“å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#remove-%E5%BA%93%E5%87%BD%E6%95%B0"><span class="toc-text">remove()åº“å‡½æ•°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux%E7%9A%84%E4%BF%A1%E5%8F%B7"><span class="toc-text">Linuxçš„ä¿¡å·</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">ä¿¡å·çš„åŸºæœ¬æ¦‚å¿µ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#kill-%E4%B8%8E-killall-%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">kill ä¸ killall çš„åŒºåˆ«</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-text">ä¿¡å·çš„ç±»å‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E7%9A%84%E5%A4%84%E7%90%86"><span class="toc-text">ä¿¡å·çš„å¤„ç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E6%9C%89%E4%BB%80%E4%B9%88%E7%94%A8"><span class="toc-text">ä¿¡å·æœ‰ä»€ä¹ˆç”¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E4%BF%A1%E5%8F%B7"><span class="toc-text">å‘é€ä¿¡å·</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%BB%88%E6%AD%A2"><span class="toc-text">è¿›ç¨‹ç»ˆæ­¢</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%BB%88%E6%AD%A2%E6%96%B9%E5%BC%8F"><span class="toc-text">è¿›ç¨‹ç»ˆæ­¢æ–¹å¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%BB%88%E6%AD%A2%E7%8A%B6%E6%80%81"><span class="toc-text">è¿›ç¨‹ç»ˆæ­¢çŠ¶æ€</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E9%87%8A%E6%94%BE%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">èµ„æºé‡Šæ”¾çš„é—®é¢˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E7%BB%88%E6%AD%A2%E5%87%BD%E6%95%B0"><span class="toc-text">è¿›ç¨‹çš„ç»ˆæ­¢å‡½æ•°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F"><span class="toc-text">è°ƒç”¨å¯æ‰§è¡Œç¨‹åº</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#system-%E5%BA%93%E5%87%BD%E6%95%B0"><span class="toc-text">system()åº“å‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD"><span class="toc-text">åŠŸèƒ½</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-text">è¿”å›å€¼</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exec%E5%87%BD%E6%95%B0%E6%97%8F"><span class="toc-text">execå‡½æ•°æ—</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#execl-%E5%87%BD%E6%95%B0"><span class="toc-text">execl()å‡½æ•°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#execv-%E5%87%BD%E6%95%B0"><span class="toc-text">execv()å‡½æ•°</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%BF%9B%E7%A8%8B"><span class="toc-text">åˆ›å»ºè¿›ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux%E7%9A%840%EF%BC%8C1%EF%BC%8C2%E5%8F%B7%E8%BF%9B%E7%A8%8B"><span class="toc-text">Linuxçš„0ï¼Œ1ï¼Œ2å·è¿›ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E6%A0%87%E8%AF%86"><span class="toc-text">è¿›ç¨‹æ ‡è¯†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fork-%E5%87%BD%E6%95%B0"><span class="toc-text">fork()å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fork-%E7%9A%84%E4%B8%A4%E7%A7%8D%E7%94%A8%E6%B3%95"><span class="toc-text">fork()çš„ä¸¤ç§ç”¨æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E6%96%87%E4%BB%B6"><span class="toc-text">å…±äº«æ–‡ä»¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vfork"><span class="toc-text">vfork()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%83%B5%E5%B0%B8%E8%BF%9B%E7%A8%8B"><span class="toc-text">åƒµå°¸è¿›ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%83%B5%E5%B0%B8%E8%BF%9B%E7%A8%8B%E7%9A%84%E4%BA%A7%E7%94%9F"><span class="toc-text">åƒµå°¸è¿›ç¨‹çš„äº§ç”Ÿ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%83%B5%E5%B0%B8%E8%BF%9B%E7%A8%8B%E5%9C%B0%E9%81%BF%E5%85%8D"><span class="toc-text">åƒµå°¸è¿›ç¨‹åœ°é¿å…</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E4%B8%8E%E4%BF%A1%E5%8F%B7"><span class="toc-text">å¤šè¿›ç¨‹ä¸ä¿¡å·</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98"><span class="toc-text">å…±äº«å†…å­˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#shmget-%E5%87%BD%E6%95%B0"><span class="toc-text">shmget()å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shmat-%E5%87%BD%E6%95%B0"><span class="toc-text">shmat()å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shmdt-%E5%87%BD%E6%95%B0"><span class="toc-text">shmdt()å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shmctl-%E5%87%BD%E6%95%B0"><span class="toc-text">shmctl()å‡½æ•°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AF%E9%98%9F%E5%88%97"><span class="toc-text">å¾ªç¯é˜Ÿåˆ—</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-text">åŸç†</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="toc-text">ä¿¡å·é‡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pthread-%E7%BA%BF%E7%A8%8B%E5%BA%93"><span class="toc-text">pthread çº¿ç¨‹åº“</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86"><span class="toc-text">ç¬¬äºŒéƒ¨åˆ†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AA%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E7%A8%8B%E5%BA%8F%E6%88%B7%E7%AB%AF"><span class="toc-text">ç¬¬ä¸€ä¸ªç½‘ç»œé€šä¿¡ç¨‹åºæˆ·ç«¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Elinux%E7%9A%84%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="toc-text">åŸºäºlinuxçš„æ–‡ä»¶æ“ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E7%9A%84%E5%88%86%E9%85%8D%E8%A7%84%E5%88%99"><span class="toc-text">æ–‡ä»¶æè¿°ç¬¦çš„åˆ†é…è§„åˆ™</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#socket%E5%87%BD%E6%95%B0%E8%AF%A6%E8%A7%A3"><span class="toc-text">socketå‡½æ•°è¯¦è§£</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAsocket"><span class="toc-text">åˆ›å»ºsocket</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E7%9A%84%E5%A3%B0%E6%98%8E"><span class="toc-text">å‡½æ•°çš„å£°æ˜</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#type-%E8%A1%A8%E7%A4%BA%E6%95%B0%E6%8D%AE%E7%9A%84%E4%BC%A0%E8%BE%93%E7%B1%BB%E5%9E%8B"><span class="toc-text">type è¡¨ç¤ºæ•°æ®çš„ä¼ è¾“ç±»å‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#protocol%E5%8D%8F%E8%AE%AE"><span class="toc-text">protocolåè®®</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%A4%E7%A7%8D%E5%88%9B%E5%BB%BA%E6%96%B9%E5%BC%8F"><span class="toc-text">ä¸¤ç§åˆ›å»ºæ–¹å¼</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E6%9C%BA%E5%AD%97%E8%8A%82%E5%BA%8F%E5%92%8C%E7%BD%91%E7%BB%9C%E5%AD%97%E8%8A%82%E5%BA%8F"><span class="toc-text">ä¸»æœºå­—èŠ‚åºå’Œç½‘ç»œå­—èŠ‚åº</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%A7%E7%AB%AF%E5%BA%8F%E5%92%8C%E5%B0%8F%E7%AB%AF%E5%BA%8F"><span class="toc-text">å¤§ç«¯åºå’Œå°ç«¯åº</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%AD%97%E8%8A%82%E5%BA%8F"><span class="toc-text">ç½‘ç»œå­—èŠ‚åº</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#IP%E5%9C%B0%E5%9D%80%E5%92%8C%E9%80%9A%E8%AE%AF%E7%AB%AF%E5%8F%A3"><span class="toc-text">IPåœ°å€å’Œé€šè®¯ç«¯å£</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E5%A4%A7%E5%B0%8F%E7%AB%AF%E5%BA%8F"><span class="toc-text">å¦‚ä½•å¤„ç†å¤§å°ç«¯åº</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%87%E6%81%B6%E7%9A%84%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-text">ä¸‡æ¶çš„ç»“æ„ä½“</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#sockaddr%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-text">sockaddrç»“æ„ä½“</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#sockaddr-in%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-text">sockaddr_inç»“æ„ä½“</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BB%86%E8%AF%B4%E6%AD%A4%E7%BB%93%E6%9E%84%E4%BD%93%E5%86%85%E9%83%A8%E7%9A%84%E7%BB%86%E8%8A%82"><span class="toc-text">ç»†è¯´æ­¤ç»“æ„ä½“å†…éƒ¨çš„ç»†èŠ‚</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8gethostbyname-%E5%87%BD%E6%95%B0"><span class="toc-text">ä½¿ç”¨gethostbyname()å‡½æ•°</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2IP%E4%B8%8E%E5%A4%A7%E7%AB%AF%E5%BA%8FIP%E7%9A%84%E8%BD%AC%E6%8D%A2"><span class="toc-text">å­—ç¬¦ä¸²IPä¸å¤§ç«¯åºIPçš„è½¬æ¢</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AA%E5%B0%81%E8%A3%85%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-text">æœªå°è£…çš„å®¢æˆ·ç«¯ä»£ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AA%E5%B0%81%E8%A3%85%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-text">æœªå°è£…çš„æœåŠ¡ç«¯ä»£ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%81%E8%A3%85%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-text">å°è£…çš„å®¢æˆ·ç«¯ä»£ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%81%E8%A3%85socket%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-text">å°è£…socketçš„æœåŠ¡ç«¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-text">å¤šè¿›ç¨‹çš„æœåŠ¡ç«¯ä»£ç </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#void-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-text">void * æ˜¯ä»€ä¹ˆï¼Ÿ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93"><span class="toc-text">æ–‡ä»¶ä¼ è¾“</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-text">æœåŠ¡ç«¯ä»£ç </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-text">å®¢æˆ·ç«¯ä»£ç </span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%EF%BC%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B"><span class="toc-text">ä¸‰æ¬¡æ¡æ‰‹ï¼Œå››æ¬¡æŒ¥æ‰‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B"><span class="toc-text">ä¸‰æ¬¡æ¡æ‰‹</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%86%E8%8A%82"><span class="toc-text">ç»†èŠ‚</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B"><span class="toc-text">å››æ¬¡æŒ¥æ‰‹</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%86%E8%8A%82-2"><span class="toc-text">ç»†èŠ‚</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E4%B8%8A%E8%BF%B0%E9%97%AE%E9%A2%98%E5%8A%9E%E6%B3%95"><span class="toc-text">è§£å†³ä¸Šè¿°é—®é¢˜åŠæ³•</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP%E7%BC%93%E5%AD%98"><span class="toc-text">TCPç¼“å­˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E5%A4%A7%E5%B0%8F"><span class="toc-text">æŸ¥çœ‹ç¼“å†²åŒºçš„å¤§å°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nagle-%E7%AE%97%E6%B3%95"><span class="toc-text">Nagle ç®—æ³•</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8-select%E6%A8%A1%E5%9E%8B"><span class="toc-text">IOå¤šè·¯å¤ç”¨ -selectæ¨¡å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFIO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8"><span class="toc-text">ä»€ä¹ˆæ˜¯IOå¤šè·¯å¤ç”¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E9%80%9A%E8%AE%AF-%E8%AF%BB%E4%BA%8B%E4%BB%B6"><span class="toc-text">ç½‘ç»œé€šè®¯-è¯»äº‹ä»¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E9%80%9A%E8%AE%AF-%E5%86%99%E4%BA%8B%E4%BB%B6"><span class="toc-text">ç½‘ç»œé€šè®¯-å†™äº‹ä»¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#select-%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-text">select çš„åŸç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#select-%E5%87%BD%E6%95%B0%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">select å‡½æ•°çš„ä½¿ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#select%E5%87%BD%E6%95%B0%E7%9A%84%E5%A3%B0%E6%98%8E"><span class="toc-text">selectå‡½æ•°çš„å£°æ˜</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#fd-set%E7%9A%84%E6%9C%AC%E8%B4%A8%E5%A6%82%E5%9B%BE%E6%89%80%E7%A4%BA"><span class="toc-text">fd_setçš„æœ¬è´¨å¦‚å›¾æ‰€ç¤º</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#selec%E6%9C%8D%E5%8A%A1%E5%90%A8%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-text">selecæœåŠ¡å¨ç«¯ä»£ç </span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#select%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%BB%86%E8%8A%82"><span class="toc-text">selectæ¨¡å‹çš„ç»†èŠ‚</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#select%E6%A8%A1%E5%9E%8B-%E5%86%99%E4%BA%8B%E4%BB%B6"><span class="toc-text">selectæ¨¡å‹-å†™äº‹ä»¶</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#select-%E6%A8%A1%E5%9E%8B-%E6%B0%B4%E5%B9%B3%E8%A7%A6%E5%8F%91"><span class="toc-text">select æ¨¡å‹ æ°´å¹³è§¦å‘</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#select-%E6%A8%A1%E5%9E%8B%E6%80%A7%E8%83%BD"><span class="toc-text">select æ¨¡å‹æ€§èƒ½</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">å­˜åœ¨çš„é—®é¢˜</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POLL%E6%A8%A1%E5%9E%8B"><span class="toc-text">POLLæ¨¡å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pollfd-%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-text">pollfd ç»“æ„ä½“</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#poll%E5%8F%AF%E8%A6%81%E6%B1%82socket%E6%95%B0"><span class="toc-text">pollå¯è¦æ±‚socketæ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pollfd%E7%BB%93%E6%9E%84%E4%BD%93%E6%95%B0%E7%BB%84%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E7%BB%86%E8%8A%82"><span class="toc-text">pollfdç»“æ„ä½“æ•°ç»„åˆå§‹åŒ–çš„ç»†èŠ‚</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#poll%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%B8%B8%E7%94%A8"><span class="toc-text">pollçš„äº‹ä»¶å¸¸ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%BB%E4%BA%8B%E4%BB%B6%EF%BC%9APOLLIN%EF%BC%8C-%E5%86%99%E4%BA%8B%E4%BB%B6%EF%BC%9APOLLOUT"><span class="toc-text">è¯»äº‹ä»¶ï¼šPOLLINï¼Œ å†™äº‹ä»¶ï¼šPOLLOUT</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pollfd%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95%E6%9C%89%E4%B8%A4%E7%A7%8D"><span class="toc-text">pollfdç»“æ„ä½“çš„ä½¿ç”¨æ–¹æ³•æœ‰ä¸¤ç§</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A1%AB%E5%9C%A8%E4%B8%8E%E8%AF%B7%E6%B1%82%E7%9A%84socket%E7%AC%A6%E5%8F%B7%E7%BC%96%E7%A0%81%E4%B8%80%E6%A0%B7%E7%9A%84%E4%BD%8D%E7%BD%AE"><span class="toc-text">å¡«åœ¨ä¸è¯·æ±‚çš„socketç¬¦å·ç¼–ç ä¸€æ ·çš„ä½ç½®</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A1%AB%E5%9C%A8%E7%BB%93%E6%9E%84%E4%BD%93%E6%95%B0%E7%BB%84%E6%9C%80%E5%89%8D%E9%9D%A2"><span class="toc-text">å¡«åœ¨ç»“æ„ä½“æ•°ç»„æœ€å‰é¢</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%A4%E8%80%85%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">ä¸¤è€…çš„åŒºåˆ«</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#poll%E6%A8%A1%E5%9E%8B%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">pollæ¨¡å‹å­˜åœ¨çš„é—®é¢˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#poll%E7%9B%B8%E5%AF%B9%E4%BA%8Eselect%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">pollç›¸å¯¹äºselectçš„åŒºåˆ«</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#epoll%E6%A8%A1%E5%9E%8B"><span class="toc-text">epollæ¨¡å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#epoll-create-%E5%87%BD%E6%95%B0"><span class="toc-text">epoll_create()å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#epoll-ctl-%E5%87%BD%E6%95%B0"><span class="toc-text">epoll_ctl()å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#epoll-wait%E5%87%BD%E6%95%B0"><span class="toc-text">epoll_waitå‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#epoll%E7%9A%84%E7%9B%B8%E5%85%B3%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-text">epollçš„ç›¸å…³ç»“æ„ä½“</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#epoll-event"><span class="toc-text">epoll_event</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#epoll%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-text">epollæœåŠ¡ç«¯ä»£ç </span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%BB%E5%A1%9EI-O-%E4%B8%8E-%E9%9D%9E%E9%98%BB%E5%A1%9EI-O"><span class="toc-text">é˜»å¡I&#x2F;O ä¸ éé˜»å¡I&#x2F;O</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%BB%E5%A1%9E%E4%B8%8E%E9%9D%9E%E9%98%BB%E5%A1%9EIO%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">é˜»å¡ä¸éé˜»å¡IOçš„åº”ç”¨åœºæ™¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E9%98%BB%E5%A1%9EIO-connect-%E5%87%BD%E6%95%B0"><span class="toc-text">éé˜»å¡IO-connect()å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E9%98%BB%E5%A1%9EIO-accept-%E5%87%BD%E6%95%B0"><span class="toc-text">éé˜»å¡IO accept()å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E9%98%BB%E5%A1%9EIO-recv"><span class="toc-text">éé˜»å¡IO recv</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E9%98%BB%E5%A1%9EIO-send"><span class="toc-text">éé˜»å¡IO send()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B0%B4%E5%B9%B3%E8%A7%A6%E5%8F%91%E4%B8%8E%E8%BE%B9%E7%BC%98%E8%A7%A6%E5%8F%91"><span class="toc-text">æ°´å¹³è§¦å‘ä¸è¾¹ç¼˜è§¦å‘</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B0%B4%E5%B9%B3%E8%A7%A6%E5%8F%91%E5%90%AB%E4%B9%89"><span class="toc-text">æ°´å¹³è§¦å‘å«ä¹‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%B9%E7%BC%98%E8%A7%A6%E5%8F%91%E7%9A%84%E5%90%AB%E4%B9%89"><span class="toc-text">è¾¹ç¼˜è§¦å‘çš„å«ä¹‰</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">æ ¼è¨€ğŸ§¬</p><div class="bg-ad"><div>å†çœ‹çœ‹é‚£ä¸ªå…‰ç‚¹ï¼Œå®ƒå°±åœ¨è¿™é‡Œï¼Œè¿™æ˜¯å®¶å›­ï¼Œè¿™æ˜¯æˆ‘ä»¬ â€”â€” ä½ æ‰€çˆ±çš„æ¯ä¸€ä¸ªäººï¼Œä½ è®¤è¯†çš„ä¸€ä¸ªäººï¼Œä½ å¬è¯´è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œæ›¾ç»æœ‰è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œéƒ½åœ¨å®ƒä¸Šé¢åº¦è¿‡ä»–ä»¬çš„ä¸€ç”Ÿâœ¨</div><div class="btn-xz-box"><a class="btn-xz" target="_blank" rel="noopener" href="https://stellarium.org/">ç‚¹å‡»å¼€å¯æ˜Ÿè¾°ä¹‹æ—…</a></div></div></div><div class="t-t-r"><p class="ft-t t-l-t">çŒœä½ æƒ³çœ‹ğŸ’¡</p><ul class="ft-links"><li><a href="/posts/eec9786.html">é­”æ”¹æŒ‡å—</a><a href="/box/nav/">ç½‘å€å¯¼èˆª</a></li><li><a href="/social/link/">æˆ‘çš„æœ‹å‹</a><a href="/comments/">ç•™ç‚¹ä»€ä¹ˆ</a></li><li><a href="/personal/about/">å…³äºä½œè€…</a><a href="/archives/">æ–‡ç« å½’æ¡£</a></li><li><a href="/categories/">æ–‡ç« åˆ†ç±»</a><a href="/tags/">æ–‡ç« æ ‡ç­¾</a></li><li><a href="/box/Gallery/">æˆ‘çš„ç”»å»Š</a><a href="/personal/bb/">æˆ‘çš„å” å¨</a></li><li><a href="/site/time/">å»ºè®¾è¿›ç¨‹</a><a href="/site/census/">ç½‘ç«™ç»Ÿè®¡</a></li></ul></div></div></div><div class="ft-item-2"><p class="ft-t">æ¨èå‹é“¾âŒ›</p><div class="ft-img-group"><div class="img-group-item"><a target="_blank" rel="noopener" href="https://www.fomal.cc/" title="FomalhautğŸ¥"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/60e5d4e39da7c077.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div></div></div></div><div class="copyright"><span><b>&copy;2022-2024</b></span><span><b>&nbsp;&nbsp;By PigCanStudy</b></span></div><div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="åšå®¢æ¡†æ¶ä¸ºHexo_v6.3.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Frame-Hexo-blue.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="ä¸»é¢˜ç‰ˆæœ¬Butterfly_v4.3.1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Theme-Butterfly-6513df.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" title="æœ¬ç«™é‡‡ç”¨å¤šçº¿éƒ¨ç½²ï¼Œä¸»çº¿è·¯æ‰˜ç®¡äºVercel"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Hosted-Vercel-brightgreen.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://user.51.la/" style="margin-inline:5px" title="æœ¬ç«™æ•°æ®åˆ†æå¾—ç›Šäº51laæŠ€æœ¯æ”¯æŒ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Analytics-51la-3db1eb.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20226665" style="margin-inline:5px" title="æœ¬ç«™å·²åŠ å…¥èŒICPè±ªåå¥—é¤ï¼ŒèŒICPå¤‡20226665å·"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/èŒICPå¤‡-20226665-fe1384.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://bitiful.dogecast.com/buckets" style="margin-inline:5px" title="æœ¬ç½‘ç«™ç»Service Workeråˆ†æµè‡³ç¼¤çº·äº‘å¯¹è±¡å­˜å‚¨"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=" https://sourcebucket.s3.ladydaily.com/badge/Bucket-ç¼¤çº·äº‘-9c62da.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://www.netdun.net/" style="margin-inline:5px" title="æœ¬ç«™ä½¿ç”¨ç½‘ç›¾æ˜Ÿçƒæä¾›CDNåŠ é€Ÿä¸é˜²æŠ¤"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/CDN-ç½‘ç›¾æ˜Ÿçƒ-fff2cc.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="æœ¬ç½‘ç«™æºç ç”±Githubæä¾›å­˜å‚¨ä»“åº“"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=" https://sourcebucket.s3.ladydaily.com/badge/Source-Github-d021d6.svg" alt=""/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="å³é”®æ¨¡å¼" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog right_side"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button class="share" type="button" title="åˆ†äº«é“¾æ¥" onclick="share()"><i class="fas fa-share-nodes"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="ç›´è¾¾åº•éƒ¨" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>å¤åˆ¶</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>ç™¾åº¦æœç´¢</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>ç²˜è´´</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>ç©ºé™è¯„è®º</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>å¤åˆ¶æœ¬æ–‡åœ°å€</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>ä¿å­˜å›¾ç‰‡</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>åœ¨æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶å›¾ç‰‡é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>éšä¾¿é€›é€›</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>æ˜¼å¤œåˆ‡æ¢</span></a><a class="rightMenu-item" href="/personal/about/"><i class="fa fa-info-circle"></i><span>å…³äºåšå®¢</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>ç¾åŒ–è®¾ç½®</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>åˆ‡æ¢å…¨å±</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>æ‰“å°é¡µé¢</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: '',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: '',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script async src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script async src="//at.alicdn.com/t/c/font_3586335_hsivh70x0fm.js"></script><script async src="//at.alicdn.com/t/c/font_3636804_gr02jmjr3y9.js"></script><script async src="//at.alicdn.com/t/c/font_3612150_kfv55xn3u2g.js"></script><script async src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><canvas id="universe"></canvas><canvas id="snow"></canvas><script defer src="/js/fomal.js"></script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax","#bibi","body > title","#app","#tag-echarts","#posts-echart","#categories-echarts"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://pigcanstudy.github.io/categories/æ¼”ç¤º/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¥ å°Fã®æ¡ˆä¾‹æ¼”ç¤ºç¬”è®° (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item" style="visibility: hidden"></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="https://pigcanstudy.github.io/categories/" style="flex:1;text-align: center;margin-bottom: 10px;">æŸ¥çœ‹æ›´å¤š...</a></div></div>';
    console.log('å·²æŒ‚è½½magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(33.333333333333336% - 5px);background: #e9e9e9;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: var(--text-bg-hover)}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/95787e92.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_14.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-07-16</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/95787e92.html&quot;);" href="javascript:void(0);" alt="">ç½‘ç»œç¼–ç¨‹æ•™ç¨‹</a><div class="blog-slider__text">ğŸ¥§æœ¬æ–‡ä»‹ç»äº†linuxåŸºç¡€çš„ç³»ç»Ÿç¼–ç¨‹å’ŒåŸºç¡€çš„Linuxç½‘ç»œç¼–ç¨‹</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/95787e92.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_14.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-08-09</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">Markdownè¯­æ³•ä¸å¤–æŒ‚æ ‡ç­¾å†™æ³•æ±‡æ€»</a><div class="blog-slider__text">ğŸ¥§æœ¬æ–‡æ±‡æ€»Markdownæ ¼å¼ä»¥åŠå¤–æŒ‚æ ‡ç­¾åœ¨ç½‘é¡µç«¯çš„æ¸²æŸ“æ•ˆæœï¼Œå¯ä½œä¸ºæ–‡æ¡£è¿›è¡ŒæŸ¥è¯¢</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 320px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('å·²æŒ‚è½½gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/site/census/'|| '/site/census/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("/api?null",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'null')
    }
  </script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --></body></html>